# èœé¸Ÿç”µå­é¢å•å¯¹æ¥å®ç°è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®åŸºäºèœé¸Ÿç‰©æµäº‘å¹³å°å®ç°äº†ç”µå­é¢å•çš„å®Œæ•´å¯¹æ¥åŠŸèƒ½ï¼Œæ”¯æŒå¤šå®¶å¿«é€’å…¬å¸çš„ç”µå­é¢å•æ‰“å°ã€æŸ¥è¯¢ã€ç®¡ç†ç­‰åŠŸèƒ½ã€‚

**å¯¹æ¥å¹³å°**: èœé¸Ÿç‰©æµäº‘ (Cainiao Logistics Cloud)  
**å®ç°æ–¹å¼**: Java SDK + RESTful API  
**æ”¯æŒå¿«é€’**: é¡ºä¸°ã€ç”³é€šã€ä¸­é€šã€åœ†é€šã€éŸµè¾¾ã€EMSç­‰ä¸»æµå¿«é€’å…¬å¸

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
pas-service/thirdservice/
â”œâ”€â”€ CNExpressPrintService.java    # æ ¸å¿ƒæœåŠ¡ç±»
â”œâ”€â”€ KdApiEOrderController.java    # Webæ§åˆ¶å™¨
â”œâ”€â”€ CainiaoTemplate.java          # æ¨¡æ¿å®ä½“ç±»
â””â”€â”€ ç›¸å…³å·¥å…·ç±»å’Œæµ‹è¯•ç±»
```

### æ•°æ®æµå‘

```mermaid
graph LR
    A[å‰ç«¯HTMLç•Œé¢] --> B[Controller]
    B --> C[Serviceå±‚]
    C --> D[èœé¸ŸAPI]
    D --> E[è¿”å›ç”µå­é¢å•æ•°æ®]
    E --> F[å‰ç«¯æ¸²æŸ“æ‰“å°]
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°ç±»è¯¦è§£

### 1. CNExpressPrintService (æ ¸å¿ƒæœåŠ¡ç±»)

**æ–‡ä»¶è·¯å¾„**: `pas-service/src/main/java/com/xc/smallrookie/pas/service/thirdservice/CNExpressPrintService.java`

#### ä¸»è¦åŠŸèƒ½æ–¹æ³•

##### (1) æŸ¥è¯¢è´¦å·çŠ¶æ€å’Œè®¢è´­å…³ç³»
```java
public Map<String, Object> getCainiaoAccountStatus()
```
**åŠŸèƒ½**: æŸ¥è¯¢å•†å®¶åœ¨èœé¸Ÿå¹³å°çš„è´¦å·çŠ¶æ€å’Œå¿«é€’å…¬å¸è®¢è´­å…³ç³»

**è¾“å…¥å‚æ•°**: æ— 

**è¿”å›æ•°æ®ç»“æ„**:
```json
{
  "dailytoken": "æˆæƒä»¤ç‰Œ",
  "deadline": "æˆæƒæˆªæ­¢æ—¶é—´",
  "subscriptions": [
    {
      "cpCode": "å¿«é€’å…¬å¸ç¼–ç ",
      "branchAccountCols": [
        {
          "branchCode": "ç½‘ç‚¹ç¼–ç ",
          "branchName": "ç½‘ç‚¹åç§°",
          "quantity": 1000,
          "allocatedQuantity": 500
        }
      ]
    }
  ],
  "Success": "true"
}
```

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹**:
```javascript
// AJAXè°ƒç”¨
fetch('/checkCainiaoAccount', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({token: 'ç”¨æˆ·token'})
})
.then(response => response.json())
.then(data => {
  console.log('è´¦å·çŠ¶æ€:', data);
  // æ¸²æŸ“å¿«é€’å…¬å¸é€‰æ‹©åˆ—è¡¨
});
```

##### (2) è·å–ç”µå­é¢å•æ¨¡æ¿
```java
public Map<String, Object> getCainiaoTemplate(ApiRequest<CainiaoTemplate> apiRequest, Example example)
```
**åŠŸèƒ½**: ä»èœé¸Ÿå¹³å°åŒæ­¥å¹¶è·å–ç”µå­é¢å•æ¨¡æ¿

**è¾“å…¥å‚æ•°**:
- `apiRequest`: åŒ…å«ç”¨æˆ·è®¤è¯ä¿¡æ¯
- `example`: æŸ¥è¯¢æ¡ä»¶

**è¿”å›æ•°æ®ç»“æ„**:
```json
{
  "templates": [
    {
      "templateid": 88010101,
      "templatename": "èœé¸Ÿç”µå­é¢å•\\é¡ºä¸°001",
      "templateurl": "http://cloudprint.cainiao.com/template/standard/1501/68",
      "templatewaybilltype": 1
    }
  ],
  "Success": "true"
}
```

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹**:
```javascript
// è·å–æ¨¡æ¿åˆ—è¡¨
fetch('/getCainiaoTemplate', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    data: {employeeId: 123},
    token: 'user_token'
  })
})
.then(response => response.json())
.then(data => {
  // æ¸²æŸ“æ¨¡æ¿é€‰æ‹©ä¸‹æ‹‰æ¡†
  const templateSelect = document.getElementById('templateSelect');
  data.templates.forEach(template => {
    const option = document.createElement('option');
    option.value = template.templateid;
    option.textContent = template.templatename;
    templateSelect.appendChild(option);
  });
});
```

##### (3) æ‰¹é‡è·å–ç”µå­é¢å•
```java
public Map<String, Object> getWaybill(HashMap map)
```
**åŠŸèƒ½**: æ ¹æ®è®¢å•ä¿¡æ¯æ‰¹é‡è·å–å¿«é€’å•å·å’Œç”µå­é¢å•

**è¾“å…¥å‚æ•°Mapç»“æ„**:
```java
{
  "express_company": "SF",           // å¿«é€’å…¬å¸ç¼–ç 
  "templatename": "é¡ºä¸°001",         // æ¨¡æ¿åç§°
  "sender_name": "å‘ä»¶äººå§“å",
  "sender_phone": "å‘ä»¶äººç”µè¯",
  "sender_province": "å‘ä»¶çœ",
  "sender_city": "å‘ä»¶å¸‚",
  "sender_district": "å‘ä»¶åŒº",
  "sender_address": "å‘ä»¶è¯¦ç»†åœ°å€",
  "tradeOrderList": [                // è®¢å•åˆ—è¡¨
    {
      "order_no": "è®¢å•å·",
      "receiver_name": "æ”¶ä»¶äººå§“å",
      "receiver_phone": "æ”¶ä»¶äººç”µè¯",
      "receiver_province": "æ”¶ä»¶çœ",
      "receiver_city": "æ”¶ä»¶å¸‚",
      "receiver_district": "æ”¶ä»¶åŒº",
      "receiver_address": "æ”¶ä»¶è¯¦ç»†åœ°å€",
      "goods_name": "å•†å“åç§°",
      "goods_count": 1
    }
  ]
}
```

**è¿”å›æ•°æ®ç»“æ„**:
```json
{
  "waybills": [
    {
      "order_no": "è®¢å•å·",
      "waybill_code": "SF1234567890",  // å¿«é€’å•å·
      "print_data": "{...}",           // æ‰“å°æ•°æ®(JSONæ ¼å¼)
      "template_url": "æ¨¡æ¿URL"
    }
  ],
  "Success": "true"
}
```

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹**:
```javascript
// æ‰¹é‡è·å–é¢å•
const requestData = {
  express_company: 'SF',
  templatename: 'é¡ºä¸°001',
  sender_name: document.getElementById('senderName').value,
  sender_phone: document.getElementById('senderPhone').value,
  // ... å…¶ä»–å‘ä»¶äººä¿¡æ¯
  tradeOrderList: [
    {
      order_no: 'ORDER001',
      receiver_name: document.getElementById('receiverName').value,
      // ... æ”¶ä»¶äººä¿¡æ¯
    }
  ]
};

fetch('/getWaybill', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify(requestData)
})
.then(response => response.json())
.then(data => {
  if(data.Success === 'true') {
    // æ¸²æŸ“æ‰“å°é¢„è§ˆ
    renderPrintPreview(data.waybills);
  }
});
```

##### (4) MD5ç­¾åè·å–
```java
public Map<String, String> getMd5(ApiRequest<Object> apiRequest)
```
**åŠŸèƒ½**: è·å–èœé¸Ÿå¹³å°æ‰€éœ€çš„MD5ç­¾å

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹**:
```javascript
// è·å–ç­¾åç”¨äºAPIè°ƒç”¨
fetch('/getCainiaoMD5', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({token: 'user_token'})
})
.then(response => response.json())
.then(data => {
  const sign = data.sign;
  // ä½¿ç”¨ç­¾åè°ƒç”¨å…¶ä»–æ¥å£
});
```

---

## ğŸ“¡ æ§åˆ¶å™¨å®ç° (KdApiEOrderController)

**æ–‡ä»¶è·¯å¾„**: `pas-web/src/main/java/com/xc/smallrookie/web/pas/controller/KdApiEOrderController.java`

### ä¸»è¦æ¥å£

#### 1. æ£€æŸ¥èœé¸Ÿè´¦å·çŠ¶æ€
```java
@PostMapping("/checkCainiaoAccount")
public ApiResponse<Object> checkCainiaoAccount(@RequestBody ApiRequest<Object> apiRequest)
```
**HTTPæ–¹æ³•**: POST  
**è¯·æ±‚è·¯å¾„**: `/checkCainiaoAccount`  
**åŠŸèƒ½**: æ£€æŸ¥å•†å®¶åœ¨èœé¸Ÿå¹³å°çš„è´¦å·çŠ¶æ€

#### 2. è·å–ç”µå­é¢å•æ¨¡æ¿
```java
@PostMapping("/getCainiaoTemplate")
public ApiResponse<Map<String,Object>> getCainiaoTemplate(@RequestBody ApiRequest<CainiaoTemplate> apiRequest)
```
**HTTPæ–¹æ³•**: POST  
**è¯·æ±‚è·¯å¾„**: `/getCainiaoTemplate`  
**åŠŸèƒ½**: è·å–å¯ç”¨çš„ç”µå­é¢å•æ¨¡æ¿åˆ—è¡¨

#### 3. è·å–MD5ç­¾å
```java
@PostMapping("/getCainiaoMD5")
public ApiResponse<Object> getCainiaoMD5(@RequestBody ApiRequest<Object> apiRequest)
```
**HTTPæ–¹æ³•**: POST  
**è¯·æ±‚è·¯å¾„**: `/getCainiaoMD5`  
**åŠŸèƒ½**: è·å–APIè°ƒç”¨æ‰€éœ€çš„MD5ç­¾å

---

## ğŸ—ƒï¸ æ•°æ®åº“è®¾è®¡

### 1. èœé¸Ÿæ¨¡æ¿è¡¨ (t_cainiao_template)

```sql
CREATE TABLE `t_cainiao_template` (
  `templateid` int(11) NOT NULL COMMENT 'æ¨¡æ¿ID',
  `templatename` varchar(100) DEFAULT NULL COMMENT 'æ¨¡æ¿åç§°',
  `templateurl` varchar(500) DEFAULT NULL COMMENT 'æ¨¡æ¿URL',
  `templatewaybilltype` int(11) DEFAULT NULL COMMENT 'é¢å•ç±»å‹',
  `horoffset` float DEFAULT NULL COMMENT 'æ°´å¹³åç§»',
  `veroffset` float DEFAULT NULL COMMENT 'å‚ç›´åç§»',
  `publisheddatetime` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT 'å‘å¸ƒæ—¶é—´',
  `totalprintedcount` int(11) DEFAULT NULL COMMENT 'æ€»æ‰“å°æ¬¡æ•°',
  `lastprinteddatetime` timestamp DEFAULT '0000-00-00 00:00:00' COMMENT 'æœ€åæ‰“å°æ—¶é—´',
  `lastewbcontent` text COMMENT 'æœ€åç”µå­é¢å•å†…å®¹',
  `delflag` tinyint(1) NOT NULL DEFAULT '1' COMMENT 'åˆ é™¤æ ‡è®°',
  PRIMARY KEY (`templateid`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
```

**å…³é”®å­—æ®µè¯´æ˜**:
- `templatename`: æ¨¡æ¿æ˜¾ç¤ºåç§°(å¦‚"èœé¸Ÿç”µå­é¢å•\é¡ºä¸°001")
- `templateurl`: èœé¸Ÿå¹³å°æ¨¡æ¿URL
- `templatewaybilltype`: é¢å•ç±»å‹æ ‡è¯†

### 2. å¿«é€’å…¬å¸é…ç½®è¡¨ (t_bill_company)

åŒ…å«å„å¿«é€’å…¬å¸çš„åŸºç¡€ä¿¡æ¯å’Œç¼–ç å¯¹ç…§ã€‚

---

## ğŸ” é…ç½®ä¿¡æ¯

### èœé¸Ÿå¹³å°é…ç½®

**æ–‡ä»¶**: `CNExpressPrintService.java`

```java
// ç”Ÿäº§ç¯å¢ƒé…ç½®
private final static String onlineUrl = "http://link.cainiao.com/gateway/link.do";
private final static String onlineAppKey = "285203";  // åº”ç”¨Key
private final static String onlineSecretKey = "1q4Ml3Z00h4s3Qq96WEO39dpw9O18060";  // å¯†é’¥
private static String dailyToken = "TmpFU1ZO...";  // æˆæƒä»¤ç‰Œ
```

**æ³¨æ„äº‹é¡¹**:
1. ç”Ÿäº§ç¯å¢ƒéœ€æ›¿æ¢ä¸ºæ­£å¼çš„AppKeyå’ŒSecretKey
2. dailyTokenéœ€è¦å®šæœŸæ›´æ–°(é€šè¿‡MD5ç­¾åæ¥å£è·å–)
3. å»ºè®®å°†æ•æ„Ÿé…ç½®ä¿¡æ¯æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### 1. å®Œæ•´ä¸‹å•æµç¨‹

```mermaid
graph TB
    A[å‰ç«¯æäº¤è®¢å•ä¿¡æ¯] --> B[è°ƒç”¨/getWaybillæ¥å£]
    B --> C[ServiceéªŒè¯è´¦å·çŠ¶æ€]
    C --> D[æŸ¥è¯¢å•†å®¶è®¢è´­å…³ç³»]
    D --> E[åŒ¹é…å¿«é€’å…¬å¸æ¨¡æ¿]
    E --> F[è°ƒç”¨èœé¸ŸAPIè·å–é¢å•]
    F --> G[è¿”å›å¿«é€’å•å·å’Œæ‰“å°æ•°æ®]
    G --> H[å‰ç«¯æ¸²æŸ“æ‰“å°é¢„è§ˆ]
    H --> I[ç”¨æˆ·ç¡®è®¤æ‰“å°]
```

### 2. æ¨¡æ¿åŒæ­¥æµç¨‹

```mermaid
graph TB
    A[è°ƒç”¨/getCainiaoTemplate] --> B[Serviceè°ƒç”¨èœé¸ŸAPI]
    B --> C[è·å–æœ€æ–°æ¨¡æ¿åˆ—è¡¨]
    C --> D[å¯¹æ¯”æœ¬åœ°æ•°æ®åº“]
    D --> E[æ–°å¢/æ›´æ–°æ¨¡æ¿è®°å½•]
    E --> F[è¿”å›æ¨¡æ¿æ•°æ®ç»™å‰ç«¯]
```

---

## ğŸ“± å‰ç«¯åŠŸèƒ½å®ç°æŒ‡å—

### 1. å¿«é€’å…¬å¸é€‰æ‹©åŠŸèƒ½

```html
<!-- HTMLç»“æ„ -->
<select id="expressCompany">
  <option value="">è¯·é€‰æ‹©å¿«é€’å…¬å¸</option>
  <option value="SF">é¡ºä¸°å¿«é€’</option>
  <option value="STO">ç”³é€šå¿«é€’</option>
  <option value="ZTO">ä¸­é€šå¿«é€’</option>
  <option value="YTO">åœ†é€šå¿«é€’</option>
  <option value="YD">éŸµè¾¾å¿«é€’</option>
  <option value="EMS">é‚®æ”¿EMS</option>
</select>

<!-- JavaScriptå®ç° -->
document.getElementById('expressCompany').addEventListener('change', function() {
  const companyCode = this.value;
  if(companyCode) {
    // æ ¹æ®é€‰æ‹©çš„å¿«é€’å…¬å¸åŠ è½½å¯¹åº”æ¨¡æ¿
    loadTemplates(companyCode);
  }
});

function loadTemplates(companyCode) {
  fetch('/getCainiaoTemplate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      data: {companyCode: companyCode},
      token: getUserToken()
    })
  })
  .then(response => response.json())
  .then(data => {
    // æ¸²æŸ“æ¨¡æ¿é€‰æ‹©ä¸‹æ‹‰æ¡†
    renderTemplateOptions(data.templates);
  });
}
```

### 2. å‘ä»¶äººä¿¡æ¯å¡«å†™

```html
<form id="senderForm">
  <input type="text" id="senderName" placeholder="å‘ä»¶äººå§“å" required>
  <input type="tel" id="senderPhone" placeholder="å‘ä»¶äººç”µè¯" required>
  <select id="senderProvince"></select>
  <select id="senderCity"></select>
  <select id="senderDistrict"></select>
  <textarea id="senderAddress" placeholder="è¯¦ç»†åœ°å€" required></textarea>
</form>
```

### 3. æ‰¹é‡è®¢å•å¤„ç†

```javascript
// æ‰¹é‡æ·»åŠ è®¢å•
function addBatchOrders() {
  const orders = [];
  const orderRows = document.querySelectorAll('.order-row');
  
  orderRows.forEach(row => {
    orders.push({
      order_no: row.querySelector('.order-no').value,
      receiver_name: row.querySelector('.receiver-name').value,
      receiver_phone: row.querySelector('.receiver-phone').value,
      receiver_province: row.querySelector('.receiver-province').value,
      receiver_city: row.querySelector('.receiver-city').value,
      receiver_district: row.querySelector('.receiver-district').value,
      receiver_address: row.querySelector('.receiver-address').value,
      goods_name: row.querySelector('.goods-name').value,
      goods_count: parseInt(row.querySelector('.goods-count').value)
    });
  });
  
  return orders;
}

// æäº¤è·å–é¢å•
function submitWaybill() {
  const requestData = {
    express_company: document.getElementById('expressCompany').value,
    templatename: document.getElementById('templateSelect').value,
    sender_name: document.getElementById('senderName').value,
    sender_phone: document.getElementById('senderPhone').value,
    sender_province: document.getElementById('senderProvince').value,
    sender_city: document.getElementById('senderCity').value,
    sender_district: document.getElementById('senderDistrict').value,
    sender_address: document.getElementById('senderAddress').value,
    tradeOrderList: addBatchOrders()
  };
  
  fetch('/getWaybill', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(requestData)
  })
  .then(response => response.json())
  .then(data => {
    if(data.Success === 'true') {
      // æ˜¾ç¤ºæ‰“å°é¢„è§ˆ
      showPrintPreview(data.waybills);
    } else {
      alert('è·å–é¢å•å¤±è´¥: ' + data.errorMessage);
    }
  });
}
```

### 4. æ‰“å°é¢„è§ˆåŠŸèƒ½

```javascript
function showPrintPreview(waybills) {
  const previewContainer = document.getElementById('previewContainer');
  previewContainer.innerHTML = '';
  
  waybills.forEach((waybill, index) => {
    const printDiv = document.createElement('div');
    printDiv.className = 'print-preview';
    printDiv.innerHTML = `
      <h3>è®¢å•å·: ${waybill.order_no}</h3>
      <p>å¿«é€’å•å·: ${waybill.waybill_code}</p>
      <div class="print-content">${formatPrintData(waybill.print_data)}</div>
      <button onclick="printSingle(${index})">æ‰“å°æ­¤å•</button>
    `;
    previewContainer.appendChild(printDiv);
  });
}

function printSingle(index) {
  const printWindow = window.open('', '_blank');
  const waybill = waybills[index];
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head><title>ç”µå­é¢å•æ‰“å°</title></head>
    <body onload="window.print()">
      ${formatPrintData(waybill.print_data)}
    </body>
    </html>
  `);
  printWindow.document.close();
}
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æˆæƒä»¤ç‰Œç®¡ç†
- dailyTokenæœ‰æœ‰æ•ˆæœŸï¼Œéœ€å®šæœŸåˆ·æ–°
- å»ºè®®åœ¨æ¯æ¬¡APIè°ƒç”¨å‰æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§
- å¯é€šè¿‡å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åˆ·æ–°ä»¤ç‰Œ

### 2. é”™è¯¯å¤„ç†
```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
function handleApiError(error) {
  if(error.code === 'TOKEN_EXPIRED') {
    // ä»¤ç‰Œè¿‡æœŸï¼Œé‡æ–°è·å–
    refreshToken().then(() => {
      // é‡æ–°æ‰§è¡ŒåŸæ“ä½œ
      retryLastOperation();
    });
  } else if(error.code === 'NO_SUBSCRIPTION') {
    alert('è¯·å…ˆåœ¨èœé¸Ÿå¹³å°è®¢è´­ç›¸åº”å¿«é€’å…¬å¸çš„ç”µå­é¢å•æœåŠ¡');
  } else {
    alert('æ“ä½œå¤±è´¥: ' + error.message);
  }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- æ¨¡æ¿æ•°æ®å¯ç¼“å­˜åˆ°localStorage
- æ‰¹é‡è·å–é¢å•æ—¶å»ºè®®åˆ†æ‰¹å¤„ç†(æ¯æ‰¹50-100å•)
- æ‰“å°æ•°æ®è¾ƒå¤§çš„æƒ…å†µä¸‹ä½¿ç”¨å¼‚æ­¥åŠ è½½

### 4. å®‰å…¨è€ƒè™‘
- æ•æ„Ÿé…ç½®ä¿¡æ¯ä¸è¦ç¡¬ç¼–ç åœ¨å‰ç«¯
- APIè°ƒç”¨éœ€è¿›è¡Œèº«ä»½éªŒè¯
- æ‰“å°æ•°æ®ä¼ è¾“å»ºè®®ä½¿ç”¨HTTPS

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [èœé¸Ÿç‰©æµäº‘å®˜æ–¹æ–‡æ¡£](https://cloudprint-doc.caicloud.io/)
- [ç”µå­é¢å•APIæ–‡æ¡£](https://cloudprint-doc.caicloud.io/doc.htm)
- [å¿«é€’å…¬å¸ç¼–ç å¯¹ç…§è¡¨](https://cloudprint-doc.caicloud.io/companycode.htm)

---

## ğŸ“… æ–‡æ¡£ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2026-02-17
- **é€‚ç”¨ç‰ˆæœ¬**: smallrookie-pas v1.0
- **é‡æ„å»ºè®®**: å¯å°†æ ¸å¿ƒé€»è¾‘æŠ½å–ä¸ºç‹¬ç«‹SDKï¼Œä¾¿äºå¤šé¡¹ç›®å¤ç”¨



æˆ‘æ¥å¸®æ‚¨æŸ¥æ‰¾å¹¶æ•´ç†èœé¸Ÿæˆæƒç›¸å…³çš„è¯´æ˜ä¿¡æ¯ã€‚
æ ¹æ®ä»£ç åˆ†æ,æˆ‘ä¸ºæ‚¨æ•´ç†èœé¸Ÿæˆæƒçš„å®Œæ•´è¯´æ˜:

---

## ğŸ“˜ èœé¸Ÿç‰©æµäº‘æˆæƒè¯´æ˜æ–‡æ¡£

### ä¸€ã€æˆæƒæµç¨‹æ¦‚è¿°

èœé¸Ÿç‰©æµäº‘ä½¿ç”¨ **ISV(ç‹¬ç«‹è½¯ä»¶ä¾›åº”å•†)æˆæƒæ¨¡å¼**,éœ€è¦å•†å®¶åœ¨èœé¸Ÿå¹³å°æˆæƒå,é€šè¿‡accessCodeæ¢å–accessTokenæ‰èƒ½ä½¿ç”¨APIã€‚

```
å•†å®¶æˆæƒ â†’ è·å–accessCode â†’ æ¢å–accessToken â†’ ä½¿ç”¨API
```

---

### äºŒã€æˆæƒæ‰€éœ€ä¿¡æ¯

#### 1. ISVåº”ç”¨ä¿¡æ¯

**æµ‹è¯•ç¯å¢ƒ**:
```java
dailyAppKey = "247457"
dailySecretKey = "8e48991050U2cz1g2JA5kU61ve94Rt71"
dailyUrl = "http://link.cainiao.com/gateway/link.do"
```

**ç”Ÿäº§ç¯å¢ƒ**:
```java
onlineAppKey = "285203"
onlineSecretKey = "2fz6b9316tgD8iklyGk7g211PefQ331d"
onlineUrl = "http://link.cainiao.com/gateway/link.do"
```

#### 2. å•†å®¶æˆæƒç  (accessCode)

- å•†å®¶åœ¨èœé¸Ÿç‰©æµäº‘å¹³å°æˆæƒISVåº”ç”¨åç”Ÿæˆ
- ç”¨äºæ¢å–é•¿æœŸæœ‰æ•ˆçš„ accessToken
- **è·å–æ–¹å¼**: å•†å®¶ç™»å½•èœé¸Ÿå¹³å° â†’ åº”ç”¨æˆæƒ â†’ ç”Ÿæˆæˆæƒç 

---

### ä¸‰ã€Tokenè·å–æµç¨‹

#### æ­¥éª¤1: ä½¿ç”¨accessCodeæ¢å–accessToken

**APIæ¥å£**: `POST /getCainiaoMD5`

**è¯·æ±‚å‚æ•°**:
```json
{
  "ext": {
    "accessCode": "å•†å®¶æˆæƒç "
  }
}
```

**æ ¸å¿ƒå®ç°é€»è¾‘** ([MD5Utils.java](file:///d:/bjamoeba/smallrookie-pas/pas-service/src/main/java/com/xc/smallrookie/pas/service/thirdservice/MD5Utils.java#L189-L282)):

```java
// 1. è·å–ISVåº”ç”¨å‡­è¯
String appKey = cnExpressPrintService.getDailyAppKey();
String appSecret = cnExpressPrintService.getDailySecretKey();

// 2. ç”Ÿæˆç­¾å
String sign = md5(accessCode + "," + appKey + "," + appSecret);

// 3. è°ƒç”¨èœé¸ŸTokenæ¢å–æ¥å£
String url = "https://lcp.cloud.cainiao.com/api/permission/exchangeToken.do";
String params = "accessCode=" + accessCode + "&isvAppKey=" + appKey + "&sign=" + sign;

// 4. è§£æè¿”å›ç»“æœè·å–accessToken
JSONObject response = JSONObject.fromObject(httpResponse);
String accessToken = response.getJSONArray("accessTokens")
                              .getJSONObject(0)
                              .getString("accessToken");

// 5. ä¿å­˜åˆ°æ•°æ®åº“
CainiaoToken token = new CainiaoToken();
token.setDailytoken(accessToken);
token.setDeadline(nowDate + 1å¹´);
cainiaoTokenService.addEntity(token);
```

**è¿”å›ç»“æœ**:
```json
{
  "accessToken": "æ¢å–åˆ°çš„é•¿æœŸToken",
  "errorCode": "",
  "Success": "true"
}
```

#### æ­¥éª¤2: ä»æ•°æ®åº“è¯»å–Token

**æ–¹æ³•**: `setDailyToken()` ([CNExpressPrintService.java](file:///d:/bjamoeba/smallrookie-pas/pas-service/src/main/java/com/xc/smallrookie/pas/service/thirdservice/CNExpressPrintService.java#L125-L134))

```java
public void setDailyToken() {
    CainiaoToken cainiaoToken = cainiaoTokenService.getEntity(1);
    dailyToken = cainiaoToken.getDailytoken();
    deadlineDate = cainiaoToken.getDeadline();
}
```

#### æ­¥éª¤3: ä½¿ç”¨Tokenè°ƒç”¨API

æ‰€æœ‰èœé¸ŸAPIè°ƒç”¨éƒ½éœ€è¦ä¼ å…¥Token:

```java
PacClient client = new PacClient(dailyAppKey, dailySecretKey, dailyUrl);
SendSysParams params = new SendSysParams();
params.setFromCode(dailyToken);  // è®¾ç½®æˆæƒToken

// è°ƒç”¨å…·ä½“API
TmsWaybillGetRequest request = new TmsWaybillGetRequest();
TmsWaybillGetResponse response = client.send(request, params);
```

---

### å››ã€æ•°æ®åº“è®¾è®¡

#### t_cainiao_token è¡¨ç»“æ„

```sql
CREATE TABLE `t_cainiao_token` (
  `tokenid` int(11) NOT NULL,
  `dailytoken` varchar(500) DEFAULT NULL COMMENT 'æˆæƒToken',
  `deadline` datetime DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `delflag` tinyint(1) NOT NULL DEFAULT '1' COMMENT 'åˆ é™¤æ ‡è®°',
  PRIMARY KEY (`tokenid`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
```

**å­—æ®µè¯´æ˜**:
- `tokenid`: å›ºå®šä¸º1,å•ä¾‹æ¨¡å¼
- `dailytoken`: ä»èœé¸Ÿè·å–çš„é•¿æœŸæˆæƒToken
- `deadline`: Tokenè¿‡æœŸæ—¶é—´(é€šå¸¸è®¾ç½®ä¸º1å¹´å)
- `delflag`: åˆ é™¤æ ‡è®°

---

### äº”ã€å‰ç«¯å¯¹æ¥æŒ‡å—

#### æ¥å£1: è·å–MD5ç­¾åæ¢å–Token

**URL**: `POST /getCainiaoMD5`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
fetch('/getCainiaoMD5', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    ext: {
      accessCode: 'å•†å®¶æä¾›çš„æˆæƒç '
    }
  })
})
.then(response => response.json())
.then(data => {
  if(data.Success === 'true') {
    console.log('Tokenè·å–æˆåŠŸ:', data.accessToken);
    // ä¿å­˜Tokenä¾›åç»­ä½¿ç”¨
    localStorage.setItem('cainiaoToken', data.accessToken);
  }
});
```

#### æ¥å£2: æ£€æŸ¥è´¦å·çŠ¶æ€

**URL**: `POST /checkCainiaoAccount`

**åŠŸèƒ½**: æŸ¥è¯¢å½“å‰TokençŠ¶æ€å’Œå¿«é€’å…¬å¸è®¢è´­å…³ç³»

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
fetch('/checkCainiaoAccount', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({})
})
.then(response => response.json())
.then(data => {
  console.log('Token:', data.dailytoken);
  console.log('è¿‡æœŸæ—¶é—´:', data.deadline);
  console.log('è®¢è´­å…³ç³»:', data.subscriptions);
});
```

**è¿”å›æ•°æ®**:
```json
{
  "dailytoken": "å½“å‰ä½¿ç”¨çš„Token",
  "deadline": "2027-02-17T00:00:00",
  "subscriptions": [
    {
      "cpCode": "SF",
      "cpName": "é¡ºä¸°å¿«é€’",
      "branchAccountCols": [
        {
          "branchCode": "ç½‘ç‚¹ç¼–ç ",
          "quantity": 1000,
          "allocatedQuantity": 500
        }
      ]
    }
  ],
  "Success": "true"
}
```

#### æ¥å£3: æ‰‹åŠ¨æ›´æ–°Token

**URL**: `POST /updateDailyToken`

**åŠŸèƒ½**: æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“ä¸­çš„Token

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
fetch('/updateDailyToken', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    ext: {
      dailytoken: 'æ–°çš„Tokenå€¼'
    }
  })
})
.then(response => response.json());
```

---

### å…­ã€æˆæƒæµç¨‹å®Œæ•´ç¤ºä¾‹

#### åœºæ™¯: é¦–æ¬¡å¯¹æ¥èœé¸Ÿ

**æ­¥éª¤1: å•†å®¶æ“ä½œ**
1. ç™»å½•èœé¸Ÿç‰©æµäº‘å¹³å°: https://lcp.cloud.cainiao.com
2. è¿›å…¥"åº”ç”¨æˆæƒ"é¡µé¢
3. æ‰¾åˆ°ISVåº”ç”¨ (AppKey: 247457)
4. ç‚¹å‡»æˆæƒ,ç”Ÿæˆ accessCode (ç¤ºä¾‹: `ABC123XYZ456`)

**æ­¥éª¤2: ç³»ç»Ÿè·å–Token**
```javascript
// å‰ç«¯è°ƒç”¨
const accessCode = 'ABC123XYZ456'; // å•†å®¶æä¾›

fetch('/getCainiaoMD5', {
  method: 'POST',
  body: JSON.stringify({
    ext: { accessCode: accessCode }
  })
})
.then(response => response.json())
.then(data => {
  if(data.Success === 'true') {
    alert('æˆæƒæˆåŠŸ! Tokenå·²ä¿å­˜åˆ°æ•°æ®åº“');
    // Token: data.accessToken
  } else {
    alert('æˆæƒå¤±è´¥: ' + data.errorMessage);
  }
});
```

**æ­¥éª¤3: éªŒè¯æˆæƒ**
```javascript
// æ£€æŸ¥è´¦å·çŠ¶æ€
fetch('/checkCainiaoAccount', {method: 'POST'})
.then(response => response.json())
.then(data => {
  console.log('æˆæƒçŠ¶æ€:', data.Success);
  console.log('Tokenæœ‰æ•ˆæœŸè‡³:', data.deadline);
  console.log('å·²è®¢è´­å¿«é€’å…¬å¸:', data.subscriptions.map(s => s.cpName));
});
```

---

### ä¸ƒã€å¸¸è§é—®é¢˜

#### Q1: Tokenè¿‡æœŸäº†æ€ä¹ˆåŠ?
**A**: Tokenæœ‰æ•ˆæœŸé€šå¸¸ä¸º1å¹´,è¿‡æœŸåéœ€è¦:
1. å•†å®¶é‡æ–°åœ¨èœé¸Ÿå¹³å°æˆæƒç”Ÿæˆæ–°çš„accessCode
2. è°ƒç”¨ `/getCainiaoMD5` æ¥å£æ¢å–æ–°Token
3. ç³»ç»Ÿè‡ªåŠ¨æ›´æ–°æ•°æ®åº“

#### Q2: å¦‚ä½•åˆ¤æ–­Tokenæ˜¯å¦æœ‰æ•ˆ?
**A**: è°ƒç”¨ `/checkCainiaoAccount` æ¥å£:
- æˆåŠŸè¿”å›è®¢è´­å…³ç³» â†’ Tokenæœ‰æ•ˆ
- è¿”å›é”™è¯¯ â†’ Tokenå¤±æ•ˆ,éœ€é‡æ–°æˆæƒ

#### Q3: accessCodeå¯ä»¥é‡å¤ä½¿ç”¨å—?
**A**: ä¸å¯ä»¥,accessCodeæ˜¯ä¸€æ¬¡æ€§çš„,æ¢å–Tokenåå³å¤±æ•ˆ

#### Q4: æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒTokené€šç”¨å—?
**A**: ä¸é€šç”¨,éœ€è¦åˆ†åˆ«æˆæƒè·å–

---

### å…«ã€å®‰å…¨å»ºè®®

1. âœ… **ä¸è¦ç¡¬ç¼–ç Token**: Tokenåº”å­˜å‚¨åœ¨æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶ä¸­
2. âœ… **å®šæœŸæ£€æŸ¥Tokenæœ‰æ•ˆæ€§**: å»ºè®®æ¯æ¬¡è°ƒç”¨APIå‰æ£€æŸ¥deadline
3. âœ… **accessCodeä¿å¯†**: ä¸è¦åœ¨å‰ç«¯æš´éœ²accessCode
4. âœ… **HTTPSä¼ è¾“**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
5. âœ… **æƒé™æ§åˆ¶**: Tokenè·å–æ¥å£åº”æœ‰ä¸¥æ ¼çš„æƒé™æ§åˆ¶

---

### ä¹ã€ç›¸å…³APIæ–‡æ¡£

- **èœé¸Ÿç‰©æµäº‘å®˜æ–¹æ–‡æ¡£**: https://cloudprint-doc.caicloud.io/
- **Tokenæ¢å–API**: https://lcp.cloud.cainiao.com/api/permission/exchangeToken.do
- **ç‰©æµäº‘æ§åˆ¶å°**: https://lcp.cloud.cainiao.com

---

è¿™ä»½æ–‡æ¡£æ¶µç›–äº†èœé¸Ÿæˆæƒçš„å®Œæ•´æµç¨‹å’ŒæŠ€æœ¯ç»†èŠ‚,æ‚¨å¯ä»¥æ ¹æ®è¿™ä¸ªæµç¨‹å®ç°å‰ç«¯çš„æˆæƒåŠŸèƒ½!


# èœé¸Ÿç”µå­é¢å•å¯¹æ¥å®Œæ•´æºç å½’æ¡£æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£å½’æ¡£äº†èœé¸Ÿç”µå­é¢å•å¯¹æ¥çš„å®Œæ•´Javaæºç å®ç°ï¼ŒåŒ…å«æ‰€æœ‰æ ¸å¿ƒç±»ã€é…ç½®ä¿¡æ¯å’Œæ•°æ®åº“è®¾è®¡ã€‚

**å½’æ¡£æ—¥æœŸ**: 2026-02-17  
**é¡¹ç›®**: smallrookie-pas  
**æ¨¡å—**: èœé¸Ÿç‰©æµäº‘å¯¹æ¥

---

## ğŸ“‚ æºç ç›®å½•ç»“æ„

```
smallrookie-pas/
â”œâ”€â”€ pas-web/
â”‚   â””â”€â”€ src/main/java/.../controller/
â”‚       â””â”€â”€ KdApiEOrderController.java          # Webæ§åˆ¶å™¨
â”œâ”€â”€ pas-service/
â”‚   â””â”€â”€ src/main/java/.../thirdservice/
â”‚       â”œâ”€â”€ CNExpressPrintService.java          # æ ¸å¿ƒæœåŠ¡ç±»
â”‚       â””â”€â”€ MD5Utils.java                       # æˆæƒå·¥å…·ç±»
â””â”€â”€ pas-domain/
    â””â”€â”€ src/main/java/.../domain/
        â”œâ”€â”€ CainiaoTemplate.java                # æ¨¡æ¿å®ä½“ç±»
        â””â”€â”€ CainiaoToken.java                   # Tokenå®ä½“ç±»
```

---

## 1ï¸âƒ£ æ§åˆ¶å™¨å±‚ - KdApiEOrderController.java

**è·¯å¾„**: `pas-web/src/main/java/com/xc/smallrookie/web/pas/controller/KdApiEOrderController.java`

**åŠŸèƒ½**: æä¾›èœé¸Ÿå¯¹æ¥çš„HTTP APIæ¥å£

```java
package com.xc.smallrookie.web.pas.controller;

import com.xc.smallrookie.common.annotation.ValidateArgument;
import com.xc.smallrookie.common.annotation.ValidateArguments;
import com.xc.smallrookie.common.component.ApiRequest;
import com.xc.smallrookie.common.component.ApiResponse;
import com.xc.smallrookie.common.enums.Result;
import com.xc.smallrookie.pas.domain.CainiaoTemplate;
import com.xc.smallrookie.pas.service.thirdservice.CNExpressPrintService;
import com.xc.smallrookie.pas.service.thirdservice.KdGoldAPIDemo;
import com.xc.smallrookie.pas.service.thirdservice.MD5Utils;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@Api(description = "PASç³»ç»Ÿèœé¸Ÿç”µå­é¢å•ç®¡ç†")
@RestController
@RequestMapping(value = "/smallrookie/pas/kdApiEOrder")
@Validated
@CrossOrigin
public class KdApiEOrderController {

    @Autowired
    private KdGoldAPIDemo kdGoldAPIDemo;

    @Autowired
    private CNExpressPrintService cnExpressPrintService;

    @Autowired
    private MD5Utils md5Utils;

    /**
     * è·å–ç”µå­é¢å•
     * @param apiRequest åŒ…å«å‘ä»¶äººã€æ”¶ä»¶äººã€å¿«é€’å…¬å¸ç­‰ä¿¡æ¯
     * @return ç”µå­é¢å•æ•°æ®
     */
    @ApiOperation(value = "è·å–ç”µå­é¢å•", notes = "æ‰¹é‡è·å–ç”µå­é¢å•")
    @PostMapping(value = "/orderOnlineByJson", produces = "application/json; charset=UTF-8")
    @ValidateArguments(validateArguments = { @ValidateArgument(fieldName = "employeeId", isNumberType = true) })
    @ApiImplicitParam(required = true, name = "apiRequest", dataType = "json")
    public ApiResponse<Object> orderOnlineByJson(@RequestBody ApiRequest<Object> apiRequest) {
        Map<String, Object> res = new HashMap<>();
        try {
            apiRequest.getData();
            res = cnExpressPrintService.getWaybill((HashMap)apiRequest.getData());

        }catch (Exception er){
            System.out.println(er);
        }
        System.out.print("æ‰“å°å®Œæˆï¼Œå¾—åˆ°resä¸º" + res);
        
        if(res.size() <= 0) {
            return ApiResponse.createApiResponse(res, Result.SUCCESS);
        }
        if(res.get("Success").equals("false")) {
            return ApiResponse.createApiResponse(res, Result.FAIL);
        } else {
            return ApiResponse.createApiResponse(res, Result.SUCCESS);
        }
    }

    /**
     * æ£€æŸ¥èœé¸Ÿè´¦å·çŠ¶æ€å’Œè®¢è´­å…³ç³»
     * @param apiRequest
     * @return è´¦å·çŠ¶æ€ã€Tokenã€è®¢è´­å…³ç³»
     */
    @ApiOperation(value = "æ£€æŸ¥èœé¸Ÿè´¦å·çŠ¶æ€", notes = "æŸ¥è¯¢Tokenå’Œè®¢è´­å…³ç³»")
    @PostMapping(value = "/checkCainiaoAccount", produces = "application/json; charset=UTF-8")
    @ValidateArguments(validateArguments = { @ValidateArgument(fieldName = "employeeId", isNumberType = true) })
    @ApiImplicitParam(required = true, name = "apiRequest", dataType = "json")
    public ApiResponse<Object> checkCainiaoAccount(@RequestBody ApiRequest<Object> apiRequest) {
        Map<String, Object> res = new HashMap<String, Object>();
        try {
            res = cnExpressPrintService.getCainiaoAccountStatus();
        }catch (Exception er){
            System.out.println(er);
        }
        System.out.print("èœé¸Ÿè´¦å·è®¢è´­å…³ç³»å®Œæˆï¼Œå¾—åˆ°resä¸º" + res);

        if(res.get("Success").equals("false")) {
            return ApiResponse.createApiResponse(res, Result.FAIL);
        } else {
            return ApiResponse.createApiResponse(res, Result.SUCCESS);
        }
    }

    /**
     * è·å–èœé¸Ÿç”µå­é¢å•æ¨¡æ¿
     * @param apiRequest
     * @return æ¨¡æ¿åˆ—è¡¨
     */
    @ApiOperation(value = "è·å–èœé¸Ÿæ¨¡æ¿", notes = "è·å–å¯ç”¨çš„ç”µå­é¢å•æ¨¡æ¿")
    @PostMapping(value = "/getCainiaoTemplate", produces = "application/json; charset=UTF-8")
    @ValidateArguments(validateArguments = { @ValidateArgument(fieldName = "employeeId", isNumberType = true) })
    @ApiImplicitParam(required = true, name = "apiRequest", dataType = "json")
    public ApiResponse<Map<String,Object>> getCainiaoTemplate(@RequestBody ApiRequest<CainiaoTemplate> apiRequest) {
        Map<String, Object> res = new HashMap<String, Object>();
        try {
            res = cnExpressPrintService.getCainiaoTemplate(apiRequest, null);
        }catch (Exception er){
            System.out.println(er);
        }
        System.out.print("èœé¸Ÿæ¨¡æ¿è·å–æˆåŠŸï¼Œå¾—åˆ°resä¸º" + res);

        if(res != null) {
            return  ApiResponse.createApiResponse(res, Result.SUCCESS);
        } else {
            return ApiResponse.createApiResponse(null, Result.FAIL);
        }
    }

    /**
     * ä½¿ç”¨accessCodeæ¢å–accessToken
     * @param apiRequest åŒ…å«accessCode
     * @return accessToken
     */
    @ApiOperation(value = "è·å–MD5ç­¾åæ¢å–Token", notes = "ä½¿ç”¨accessCodeæ¢å–accessToken")
    @PostMapping(value = "/getCainiaoMD5", produces = "application/json; charset=UTF-8")
    @ValidateArguments(validateArguments = { @ValidateArgument(fieldName = "employeeId", isNumberType = true) })
    @ApiImplicitParam(required = true, name = "apiRequest", dataType = "json")
    public ApiResponse<Object> getCainiaoMD5(@RequestBody ApiRequest<Object> apiRequest) {
        Map<String, String> res = new HashMap<String, String>();
        try {
            res = md5Utils.getMd5(apiRequest);
        }catch (Exception er){
            System.out.println(er);
        }
        System.out.print("æ›´æ–°accessTokenæˆåŠŸï¼Œå¾—åˆ°resä¸º" + res);

        if(res.get("Success").equals("false")) {
            return ApiResponse.createApiResponse(res, Result.FAIL);
        } else {
            return ApiResponse.createApiResponse(res, Result.SUCCESS);
        }
    }

    /**
     * æ‰‹åŠ¨æ›´æ–°Token
     * @param apiRequest åŒ…å«æ–°çš„dailytoken
     * @return æ›´æ–°ç»“æœ
     */
    @ApiOperation(value = "æ›´æ–°Token", notes = "æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“ä¸­çš„Token")
    @PostMapping(value = "/updateToken", produces = "application/json; charset=UTF-8")
    @ValidateArguments(validateArguments = { @ValidateArgument(fieldName = "employeeId", isNumberType = true) })
    @ApiImplicitParam(required = true, name = "apiRequest", dataType = "json")
    public ApiResponse<Object> updateToken(@RequestBody ApiRequest<Object> apiRequest) {
        Map<String, String> res = new HashMap<String, String>();
        try {
            res = cnExpressPrintService.updateDailyToken(apiRequest);
        }catch (Exception er){
            System.out.println(er);
        }
        System.out.print("é—œè¯èœé³¥è³¬è™ŸæˆåŠŸï¼Œå¾—åˆ°resä¸º" + res);

        if(res.get("Success").equals("false")) {
            return ApiResponse.createApiResponse(res, Result.FAIL);
        } else {
            return ApiResponse.createApiResponse(res, Result.SUCCESS);
        }
    }
}
```

---

## 2ï¸âƒ£ æ ¸å¿ƒæœåŠ¡ç±» - CNExpressPrintService.java

**è·¯å¾„**: `pas-service/src/main/java/com/xc/smallrookie/pas/service/thirdservice/CNExpressPrintService.java`

**åŠŸèƒ½**: èœé¸Ÿç”µå­é¢å•çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### é…ç½®ä¿¡æ¯éƒ¨åˆ†

```java
package com.xc.smallrookie.pas.service.thirdservice;

import com.taobao.pac.sdk.cp.PacClient;
import com.taobao.pac.sdk.cp.SendSysParams;
import com.taobao.pac.sdk.cp.dataobject.request.*;
import com.taobao.pac.sdk.cp.dataobject.response.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;
import java.util.*;

@Service
@Transactional
public class CNExpressPrintService {

    // ========== æµ‹è¯•ç¯å¢ƒé…ç½® ==========
    private final static String dailyUrl = "http://link.cainiao.com/gateway/link.do";
    private final static String dailyAppKey = "247457";
    private final static String dailySecretKey = "8e48991050U2cz1g2JA5kU61ve94Rt71";
    private static String dailyToken;  // ä»æ•°æ®åº“åŠ¨æ€è·å–
    private static Date deadlineDate;

    // ========== ç”Ÿäº§ç¯å¢ƒé…ç½® ==========
    private final static String onlineUrl = "http://link.cainiao.com/gateway/link.do";
    private final static String onlineAppKey = "285203";
    private final static String onlineSecretKey = "2fz6b9316tgD8iklyGk7g211PefQ331d";
    private final static String onlineToken = "bzdrNGZMT09aQkJkM1FITmlCWG40d2c3eE5YK09iNTc5K0pWc0NGNnAyZlhFZVBkcGhsYysxclk3OUxlVk5XNw==";

    @Autowired
    private JxcSalesService<JxcSales> jxcSalesService;

    @Autowired
    private ExpressTrackService<ExpressTrack> expressTrackService;

    @Autowired
    private CainiaoTokenService<CainiaoToken> cainiaoTokenService;

    @Autowired
    private CainiaoTemplateService<CainiaoTemplate> cainiaoTemplateService;

    @Autowired
    private CainiaoTemplateDao cainiaoTemplateDao;

    /**
     * è·å–appKey
     */
    public String getDailyAppKey() {
        return dailyAppKey;
    }

    /**
     * è·å–appSecret
     */
    public String getDailySecretKey() {
        return dailySecretKey;
    }

    /**
     * ä»æ•°æ®åº“ä¸­è·å–æˆæƒToken
     */
    public void setDailyToken() {
        CainiaoToken cainiaoToken = cainiaoTokenService.getEntity(1);
        dailyToken = cainiaoToken.getDailytoken();
        deadlineDate = cainiaoToken.getDeadline();
    }

    /**
     * æ‰‹åŠ¨æ›´æ–°Token
     */
    public Map<String, String> updateDailyToken(ApiRequest<Object> apiRequest) {
        Map<String, String> resultMap = new HashMap<>();
        Map ext = apiRequest.getExt();
        
        if(ext != null) {
            if(ext.containsKey("dailytoken")) {
                CainiaoToken cainiaoToken = new CainiaoToken();
                cainiaoToken.setTokenid(1);
                cainiaoToken.setDailytoken(ext.get("dailytoken").toString());

                Calendar calendar = Calendar.getInstance();
                calendar.add(Calendar.YEAR, 1);
                Date deadline = calendar.getTime();
                cainiaoToken.setDeadline(deadline);
                cainiaoToken.setDelflag(1);

                if(cainiaoTokenService.addEntity(cainiaoToken)) {
                    resultMap.put("errorCode", "");
                    resultMap.put("Success", "true");
                }
            } else {
                resultMap.put("errorCode", "");
                resultMap.put("errorMessage", "dailytoken null");
                resultMap.put("Success", "false");
            }
        } else {
            resultMap.put("errorCode", "");
            resultMap.put("errorMessage", "ext null");
            resultMap.put("Success", "false");
        }

        return resultMap;
    }

    /**
     * æŸ¥è¯¢å•†å®¶è®¢è´­å…³ç³»
     */
    public List<WaybillApplySubscriptionInfo> subscriptionQuery(String dailyToken) {
        PacClient client = new PacClient(dailyAppKey, dailySecretKey, dailyUrl);
        SendSysParams params = new SendSysParams();
        params.setFromCode(dailyToken);

        TmsWaybillSubscriptionQueryRequest request = new TmsWaybillSubscriptionQueryRequest();
        TmsWaybillSubscriptionQueryResponse response = client.send(request, params);
        
        if (!response.isSuccess()) {
            System.out.println("errorCode:" + response.getErrorCode() + "errorMessage:" + response.getErrorMsg());
            return null;
        }
        
        return response.getWaybillApplySubscriptionCols();
    }

    /**
     * æŸ¥è¯¢èœé¸Ÿè´¦å·çŠ¶æ€å’Œè®¢è´­å…³ç³»
     */
    public Map<String, Object> getCainiaoAccountStatus() {
        setDailyToken();
        List<WaybillApplySubscriptionInfo> subscriptionInfos = subscriptionQuery(dailyToken);
        
        Map<String, Object> resultMap = new HashMap<>();
        resultMap.put("dailytoken", dailyToken);
        resultMap.put("deadline", deadlineDate);
        resultMap.put("subscriptions", subscriptionInfos);
        resultMap.put("Success", "true");
        
        return resultMap;
    }

    /**
     * ä»æ•°æ®åº“è·å–æ¨¡æ¿URL
     */
    public String getTemplateUrl(String templatename) {
        Example example = new Example(CainiaoTemplate.class);
        Example.Criteria criteria = example.createCriteria();
        criteria.andEqualTo("templatename", templatename);
        
        CainiaoTemplate cainiaoTemplate = cainiaoTemplateDao.selectOneByExample(example);
        if(cainiaoTemplate == null) {
            return "";
        }
        
        return cainiaoTemplate.getTemplateurl();
    }

    /**
     * è·å–èœé¸Ÿæ¨¡æ¿åˆ—è¡¨å¹¶åŒæ­¥åˆ°æ•°æ®åº“
     */
    public Map<String, Object> getCainiaoTemplate(ApiRequest<CainiaoTemplate> apiRequest, Example example) {
        setDailyToken();
        PacClient client = new PacClient(dailyAppKey, dailySecretKey, dailyUrl);
        SendSysParams params = new SendSysParams();
        params.setFromCode(dailyToken);

        Map<String, Object> resultMap = new HashMap<>();

        // è·å–ISVè‡ªå®šä¹‰æ¨¡æ¿ (type=6)
        Long templateType = Long.valueOf(6);
        CloudprintIsvTemplatesRequest isvRequest = new CloudprintIsvTemplatesRequest();
        isvRequest.setTemplateType(templateType);
        CloudprintIsvTemplatesResponse isvResponse = client.send(isvRequest, params);
        
        if(isvResponse.isSuccess()) {
            resultMap.put("isvTemplateDOs", isvResponse.getIsvTemplates());
        }

        // è·å–ISVè‡ªå®šä¹‰æ¨¡æ¿ (type=4)
        templateType = Long.valueOf(4);
        isvRequest.setTemplateType(templateType);
        CloudprintIsvTemplatesResponse isvResponse1 = client.send(isvRequest, params);
        
        if(isvResponse1.isSuccess()) {
            resultMap.put("isvTemplateDLs", isvResponse1.getIsvTemplates());
        }

        // è·å–æ ‡å‡†ç”µå­é¢å•æ¨¡æ¿
        CloudprintStandardTemplatesRequest standardRequest = new CloudprintStandardTemplatesRequest();
        CloudprintStandardTemplatesResponse standardResponse = client.send(standardRequest, params);
        
        if(standardResponse.isSuccess()) {
            List<StandardTemplateResult> standardTemplateResults = standardResponse.getData();
            resultMap.put("standardTemplateResults", standardTemplateResults);
            
            // åŒæ­¥æ¨¡æ¿åˆ°æ•°æ®åº“
            if(standardTemplateResults.size() > 0) {
                for(StandardTemplateResult standardTemplateResult : standardTemplateResults) {
                    List<StandardTemplateDO> templateList = standardTemplateResult.getStandardTemplateDOs();
                    
                    for(StandardTemplateDO templateDO : templateList) {
                        String templateUrl = templateDO.getStandardTemplateUrl();
                        String templateName = templateDO.getStandardTemplateName();
                        Integer waybillType = templateDO.getStandardWaybillType();
                        
                        String fullTemplateName = "èœé¸Ÿç”µå­é¢å•\\" + templateName;
                        
                        CainiaoTemplate cainiaoTemplate = new CainiaoTemplate();
                        cainiaoTemplate.setTemplatename(fullTemplateName);
                        cainiaoTemplate.setTemplateurl(templateUrl);
                        cainiaoTemplate.setTemplatewaybilltype(waybillType);
                        
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        Example selectExample = new Example(CainiaoTemplate.class);
                        Example.Criteria criteria = selectExample.createCriteria();
                        criteria.andEqualTo("templatename", fullTemplateName);
                        
                        if(cainiaoTemplateDao.selectOneByExample(selectExample) == null) {
                            // æ–°å¢
                            int insertNum = cainiaoTemplateDao.insertSelective(cainiaoTemplate);
                            if(insertNum <= 0) {
                                return null;
                            }
                        } else {
                            // æ›´æ–°
                            int ret = cainiaoTemplateDao.updateByExampleSelective(cainiaoTemplate, selectExample);
                            if(ret <= 0) {
                                return null;
                            }
                        }
                    }
                }
            }
        }

        return cainiaoTemplateService.getEntitys(apiRequest, example);
    }

    /**
     * æ‰¹é‡è·å–ç”µå­é¢å•
     * æ ¸å¿ƒæ–¹æ³• - å®Œæ•´å®ç°
     */
    public Map<String, Object> getWaybill(HashMap map) {
        setDailyToken();

        Map<String, Object> resultMap = new HashMap<>();
        PacClient client = new PacClient(dailyAppKey, dailySecretKey, dailyUrl);
        SendSysParams params = new SendSysParams();
        params.setFromCode(dailyToken);

        // è§£æå‘ä»¶äººä¿¡æ¯
        String senderName = map.get("sendername").toString();
        String senderAddress = map.get("senderdetailedaddress").toString();
        String senderCompany = map.get("sendercompanyname").toString();
        String senderPhone = map.get("senderphonemobileno").toString();
        String senderPostcode = map.get("senderpostcode").toString();

        // è§£ææ”¶ä»¶äººåˆ—è¡¨
        List<HashMap> tradeOrderList = null;
        if(map.containsKey("tradeorderlist")) {
            tradeOrderList = (List)map.get("tradeorderlist");
        }

        String expressCompany = map.get("expresscompany").toString();
        String templateName = map.get("templatename").toString();

        // æ„å»ºè¯·æ±‚å¯¹è±¡
        TmsWaybillGetRequest request = new TmsWaybillGetRequest();
        request.setCpCode(expressCompany);

        // è®¾ç½®å‘ä»¶äººä¿¡æ¯
        UserInfoDto sender = new UserInfoDto();
        request.setSender(sender);
        sender.setName(senderName);
        sender.setPhone(senderPhone);
        sender.setMobile(senderPhone);

        // æŸ¥è¯¢å•†å®¶è®¢è´­å…³ç³»è·å–å‘ä»¶åœ°å€
        String province = "";
        String city = "";
        String district = "";
        String detail = "";
        String town = "";
        
        List<WaybillApplySubscriptionInfo> subscriptionList = subscriptionQuery(dailyToken);
        if(subscriptionList.size() <= 0) {
            resultMap.put("errorCode", "");
            resultMap.put("errorMessage", "æœªæŸ¥åˆ°å•†å®¶è®¢è´­å…³ç³»ï¼Œè¯·å…ˆåœ¨èœé¸Ÿå‘è´§å¹³å°åˆ›å»ºç›¸åº”çš„è®¢è´­å…³ç³»");
            resultMap.put("Success", "false");
            return resultMap;
        }
        
        for(WaybillApplySubscriptionInfo subscriptionInfo : subscriptionList) {
            if(subscriptionInfo.getCpCode().equals(expressCompany)) {
                List<WaybillBranchAccount> branchAccounts = subscriptionInfo.getBranchAccountCols();
                if(branchAccounts.size() > 0) {
                    WaybillBranchAccount branchAccount = branchAccounts.get(0);
                    if(branchAccount.getShippAddressCols().size() > 0) {
                        province = branchAccount.getShippAddressCols().get(0).getProvince();
                        city = branchAccount.getShippAddressCols().get(0).getCity();
                        district = branchAccount.getShippAddressCols().get(0).getDistrict();
                        detail = branchAccount.getShippAddressCols().get(0).getDetail();
                        town = branchAccount.getShippAddressCols().get(0).getTown();
                    }
                }
            }
        }

        if(province.equals("")) {
            resultMap.put("errorCode", "");
            resultMap.put("errorMessage", "æœªæŸ¥å½“å‰å¿«é€’å…¬å¸("+expressCompany+")çš„è®¢è´­å…³ç³»ï¼Œè¯·å…ˆåœ¨èœé¸Ÿå‘è´§å¹³å°åˆ›å»ºç›¸åº”çš„è®¢è´­å…³ç³»");
            resultMap.put("Success", "false");
            return resultMap;
        }

        // è®¾ç½®å‘ä»¶åœ°å€
        AddressDto sendAddress = new AddressDto();
        sender.setAddress(sendAddress);
        sendAddress.setProvince(province);
        sendAddress.setCity(city);
        sendAddress.setDistrict(district);
        sendAddress.setDetail(detail);
        sendAddress.setTown(town);

        // è·å–æ¨¡æ¿URL
        String templateUrl = getTemplateUrl(templateName);
        if(templateUrl.equals("")) {
            resultMap.put("errorCode", "");
            resultMap.put("errorMessage", "è·å–å¿«é€’å…¬å¸ï¼ˆ"+expressCompany+")æ¨¡æ¿å¤±è´¥");
            resultMap.put("Success", "false");
            return resultMap;
        }

        // æ„å»ºæ”¶ä»¶äººä¿¡æ¯åˆ—è¡¨
        ArrayList<TradeOrderInfoDto> tradeOrderInfoDtos = new ArrayList<>();
        request.setTradeOrderInfoDtos(tradeOrderInfoDtos);

        if(tradeOrderList != null && tradeOrderList.size() > 0) {
            for(HashMap tradeOrderMap : tradeOrderList) {
                String receiverName = tradeOrderMap.get("receivername").toString();
                String receiverAddress = tradeOrderMap.get("receiverdetailedaddress").toString();
                String receiverCompany = tradeOrderMap.get("receivercompanyname").toString();
                String receiverPhone = tradeOrderMap.get("receiverphonemobileno").toString();
                String receiverPostcode = tradeOrderMap.get("receiverpostcode").toString();
                String goodsName = tradeOrderMap.get("goodscontent").toString();
                if(goodsName == "") {
                    goodsName = "è´§ç‰©";
                }

                String[] receiverAddrArray = splitAddress(receiverAddress);
                String salesIdNumber = tradeOrderMap.get("salesid").toString();
                String goodsAccount = tradeOrderMap.get("goodsaccount").toString();
                String printRemark = tradeOrderMap.get("printremark").toString();

                String objectId = "A";
                if(tradeOrderMap.containsKey("objectid")) {
                    objectId = tradeOrderMap.get("objectid").toString();
                }

                TradeOrderInfoDto tradeOrderInfoDto = new TradeOrderInfoDto();
                tradeOrderInfoDto.setObjectId(objectId);
                tradeOrderInfoDto.setTemplateUrl(templateUrl);
                tradeOrderInfoDtos.add(tradeOrderInfoDto);

                OrderInfoDto orderInfoDto = new OrderInfoDto();
                tradeOrderInfoDto.setOrderInfo(orderInfoDto);
                orderInfoDto.setOrderChannelsType("OTHERS");
                
                ArrayList<String> orderList = new ArrayList<>();
                orderInfoDto.setTradeOrderList(orderList);
                orderList.add(salesIdNumber);

                PackageInfoDto packageInfoDto = new PackageInfoDto();
                tradeOrderInfoDto.setPackageInfo(packageInfoDto);
                ArrayList<Item> items = new ArrayList<>();
                packageInfoDto.setItems(items);
                Item item = new Item();
                items.add(item);
                item.setName(goodsName);
                item.setCount(Integer.parseInt(goodsAccount));

                // æ”¶ä»¶äººä¿¡æ¯
                UserInfoDto receiver = new UserInfoDto();
                tradeOrderInfoDto.setRecipient(receiver);
                receiver.setName(receiverName);
                receiver.setMobile(receiverPhone);
                
                AddressDto receiveAddress = new AddressDto();
                receiver.setAddress(receiveAddress);
                receiveAddress.setProvince(receiverAddrArray[0]);
                receiveAddress.setCity(receiverAddrArray[1]);
                receiveAddress.setDistrict(receiverAddrArray[2]);
                receiveAddress.setDetail(receiverAddrArray[3]);
            }
        } else {
            resultMap.put("errorCode", "");
            resultMap.put("errorMessage", "æ”¶ä»¶ä¿¡æ¯ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„æ”¶ä»¶ä¿¡æ¯");
            resultMap.put("Success", "false");
            return resultMap;
        }

        // è°ƒç”¨èœé¸ŸAPIè·å–é¢å•
        TmsWaybillGetResponse response = client.send(request, params);
        if(!response.isSuccess()) {
            System.out.println("errorCode:" + response.getErrorCode() + ",errorMessage:" + response.getErrorMsg());
            resultMap.put("errorCode", response.getErrorCode());
            resultMap.put("errorMessage", response.getErrorCode());
            resultMap.put("Success", "false");
            return resultMap;
        }
        
        List<WaybillCloudPrintResponse> waybillList = response.getWaybillCloudPrintResponseList();
        resultMap.put("Success", "true");
        resultMap.put("waybillCloudPrintResponseList", waybillList);
        
        SimpleDateFormat f = new SimpleDateFormat("yyyyMMdd");
        Calendar calendar = Calendar.getInstance();
        String dateStr = f.format(calendar.getTime());
        resultMap.put("dateStr", dateStr);

        return resultMap;
    }

    /**
     * åœ°å€è§£æå·¥å…·æ–¹æ³•
     * å°†å®Œæ•´åœ°å€è§£æä¸ºçœå¸‚åŒº+è¯¦ç»†åœ°å€
     */
    public String[] splitAddress(String address) {
        String detailAddress = address;
        String addressTemp = address;
        String provinceName = "";
        String cityName = "";
        String expAreaName = "";

        // è§£æçœä»½
        if(address.length() > 2) {
            provinceName = addressTemp.substring(0,2);
            if(provinceName == "åŒ—äº¬" || provinceName == "ä¸Šæµ·" || provinceName == "å¤©æ´¥" || provinceName == "é‡åº†") {
                address.substring(2);
            } else {
                if(address.contains("è‡ªæ²»åŒº")) {
                    String[] addressList = address.split("è‡ªæ²»åŒº", 2);
                    if(addressList.length > 1) {
                        provinceName = addressList[0] + "è‡ªæ²»åŒº";
                        address = addressList[1];
                    }
                } else {
                    String[] addressList = address.split("çœ", 2);
                    if(addressList.length > 1) {
                        provinceName = addressList[0] + "çœ";
                        address = addressList[1];
                    }
                }
            }
        }

        detailAddress = address;

        // è§£æåŸå¸‚
        String[] addressList = address.split("å¸‚", 2);
        if(addressList.length > 1) {
            cityName = addressList[0] + "å¸‚";
            address = addressList[1];
        }

        // è§£æåŒºå¿
        addressList = address.split("å¿|åŒº|å¸‚", 2);
        if(addressList.length > 1) {
            if(address.contains("å¿")) {
                expAreaName = addressList[0] + "å¿";
            } else if(address.contains("åŒº")) {
                expAreaName = addressList[0] + "åŒº";
            } else if(address.contains("å¸‚")) {
                expAreaName = addressList[0] + "å¸‚";
            }
            address = addressList[1];
        }

        // å¦‚æœè¯¦ç»†åœ°å€ä¸ºç©ºï¼Œè¯´æ˜çœå¸‚å¿ä¸å…¨
        if(address.equals("")) {
            cityName = "";
            expAreaName = "";
            address = detailAddress;
        }

        String[] resultStr = {provinceName, cityName, expAreaName, address};
        return resultStr;
    }
}
```

---

## 3ï¸âƒ£ æˆæƒå·¥å…·ç±» - MD5Utils.java

**è·¯å¾„**: `pas-service/src/main/java/com/xc/smallrookie/pas/service/thirdservice/MD5Utils.java`

**åŠŸèƒ½**: MD5åŠ å¯†å’ŒTokenæ¢å–

```java
package com.xc.smallrookie.pas.service.thirdservice;

import com.xc.smallrookie.pas.domain.CainiaoToken;
import com.xc.smallrookie.common.component.ApiRequest;
import com.xc.smallrookie.pas.service.CainiaoTokenService;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Service
@Transactional
public class MD5Utils {

    @Autowired
    private CNExpressPrintService cnExpressPrintService;

    @Autowired
    private CainiaoTokenService<CainiaoToken> cainiaoTokenService;

    /**
     * MD5åŠ å¯† - å­—ç¬¦ä¸²
     */
    public static byte[] md5Bytes(String text) {
        if(null == text || "".equals(text)) {
            return new byte[0];
        }
        return md5Bytes(text.getBytes());
    }

    /**
     * MD5åŠ å¯† - å­—èŠ‚æ•°ç»„
     */
    public static byte[] md5Bytes(byte[] cnt) {
        MessageDigest msgDigest = null;
        try {
            msgDigest = MessageDigest.getInstance("MD5");
        } catch(NoSuchAlgorithmException e) {
            throw new IllegalStateException("System doesn't support MD5 algorithm.");
        }
        msgDigest.update(cnt);
        byte[] bytes = msgDigest.digest();
        return bytes;
    }

    /**
     * MD5è½¬16è¿›åˆ¶
     */
    private static String md5Hex(byte[] bytes, boolean isReturnRaw) {
        if(isReturnRaw) {
            return new String(bytes);
        }

        String md5Str = new String();
        for(int i = 0; i < bytes.length; i++) {
            byte tb = bytes[i];
            
            char tmpChar = (char)((tb >>> 4) & 0x000f);
            char high = tmpChar >= 10 ? (char)(('a' + tmpChar) - 10) : (char)('0' + tmpChar);
            md5Str += high;
            
            tmpChar = (char)(tb & 0x000f);
            char low = tmpChar >= 10 ? (char)(('a' + tmpChar) - 10) : (char)('0' + tmpChar);
            md5Str += low;
        }
        return md5Str;
    }

    /**
     * MD5åŠ å¯†ä¸»æ–¹æ³•
     */
    public static String md5(String text) {
        if(null == text || "".equals(text)) {
            return text;
        }
        byte[] bytes = md5Bytes(text);
        return md5Hex(bytes, false);
    }

    /**
     * ä½¿ç”¨accessCodeæ¢å–accessToken
     * æ ¸å¿ƒæˆæƒæ–¹æ³•
     */
    public Map<String, String> getMd5(ApiRequest<Object> apiRequest) {
        Map<String, String> resultMap = new HashMap<>();
        Map ext = apiRequest.getExt();
        
        if(ext != null) {
            if(ext.containsKey("accessCode")) {
                String accessCode = ext.get("accessCode").toString();
                String appKey = cnExpressPrintService.getDailyAppKey();
                String appSecret = cnExpressPrintService.getDailySecretKey();

                // ç”Ÿæˆç­¾å: md5(accessCode + "," + appKey + "," + appSecret)
                String sign = md5(accessCode + "," + appKey + "," + appSecret);

                // è°ƒç”¨èœé¸ŸTokenæ¢å–æ¥å£
                String url = "https://lcp.cloud.cainiao.com/api/permission/exchangeToken.do";
                String outputStr = "accessCode=" + accessCode + "&isvAppKey=" + appKey + "&sign=" + sign;
                SSLClient sslClient = new SSLClient();
                url += "?" + outputStr;
                String jsonStr = sslClient.httpsRequest(url, "GET", null);

                try {
                    JSONObject jsonObject = JSONObject.fromObject(jsonStr);
                    String success = jsonObject.get("success").toString();

                    if(success.equals("true")) {
                        JSONArray accessTokens = JSONArray.fromObject(jsonObject.get("accessTokens"));
                        if(accessTokens.size() > 0) {
                            JSONObject firstAccessToken = JSONObject.fromObject(accessTokens.get(0));
                            String accessToken = firstAccessToken.get("accessToken").toString();

                            // ä¿å­˜Tokenåˆ°æ•°æ®åº“
                            CainiaoToken cainiaoToken = new CainiaoToken();
                            cainiaoToken.setTokenid(1);
                            cainiaoToken.setDailytoken(accessToken);

                            Calendar calendar = Calendar.getInstance();
                            calendar.add(Calendar.YEAR, 1);
                            Date deadline = calendar.getTime();
                            cainiaoToken.setDeadline(deadline);
                            cainiaoToken.setDelflag(1);

                            if(cainiaoTokenService.addEntity(cainiaoToken)) {
                                resultMap.put("accessToken", accessToken);
                                resultMap.put("errorCode", "");
                                resultMap.put("Success", "true");
                            } else {
                                resultMap.put("errorCode", "");
                                resultMap.put("errorMessage", "get accessToken Success but save to mysql fail");
                                resultMap.put("Success", "false");
                            }
                        } else {
                            resultMap.put("errorCode", "");
                            resultMap.put("errorMessage", "accessTokens size <= 0");
                            resultMap.put("Success", "false");
                        }
                    } else {
                        String errorMsg = jsonObject.get("errorMsg").toString();
                        resultMap.put("errorCode", "");
                        resultMap.put("errorMessage", errorMsg);
                        resultMap.put("Success", "false");
                    }
                } catch(Exception e) {
                    e.printStackTrace();
                }
            } else {
                resultMap.put("errorCode", "");
                resultMap.put("errorMessage", "accessCode null");
                resultMap.put("Success", "false");
            }
        } else {
            resultMap.put("errorCode", "");
            resultMap.put("errorMessage", "ext null");
            resultMap.put("Success", "false");
        }

        return resultMap;
    }
}
```

---

## 4ï¸âƒ£ å®ä½“ç±»

### CainiaoTemplate.java - æ¨¡æ¿å®ä½“

**è·¯å¾„**: `pas-domain/src/main/java/com/xc/smallrookie/pas/domain/CainiaoTemplate.java`

```java
package com.xc.smallrookie.pas.domain;

import com.alibaba.fastjson.annotation.JSONField;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.experimental.Accessors;

import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@AllArgsConstructor
@NoArgsConstructor
@Data
@EqualsAndHashCode(callSuper=true)
@Accessors(chain=true)
@Table(name="t_cainiao_template")
public class CainiaoTemplate extends EntityBase {
    private static final long serialVersionUID = 3296768926953282046L;

    @Id
    @GeneratedValue(generator = "JDBC")
    private Integer templateid;              // æ¨¡æ¿ID
    
    private String templatename;             // æ¨¡æ¿åç§°
    private String templateurl;              // æ¨¡æ¿URL
    private Integer templatewaybilltype;     // é¢å•ç±»å‹
    private Float horoffset;                 // æ°´å¹³åç§»
    private Float veroffset;                 // å‚ç›´åç§»
    
    @JSONField(format="yyyy-MM-dd HH:mm:ss")
    private Date publisheddatetime;          // å‘å¸ƒæ—¶é—´
    
    private Integer totalprintedcount;       // æ€»æ‰“å°æ¬¡æ•°
    
    @JSONField(format="yyyy-MM-dd HH:mm:ss")
    private Date lastprinteddatetime;        // æœ€åæ‰“å°æ—¶é—´
    
    private String lastewbcontent;           // æœ€åç”µå­é¢å•å†…å®¹
}
```

### CainiaoToken.java - Tokenå®ä½“

**è·¯å¾„**: `pas-domain/src/main/java/com/xc/smallrookie/pas/domain/CainiaoToken.java`

```java
package com.xc.smallrookie.pas.domain;

import com.alibaba.fastjson.annotation.JSONField;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.experimental.Accessors;

import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@AllArgsConstructor
@NoArgsConstructor
@Data
@EqualsAndHashCode(callSuper=true)
@Accessors(chain=true)
@Table(name="t_cainiao_token")
public class CainiaoToken extends EntityBase {
    private static final long serialVersionUID = -8274545025204925722L;

    @Id
    @GeneratedValue(generator = "JDBC")
    private Integer tokenid;                 // Token ID (å›ºå®šä¸º1)
    
    private String dailytoken;               // æˆæƒToken
    
    @JSONField(format="yyyy-MM-dd HH:mm:ss")
    private Date deadline;                   // è¿‡æœŸæ—¶é—´
}
```

---

## 5ï¸âƒ£ æ•°æ®åº“è®¾è®¡

### t_cainiao_token è¡¨

```sql
CREATE TABLE `t_cainiao_token` (
  `tokenid` int(11) NOT NULL,
  `dailytoken` varchar(500) DEFAULT NULL COMMENT 'æˆæƒToken',
  `deadline` datetime DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `delflag` tinyint(1) NOT NULL DEFAULT '1' COMMENT 'åˆ é™¤æ ‡è®°',
  PRIMARY KEY (`tokenid`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
```

### t_cainiao_template è¡¨

```sql
CREATE TABLE `t_cainiao_template` (
  `templateid` int(11) NOT NULL AUTO_INCREMENT,
  `templatename` varchar(100) DEFAULT NULL COMMENT 'æ¨¡æ¿åç§°',
  `templateurl` varchar(500) DEFAULT NULL COMMENT 'æ¨¡æ¿URL',
  `templatewaybilltype` int(11) DEFAULT NULL COMMENT 'é¢å•ç±»å‹',
  `horoffset` float DEFAULT NULL COMMENT 'æ°´å¹³åç§»',
  `veroffset` float DEFAULT NULL COMMENT 'å‚ç›´åç§»',
  `publisheddatetime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'å‘å¸ƒæ—¶é—´',
  `totalprintedcount` int(11) DEFAULT NULL COMMENT 'æ€»æ‰“å°æ¬¡æ•°',
  `lastprinteddatetime` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT 'æœ€åæ‰“å°æ—¶é—´',
  `lastewbcontent` text COMMENT 'æœ€åç”µå­é¢å•å†…å®¹',
  `delflag` tinyint(1) NOT NULL DEFAULT '1' COMMENT 'åˆ é™¤æ ‡è®°',
  PRIMARY KEY (`templateid`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
```

---

## 6ï¸âƒ£ Mavenä¾èµ–

```xml
<!-- èœé¸Ÿç‰©æµäº‘SDK -->
<dependency>
    <groupId>com.taobao.pac.sdk</groupId>
    <artifactId>pac-sdk-cp</artifactId>
    <version>æœ€æ–°ç‰ˆæœ¬</version>
</dependency>

<!-- JSONå¤„ç† -->
<dependency>
    <groupId>net.sf.json-lib</groupId>
    <artifactId>json-lib</artifactId>
    <version>2.4</version>
    <classifier>jdk15</classifier>
</dependency>

<!-- MyBatis -->
<dependency>
    <groupId>tk.mybatis</groupId>
    <artifactId>mapper</artifactId>
    <version>æœ€æ–°ç‰ˆæœ¬</version>
</dependency>

<!-- Spring Boot -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<!-- Lombok -->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>
```

---

## 7ï¸âƒ£ APIæ¥å£æ¸…å•

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½è¯´æ˜ |
|---------|------|---------|
| `/smallrookie/pas/kdApiEOrder/orderOnlineByJson` | POST | æ‰¹é‡è·å–ç”µå­é¢å• |
| `/smallrookie/pas/kdApiEOrder/checkCainiaoAccount` | POST | æ£€æŸ¥è´¦å·çŠ¶æ€å’Œè®¢è´­å…³ç³» |
| `/smallrookie/pas/kdApiEOrder/getCainiaoTemplate` | POST | è·å–ç”µå­é¢å•æ¨¡æ¿åˆ—è¡¨ |
| `/smallrookie/pas/kdApiEOrder/getCainiaoMD5` | POST | ä½¿ç”¨accessCodeæ¢å–Token |
| `/smallrookie/pas/kdApiEOrder/updateToken` | POST | æ‰‹åŠ¨æ›´æ–°Token |

---

## 8ï¸âƒ£ é…ç½®ä¿¡æ¯æ±‡æ€»

### æµ‹è¯•ç¯å¢ƒ
- **APIåœ°å€**: `http://link.cainiao.com/gateway/link.do`
- **AppKey**: `247457`
- **SecretKey**: `8e48991050U2cz1g2JA5kU61ve94Rt71`
- **Token**: ä»æ•°æ®åº“åŠ¨æ€è·å–

### ç”Ÿäº§ç¯å¢ƒ
- **APIåœ°å€**: `http://link.cainiao.com/gateway/link.do`
- **AppKey**: `285203`
- **SecretKey**: `2fz6b9316tgD8iklyGk7g211PefQ331d`
- **Token**: `bzdrNGZMT09aQkJkM1FITmlCWG40d2c3eE5YK09iNTc5K0pWc0NGNnAyZlhFZVBkcGhsYysxclk3OUxlVk5XNw==`

### Tokenæ¢å–æ¥å£
- **URL**: `https://lcp.cloud.cainiao.com/api/permission/exchangeToken.do`
- **æ–¹æ³•**: GET
- **å‚æ•°**: `accessCode`, `isvAppKey`, `sign`

---

## 9ï¸âƒ£ ä½¿ç”¨è¯´æ˜

### é¦–æ¬¡é…ç½®æµç¨‹

1. **å•†å®¶æˆæƒ**: åœ¨èœé¸Ÿç‰©æµäº‘å¹³å°æˆæƒISVåº”ç”¨,è·å–accessCode
2. **æ¢å–Token**: è°ƒç”¨ `/getCainiaoMD5` æ¥å£,ä¼ å…¥accessCodeæ¢å–accessToken
3. **æ£€æŸ¥çŠ¶æ€**: è°ƒç”¨ `/checkCainiaoAccount` éªŒè¯Tokenæœ‰æ•ˆæ€§
4. **åŒæ­¥æ¨¡æ¿**: è°ƒç”¨ `/getCainiaoTemplate` åŒæ­¥ç”µå­é¢å•æ¨¡æ¿
5. **è·å–é¢å•**: è°ƒç”¨ `/orderOnlineByJson` æ‰¹é‡è·å–ç”µå­é¢å•

### æ•°æ®æµç¨‹

```
å•†å®¶æˆæƒ â†’ accessCode â†’ MD5ç­¾å â†’ accessToken â†’ ä¿å­˜æ•°æ®åº“ â†’ è°ƒç”¨API
```

---

## ğŸ”Ÿ æ³¨æ„äº‹é¡¹

1. **Tokenæœ‰æ•ˆæœŸ**: accessTokenæœ‰æ•ˆæœŸä¸º1å¹´,è¿‡æœŸéœ€é‡æ–°æˆæƒ
2. **å•ä¾‹æ¨¡å¼**: t_cainiao_tokenè¡¨ä½¿ç”¨tokenid=1ä½œä¸ºå”¯ä¸€è®°å½•
3. **åœ°å€è§£æ**: splitAddressæ–¹æ³•å¤„ç†ä¸­å›½åœ°å€æ ¼å¼,éœ€æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
4. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ¥å£è¿”å›éƒ½åŒ…å«Successå­—æ®µæ ‡è¯†æˆåŠŸ/å¤±è´¥
5. **å¹¶å‘å®‰å…¨**: Serviceå±‚ä½¿ç”¨@Transactionalä¿è¯äº‹åŠ¡ä¸€è‡´æ€§
6. **æ¨¡æ¿åŒæ­¥**: æ¯æ¬¡è°ƒç”¨getCainiaoTemplateéƒ½ä¼šä»èœé¸ŸAPIåŒæ­¥æœ€æ–°æ¨¡æ¿åˆ°æ•°æ®åº“

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [èœé¸Ÿç‰©æµäº‘å®˜æ–¹æ–‡æ¡£](https://cloudprint-doc.caicloud.io/)
- [èœé¸ŸSDKä½¿ç”¨æŒ‡å—](https://github.com/cainiao-network/pac-sdk-cp)
- [ç”µå­é¢å•APIæ–‡æ¡£](https://cloudprint-doc.caicloud.io/doc.htm)

---

## ğŸ“… å½’æ¡£ä¿¡æ¯

- **å½’æ¡£æ—¥æœŸ**: 2026-02-17
- **æºç ç‰ˆæœ¬**: smallrookie-pas v1.0
- **ä»£ç æ€»è¡Œæ•°**: çº¦1400è¡Œ
- **æ ¸å¿ƒæ–‡ä»¶æ•°**: 4ä¸ª
- **æ”¯æŒå¿«é€’å…¬å¸**: é¡ºä¸°ã€ç”³é€šã€ä¸­é€šã€åœ†é€šã€éŸµè¾¾ã€EMSç­‰ä¸»æµå¿«é€’

---

**å½’æ¡£å®Œæˆ** âœ…
