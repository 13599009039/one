<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录调试工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>登录持久化调试工具</h1>
    
    <div class="section">
        <h2>1. 检查localStorage</h2>
        <button onclick="checkLocalStorage()">检查存储状态</button>
        <button onclick="clearLocalStorage()">清除所有localStorage</button>
        <pre id="localStorageResult"></pre>
    </div>
    
    <div class="section">
        <h2>2. 测试API连接</h2>
        <button onclick="testAPI()">测试登录API</button>
        <pre id="apiResult"></pre>
    </div>
    
    <div class="section">
        <h2>3. 检查JS版本</h2>
        <button onclick="checkVersion()">检查加载的JS版本</button>
        <pre id="versionResult"></pre>
    </div>
    
    <div class="section">
        <h2>4. 模拟自动登录</h2>
        <button onclick="simulateAutoLogin()">模拟刷新页面自动登录</button>
        <pre id="autoLoginResult"></pre>
    </div>

    <script>
        function checkLocalStorage() {
            const result = document.getElementById('localStorageResult');
            const data = {
                logged_in: localStorage.getItem('ajkuaiji_logged_in'),
                has_user: !!localStorage.getItem('ajkuaiji_current_user'),
                has_pwd: !!localStorage.getItem('ajkuaiji_saved_pwd'),
                user: localStorage.getItem('ajkuaiji_current_user') ? 
                      JSON.parse(localStorage.getItem('ajkuaiji_current_user')).username : 'N/A'
            };
            
            result.innerHTML = JSON.stringify(data, null, 2);
            
            if (!data.has_pwd) {
                result.innerHTML += '\n\n<span class="error">⚠️ 警告：没有保存密码，需要重新登录一次！</span>';
            } else {
                result.innerHTML += '\n\n<span class="success">✅ localStorage状态正常</span>';
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('ajkuaiji_logged_in');
            localStorage.removeItem('ajkuaiji_current_user');
            localStorage.removeItem('ajkuaiji_saved_pwd');
            alert('已清除所有登录信息，请刷新页面重新登录');
        }
        
        async function testAPI() {
            const result = document.getElementById('apiResult');
            result.innerHTML = '正在测试API...';
            
            try {
                const response = await fetch('/api/users/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: '123456' })
                });
                
                const data = await response.json();
                result.innerHTML = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    result.innerHTML += '\n\n<span class="success">✅ API连接正常</span>';
                } else {
                    result.innerHTML += '\n\n<span class="error">❌ 登录失败：' + data.message + '</span>';
                }
            } catch (error) {
                result.innerHTML = '<span class="error">❌ API连接失败：' + error.message + '</span>';
            }
        }
        
        async function checkVersion() {
            const result = document.getElementById('versionResult');
            result.innerHTML = '正在检查版本...';
            
            try {
                // 检查login.js是否包含新代码
                const response = await fetch('/modules/login.js?t=' + Date.now());
                const code = await response.text();
                
                const hasNewCode = code.includes('ajkuaiji_saved_pwd');
                const hasAPIVerify = code.includes('调用API重新验证登录');
                
                result.innerHTML = `login.js 检查结果：
- 包含密码保存代码: ${hasNewCode ? '✅ 是' : '❌ 否'}
- 包含API验证代码: ${hasAPIVerify ? '✅ 是' : '❌ 否'}

文件前100行预览：
${code.split('\n').slice(0, 100).join('\n')}`;
                
                if (!hasNewCode || !hasAPIVerify) {
                    result.innerHTML += '\n\n<span class="error">⚠️ 警告：代码未更新，请强制刷新（Ctrl+Shift+R）</span>';
                }
            } catch (error) {
                result.innerHTML = '<span class="error">检查失败：' + error.message + '</span>';
            }
        }
        
        async function simulateAutoLogin() {
            const result = document.getElementById('autoLoginResult');
            result.innerHTML = '正在模拟自动登录...';
            
            const savedPwd = localStorage.getItem('ajkuaiji_saved_pwd');
            const savedUser = localStorage.getItem('ajkuaiji_current_user');
            
            if (!savedPwd) {
                result.innerHTML = '<span class="error">❌ localStorage中没有保存密码，无法自动登录</span>\n\n解决方案：清除localStorage后重新登录一次';
                return;
            }
            
            try {
                const user = JSON.parse(savedUser);
                const password = atob(savedPwd);
                
                result.innerHTML += `\n检测到用户：${user.username}\n正在调用API验证...`;
                
                const response = await fetch('/api/users/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user.username, password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML += '\n\n<span class="success">✅ 自动登录成功！</span>';
                    result.innerHTML += '\n\n返回数据：\n' + JSON.stringify(data.user, null, 2);
                } else {
                    result.innerHTML += '\n\n<span class="error">❌ 自动登录失败：' + data.message + '</span>';
                }
            } catch (error) {
                result.innerHTML += '\n\n<span class="error">❌ 错误：' + error.message + '</span>';
            }
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>
