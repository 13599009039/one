<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å®¢æˆ·ç®¡ç†è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.ok {
            background: #dcfce7;
            color: #166534;
        }
        .status.fail {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å®¢æˆ·ç®¡ç†åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
    
    <div class="card">
        <h2>è¯Šæ–­æ­¥éª¤</h2>
        <button onclick="runDiagnostics()">ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­</button>
        <button onclick="testSaveCustomer()">ğŸ’¾ æµ‹è¯•ä¿å­˜å®¢æˆ·åŠŸèƒ½</button>
        <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
    </div>
    
    <div class="card">
        <h2>è¯Šæ–­ç»“æœ</h2>
        <div id="results"></div>
    </div>
    
    <div class="card">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <pre id="logs"></pre>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogs();
            console.log(`[è¯Šæ–­å·¥å…·] ${message}`);
        }
        
        function updateLogs() {
            document.getElementById('logs').textContent = logs.join('\n');
        }
        
        function showResult(html) {
            document.getElementById('results').innerHTML = html;
        }
        
        async function runDiagnostics() {
            logs = [];
            log('å¼€å§‹è¯Šæ–­...', 'info');
            
            let results = [];
            
            // æ£€æŸ¥1: database.jsåŠ è½½
            log('æ£€æŸ¥ database.js æ˜¯å¦åŠ è½½...');
            if (typeof window.db !== 'undefined') {
                results.push('<div>âœ… database.js å·²åŠ è½½ <span class="status ok">OK</span></div>');
                log('database.js å·²æˆåŠŸåŠ è½½', 'success');
            } else {
                results.push('<div>âŒ database.js æœªåŠ è½½ <span class="status fail">FAIL</span></div>');
                log('database.js æœªåŠ è½½ï¼', 'error');
            }
            
            // æ£€æŸ¥2: å…³é”®å‡½æ•°
            const functions = ['getAllCustomers', 'getCustomerById', 'addCustomer', 'updateCustomer', 'getUsers', 'getSystemSettings'];
            log('æ£€æŸ¥æ•°æ®åº“å‡½æ•°...');
            
            for (const func of functions) {
                if (window.db && typeof window.db[func] === 'function') {
                    results.push(`<div>âœ… window.db.${func} <span class="status ok">OK</span></div>`);
                } else {
                    results.push(`<div>âŒ window.db.${func} <span class="status fail">FAIL</span></div>`);
                    log(`å‡½æ•° ${func} ä¸å­˜åœ¨`, 'error');
                }
            }
            
            // æ£€æŸ¥3: customers.jsåŠ è½½
            log('æ£€æŸ¥ customers.js æ˜¯å¦åŠ è½½...');
            if (typeof window.saveCustomer === 'function') {
                results.push('<div>âœ… customers.js å·²åŠ è½½ <span class="status ok">OK</span></div>');
                log('customers.js å·²æˆåŠŸåŠ è½½', 'success');
            } else {
                results.push('<div>âŒ customers.js æœªåŠ è½½ <span class="status fail">FAIL</span></div>');
                log('customers.js æœªåŠ è½½ï¼', 'error');
            }
            
            // æ£€æŸ¥4: LocalStorage
            log('æ£€æŸ¥ LocalStorage...');
            try {
                localStorage.setItem('test', '1');
                localStorage.removeItem('test');
                results.push('<div>âœ… LocalStorage å¯ç”¨ <span class="status ok">OK</span></div>');
                log('LocalStorage æ­£å¸¸å·¥ä½œ', 'success');
            } catch(e) {
                results.push('<div>âŒ LocalStorage ä¸å¯ç”¨ <span class="status fail">FAIL</span></div>');
                log('LocalStorage é”™è¯¯: ' + e.message, 'error');
            }
            
            // æ£€æŸ¥5: ç°æœ‰æ•°æ®
            log('æ£€æŸ¥ç°æœ‰å®¢æˆ·æ•°æ®...');
            if (window.db && window.db.getAllCustomers) {
                const customers = window.db.getAllCustomers();
                results.push(`<div>ğŸ“Š å½“å‰å®¢æˆ·æ•°é‡: ${customers.length} <span class="status ok">${customers.length}</span></div>`);
                log(`æ‰¾åˆ° ${customers.length} ä¸ªå®¢æˆ·`, 'info');
                
                if (customers.length > 0) {
                    results.push(`<div>æœ€æ–°å®¢æˆ·: ${customers[customers.length-1].shop_name}</div>`);
                }
            }
            
            // æ£€æŸ¥6: é…ç½®æ•°æ®
            log('æ£€æŸ¥ç³»ç»Ÿé…ç½®...');
            if (window.db && window.db.getSystemSettings) {
                const settings = window.db.getSystemSettings();
                if (settings.cooperationModes && settings.industries) {
                    results.push('<div>âœ… ç³»ç»Ÿé…ç½®æ­£å¸¸ï¼ˆåˆä½œæ¨¡å¼ã€è¡Œä¸šåˆ—è¡¨ï¼‰ <span class="status ok">OK</span></div>');
                    log('ç³»ç»Ÿé…ç½®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    results.push('<div>âš ï¸ ç³»ç»Ÿé…ç½®ä¸å®Œæ•´ <span class="status fail">WARNING</span></div>');
                    log('ç³»ç»Ÿé…ç½®ä¸å®Œæ•´', 'warning');
                }
            }
            
            showResult(results.join(''));
            log('è¯Šæ–­å®Œæˆï¼', 'info');
        }
        
        function testSaveCustomer() {
            log('å¼€å§‹æµ‹è¯•ä¿å­˜å®¢æˆ·åŠŸèƒ½...', 'info');
            
            if (!window.db || typeof window.db.addCustomer !== 'function') {
                log('é”™è¯¯ï¼šdatabase.js æœªæ­£ç¡®åŠ è½½ï¼', 'error');
                alert('é”™è¯¯ï¼šdatabase.js æœªæ­£ç¡®åŠ è½½ï¼è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                return;
            }
            
            // åˆ›å»ºæµ‹è¯•æ•°æ®
            const testData = {
                merchant_id: 'TEST' + Date.now(),
                shop_name: 'æµ‹è¯•å®¢æˆ·' + Date.now(),
                credit_code: 'TEST' + Date.now(),
                douyin_name: 'æµ‹è¯•æŠ–éŸ³å·',
                company_name: 'æµ‹è¯•å…¬å¸',
                industry: 'é¤é¥®',
                status: 'åˆä½œä¸­',
                cooperation_mode: 'çŸ­è§†é¢‘æ‹æ‘„',
                category: 'æµ‹è¯•ç±»ç›®',
                contacts: [
                    { name: 'å¼ ä¸‰', phone: '13800138000', position: 'ç»ç†' }
                ],
                memos: [],
                attachments: []
            };
            
            log('æµ‹è¯•æ•°æ®: ' + JSON.stringify(testData, null, 2), 'info');
            
            try {
                const result = window.db.addCustomer(testData);
                log('ä¿å­˜ç»“æœ: ' + JSON.stringify(result), 'info');
                
                if (result.success) {
                    log('âœ… ä¿å­˜æˆåŠŸï¼å®¢æˆ·ID: ' + result.data.id, 'success');
                    alert('âœ… æµ‹è¯•æˆåŠŸï¼å®¢æˆ·å·²ä¿å­˜ï¼ŒID: ' + result.data.id);
                    
                    // éªŒè¯ä¿å­˜
                    const customers = window.db.getAllCustomers();
                    log(`å½“å‰æ€»å®¢æˆ·æ•°: ${customers.length}`, 'info');
                } else {
                    log('âŒ ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch(e) {
                log('âŒ å¼‚å¸¸é”™è¯¯: ' + e.message, 'error');
                alert('âŒ å‘ç”Ÿé”™è¯¯: ' + e.message);
            }
        }
        
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å’Œæ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å®¢æˆ·ã€æµæ°´ç­‰æ•°æ®ï¼')) {
                localStorage.clear();
                log('å·²æ¸…é™¤ LocalStorage', 'warning');
                alert('ç¼“å­˜å·²æ¸…é™¤ï¼è¯·åˆ·æ–°é¡µé¢ã€‚');
                location.reload();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            log('è¯Šæ–­å·¥å…·å·²åŠ è½½', 'info');
            setTimeout(runDiagnostics, 500);
        });
    </script>
    
    <!-- åŠ è½½ä¸»ç³»ç»Ÿçš„JavaScriptæ–‡ä»¶ -->
    <script src="modules/database.js?v=3.1"></script>
    <script src="modules/customers.js?v=2.1"></script>
</body>
</html>
