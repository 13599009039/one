# æ·±åº¦ç»Ÿè®¡åˆ†æç³»ç»Ÿå¼€å‘è®¡åˆ’

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026å¹´2æœˆ13æ—¥  
**çŠ¶æ€**: è§„åˆ’ä¸­  
**ä¼˜å…ˆçº§**: P1ï¼ˆæˆ˜ç•¥åŠŸèƒ½ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ç»Ÿè®¡ç»´åº¦è®¾è®¡](#ç»Ÿè®¡ç»´åº¦è®¾è®¡)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [æŒ‡æ ‡ä½“ç³»](#æŒ‡æ ‡ä½“ç³»)
5. [åŠŸèƒ½å¼€å‘æ¸…å•](#åŠŸèƒ½å¼€å‘æ¸…å•)
6. [æŠ€æœ¯å®ç°æ–¹æ¡ˆ](#æŠ€æœ¯å®ç°æ–¹æ¡ˆ)

---

## ç³»ç»Ÿæ¦‚è¿°

### ä¸šåŠ¡èƒŒæ™¯

é’ˆå¯¹æŠ–éŸ³æœ¬åœ°ç”Ÿæ´»æœåŠ¡å•†åœºæ™¯ï¼Œå»ºç«‹å¤šç»´åº¦ã€ç²¾ç»†åŒ–çš„ç»Ÿè®¡åˆ†æä½“ç³»ï¼Œæ”¯æŒå›¢é˜Ÿã€äººå‘˜ã€é¡¹ç›®ã€å®¢æˆ·ç­‰å¤šä¸ªç»´åº¦çš„æ•°æ®åˆ†æï¼Œä¸ºç®¡ç†å†³ç­–æä¾›æ•°æ®æ”¯æ’‘ã€‚

### æ ¸å¿ƒç›®æ ‡

1. **å¤šç»´åº¦ç»Ÿè®¡**: æ”¯æŒå›¢é˜Ÿã€äººå‘˜ã€é¡¹ç›®ã€å®¢æˆ·ã€æ—¶é—´ç­‰å¤šç»´äº¤å‰åˆ†æ
2. **äººæ•ˆåˆ†æ**: è®¡ç®—ä¸ªäººã€å›¢é˜Ÿã€å…¬å¸çš„äººæ•ˆæŒ‡æ ‡
3. **å®¢æˆ·ä»·å€¼åˆ†æ**: å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼(LTV)ã€å®¢å•ä»·ã€æŠ•äº§æ¯”ç­‰
4. **æˆæœ¬åˆ©æ¶¦åˆ†æ**: ç²¾ç»†åŒ–æˆæœ¬æ ¸ç®—ï¼Œé¡¹ç›®çº§ã€å®¢æˆ·çº§åˆ©æ¶¦åˆ†æ
5. **è¶‹åŠ¿é¢„æµ‹**: åŸºäºå†å²æ•°æ®çš„è¶‹åŠ¿é¢„æµ‹å’Œé¢„è­¦

---

## ç»Ÿè®¡ç»´åº¦è®¾è®¡

### 1. ç»„ç»‡ç»´åº¦

```
å…¬å¸(Company)
  â””â”€ å›¢é˜Ÿ(Team)
      â””â”€ äººå‘˜(Staff)
```

#### ç»Ÿè®¡æŒ‡æ ‡
- **å›¢é˜Ÿçº§**
  - æœˆåº¦é”€å”®é¢
  - æœˆåº¦æˆæœ¬
  - æœˆåº¦åˆ©æ¶¦
  - æ¯›åˆ©ç‡
  - å®¢æˆ·æ•°é‡
  - è®¢å•æ•°é‡
  - äººå‡äº§å€¼
  - äººå‡åˆ©æ¶¦

- **äººå‘˜çº§**
  - ä¸ªäººé”€å”®é¢
  - ä¸ªäººè·Ÿè¿›å®¢æˆ·æ•°
  - ä¸ªäººç­¾å•æ•°
  - ä¸ªäººæˆäº¤ç‡
  - ä¸ªäººå®¢å•ä»·
  - ä¸ªäººäººæ•ˆ

### 2. å®¢æˆ·ç»´åº¦

#### ç»Ÿè®¡æŒ‡æ ‡
- å®¢æˆ·æ€»æŠ•å…¥æˆæœ¬
- å®¢æˆ·æ€»äº§ç”Ÿåˆ©æ¶¦
- å®¢æˆ·æŠ•äº§æ¯”ï¼ˆROIï¼‰
- å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆLTVï¼‰
- å®¢æˆ·ç»­è´¹ç‡
- å®¢æˆ·æµå¤±ç‡
- å®¢å•ä»·

### 3. é¡¹ç›®ç»´åº¦

#### ç»Ÿè®¡æŒ‡æ ‡
- é¡¹ç›®æ€»é”€å”®é¢
- é¡¹ç›®æ€»æˆæœ¬
- é¡¹ç›®åˆ©æ¶¦
- é¡¹ç›®å‘¨æœŸ
- é¡¹ç›®äººæ•ˆ

### 4. æ—¶é—´ç»´åº¦

#### ç»Ÿè®¡å‘¨æœŸ
- æ—¥æŠ¥
- å‘¨æŠ¥
- æœˆæŠ¥
- å­£æŠ¥
- å¹´æŠ¥

---

## æ•°æ®åº“è®¾è®¡

### 1. analytics_summaryï¼ˆç»Ÿè®¡æ±‡æ€»è¡¨ï¼‰

```sql
CREATE TABLE IF NOT EXISTS `analytics_summary` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `company_id` INT NOT NULL COMMENT 'å…¬å¸ID',
  `dimension_type` VARCHAR(50) NOT NULL COMMENT 'ç»´åº¦ç±»å‹ï¼ˆcompany/team/staff/customer/projectï¼‰',
  `dimension_id` INT NOT NULL COMMENT 'ç»´åº¦ID',
  `period_type` VARCHAR(20) NOT NULL COMMENT 'ç»Ÿè®¡å‘¨æœŸï¼ˆday/week/month/quarter/yearï¼‰',
  `period_value` VARCHAR(20) NOT NULL COMMENT 'å‘¨æœŸå€¼ï¼ˆå¦‚2026-02ï¼‰',
  `start_date` DATE NOT NULL COMMENT 'å¼€å§‹æ—¥æœŸ',
  `end_date` DATE NOT NULL COMMENT 'ç»“æŸæ—¥æœŸ',
  
  -- é”€å”®æŒ‡æ ‡
  `total_sales` DECIMAL(15,2) DEFAULT 0 COMMENT 'æ€»é”€å”®é¢',
  `total_orders` INT DEFAULT 0 COMMENT 'è®¢å•æ•°',
  `avg_order_amount` DECIMAL(15,2) DEFAULT 0 COMMENT 'å¹³å‡è®¢å•é‡‘é¢',
  `new_customers` INT DEFAULT 0 COMMENT 'æ–°å¢å®¢æˆ·æ•°',
  
  -- æˆæœ¬æŒ‡æ ‡
  `total_cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'æ€»æˆæœ¬',
  `filming_cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'æ‹æ‘„æˆæœ¬',
  `advertising_cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'æŠ•æ”¾æˆæœ¬',
  `personnel_cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'äººå‘˜æˆæœ¬',
  `other_cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'å…¶ä»–æˆæœ¬',
  
  -- åˆ©æ¶¦æŒ‡æ ‡
  `gross_profit` DECIMAL(15,2) DEFAULT 0 COMMENT 'æ¯›åˆ©æ¶¦',
  `profit_margin` DECIMAL(10,2) DEFAULT 0 COMMENT 'æ¯›åˆ©ç‡(%)',
  `net_profit` DECIMAL(15,2) DEFAULT 0 COMMENT 'å‡€åˆ©æ¶¦',
  
  -- äººæ•ˆæŒ‡æ ‡
  `staff_count` INT DEFAULT 0 COMMENT 'äººå‘˜æ•°é‡',
  `per_capita_sales` DECIMAL(15,2) DEFAULT 0 COMMENT 'äººå‡é”€å”®é¢',
  `per_capita_profit` DECIMAL(15,2) DEFAULT 0 COMMENT 'äººå‡åˆ©æ¶¦',
  
  -- å®¢æˆ·æŒ‡æ ‡
  `active_customers` INT DEFAULT 0 COMMENT 'æ´»è·ƒå®¢æˆ·æ•°',
  `customer_retention_rate` DECIMAL(10,2) DEFAULT 0 COMMENT 'å®¢æˆ·ç•™å­˜ç‡(%)',
  
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_analytics` (`dimension_type`, `dimension_id`, `period_type`, `period_value`),
  INDEX `idx_company_period` (`company_id`, `period_type`, `period_value`),
  INDEX `idx_dimension` (`dimension_type`, `dimension_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç»Ÿè®¡æ±‡æ€»è¡¨';
```

### 2. customer_analyticsï¼ˆå®¢æˆ·ç»´åº¦ç»Ÿè®¡è¡¨ï¼‰

```sql
CREATE TABLE IF NOT EXISTS `customer_analytics` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `customer_id` INT NOT NULL COMMENT 'å®¢æˆ·ID',
  `company_id` INT NOT NULL COMMENT 'å…¬å¸ID',
  
  -- ç´¯è®¡æŒ‡æ ‡
  `total_orders` INT DEFAULT 0 COMMENT 'ç´¯è®¡è®¢å•æ•°',
  `total_sales` DECIMAL(15,2) DEFAULT 0 COMMENT 'ç´¯è®¡é”€å”®é¢',
  `total_cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'ç´¯è®¡æˆæœ¬',
  `total_profit` DECIMAL(15,2) DEFAULT 0 COMMENT 'ç´¯è®¡åˆ©æ¶¦',
  
  -- å®¢æˆ·ä»·å€¼æŒ‡æ ‡
  `ltv` DECIMAL(15,2) DEFAULT 0 COMMENT 'å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼',
  `roi` DECIMAL(10,2) DEFAULT 0 COMMENT 'æŠ•èµ„å›æŠ¥ç‡(%)',
  `avg_order_amount` DECIMAL(15,2) DEFAULT 0 COMMENT 'å¹³å‡è®¢å•é‡‘é¢',
  
  -- æ—¶é—´æŒ‡æ ‡
  `first_order_date` DATE COMMENT 'é¦–æ¬¡ä¸‹å•æ—¥æœŸ',
  `last_order_date` DATE COMMENT 'æœ€è¿‘ä¸‹å•æ—¥æœŸ',
  `customer_lifecycle_days` INT DEFAULT 0 COMMENT 'å®¢æˆ·ç”Ÿå‘½å‘¨æœŸï¼ˆå¤©ï¼‰',
  
  -- æ´»è·ƒåº¦æŒ‡æ ‡
  `is_active` TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦æ´»è·ƒ',
  `last_contact_date` DATE COMMENT 'æœ€åè”ç³»æ—¥æœŸ',
  `contact_frequency` INT DEFAULT 0 COMMENT 'è”ç³»é¢‘æ¬¡',
  
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_customer` (`customer_id`),
  INDEX `idx_company_id` (`company_id`),
  FOREIGN KEY (`customer_id`) REFERENCES `customers`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å®¢æˆ·ç»´åº¦ç»Ÿè®¡è¡¨';
```

### 3. staff_performanceï¼ˆå‘˜å·¥ç»©æ•ˆè¡¨ï¼‰

```sql
CREATE TABLE IF NOT EXISTS `staff_performance` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `company_id` INT NOT NULL COMMENT 'å…¬å¸ID',
  `team_id` INT COMMENT 'å›¢é˜ŸID',
  `period_type` VARCHAR(20) NOT NULL COMMENT 'ç»Ÿè®¡å‘¨æœŸ',
  `period_value` VARCHAR(20) NOT NULL COMMENT 'å‘¨æœŸå€¼',
  `start_date` DATE NOT NULL,
  `end_date` DATE NOT NULL,
  
  -- ä¸šåŠ¡æŒ‡æ ‡
  `new_customers` INT DEFAULT 0 COMMENT 'æ–°å¢å®¢æˆ·æ•°',
  `follow_customers` INT DEFAULT 0 COMMENT 'è·Ÿè¿›å®¢æˆ·æ•°',
  `signed_orders` INT DEFAULT 0 COMMENT 'ç­¾å•æ•°',
  `total_sales` DECIMAL(15,2) DEFAULT 0 COMMENT 'æ€»é”€å”®é¢',
  `completed_tasks` INT DEFAULT 0 COMMENT 'å®Œæˆä»»åŠ¡æ•°',
  
  -- æ•ˆç‡æŒ‡æ ‡
  `conversion_rate` DECIMAL(10,2) DEFAULT 0 COMMENT 'æˆäº¤è½¬åŒ–ç‡(%)',
  `avg_order_amount` DECIMAL(15,2) DEFAULT 0 COMMENT 'å¹³å‡è®¢å•é‡‘é¢',
  `per_capita_sales` DECIMAL(15,2) DEFAULT 0 COMMENT 'äººå‡äº§å€¼',
  
  -- æˆæœ¬åˆ©æ¶¦
  `cost` DECIMAL(15,2) DEFAULT 0 COMMENT 'æˆæœ¬',
  `profit` DECIMAL(15,2) DEFAULT 0 COMMENT 'åˆ©æ¶¦',
  `profit_margin` DECIMAL(10,2) DEFAULT 0 COMMENT 'åˆ©æ¶¦ç‡(%)',
  
  -- å®¢æˆ·è´¨é‡
  `customer_satisfaction` DECIMAL(10,2) DEFAULT 0 COMMENT 'å®¢æˆ·æ»¡æ„åº¦',
  `customer_complaints` INT DEFAULT 0 COMMENT 'å®¢æˆ·æŠ•è¯‰æ•°',
  
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_staff_period` (`user_id`, `period_type`, `period_value`),
  INDEX `idx_company_period` (`company_id`, `period_type`, `period_value`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å‘˜å·¥ç»©æ•ˆè¡¨';
```

---

## æŒ‡æ ‡ä½“ç³»

### 1. é”€å”®æŒ‡æ ‡

#### 1.1 é”€å”®é¢æŒ‡æ ‡
```sql
-- æ€»é”€å”®é¢ï¼ˆç‰¹å®šå‘¨æœŸï¼‰
SELECT SUM(contract_amount) as total_sales
FROM orders
WHERE order_date BETWEEN '2026-02-01' AND '2026-02-28'
  AND status != 'å·²å–æ¶ˆ';

-- å›¢é˜Ÿé”€å”®é¢
SELECT team, SUM(contract_amount) as team_sales
FROM orders
WHERE order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY team;

-- ä¸ªäººé”€å”®é¢
SELECT business_staff_id, u.name, SUM(o.contract_amount) as personal_sales
FROM orders o
JOIN users u ON o.business_staff_id = u.id
WHERE o.order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY business_staff_id;
```

#### 1.2 å®¢å•ä»·
```sql
-- æ•´ä½“å®¢å•ä»·
SELECT AVG(contract_amount) as avg_order_amount
FROM orders
WHERE order_date BETWEEN '2026-02-01' AND '2026-02-28';

-- ä¸ªäººå®¢å•ä»·
SELECT business_staff_id, u.name, 
       AVG(o.contract_amount) as avg_order_amount,
       COUNT(*) as order_count
FROM orders o
JOIN users u ON o.business_staff_id = u.id
WHERE o.order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY business_staff_id;
```

### 2. æˆæœ¬æŒ‡æ ‡

#### 2.1 æˆæœ¬åˆ†ç±»ç»Ÿè®¡
```sql
-- æŒ‰æˆæœ¬ç±»åˆ«æ±‡æ€»
SELECT 
    cc.name as cost_category,
    SUM(tc.amount) as total_amount
FROM task_costs tc
JOIN cost_categories cc ON tc.category_id = cc.id
JOIN task_pool tp ON tc.task_id = tp.id
JOIN orders o ON tp.order_id = o.id
WHERE o.order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY cc.name;

-- æ‹æ‘„æˆæœ¬å æ¯”
SELECT 
    SUM(CASE WHEN cc.name = 'æ‹æ‘„è´¹' THEN tc.amount ELSE 0 END) as filming_cost,
    SUM(CASE WHEN cc.name = 'æŠ•æ”¾è´¹' THEN tc.amount ELSE 0 END) as advertising_cost,
    SUM(tc.amount) as total_cost
FROM task_costs tc
JOIN cost_categories cc ON tc.category_id = cc.id;
```

#### 2.2 å®¢æˆ·çº§æˆæœ¬
```sql
-- æ¯ä¸ªå®¢æˆ·çš„æ€»æŠ•å…¥æˆæœ¬
SELECT 
    c.id as customer_id,
    c.shop_name,
    SUM(tc.amount) as total_cost,
    COUNT(DISTINCT o.id) as order_count
FROM customers c
JOIN orders o ON c.id = o.customer_id
JOIN task_pool tp ON o.id = tp.order_id
JOIN task_costs tc ON tp.id = tc.task_id
GROUP BY c.id;
```

### 3. åˆ©æ¶¦æŒ‡æ ‡

#### 3.1 æ¯›åˆ©æ¶¦
```sql
-- è®¢å•çº§æ¯›åˆ©æ¶¦
SELECT 
    o.id,
    o.order_number,
    o.contract_amount as sales,
    COALESCE(SUM(tc.amount), 0) as cost,
    o.contract_amount - COALESCE(SUM(tc.amount), 0) as gross_profit,
    CASE 
        WHEN o.contract_amount > 0 
        THEN ((o.contract_amount - COALESCE(SUM(tc.amount), 0)) / o.contract_amount * 100)
        ELSE 0 
    END as profit_margin
FROM orders o
LEFT JOIN task_pool tp ON o.id = tp.order_id
LEFT JOIN task_costs tc ON tp.id = tc.task_id
GROUP BY o.id;
```

#### 3.2 å®¢æˆ·çº§åˆ©æ¶¦
```sql
-- æ¯ä¸ªå®¢æˆ·çš„ç´¯è®¡åˆ©æ¶¦
SELECT 
    c.id as customer_id,
    c.shop_name,
    SUM(o.contract_amount) as total_sales,
    COALESCE(SUM(tc.amount), 0) as total_cost,
    SUM(o.contract_amount) - COALESCE(SUM(tc.amount), 0) as total_profit,
    CASE 
        WHEN SUM(o.contract_amount) > 0 
        THEN (SUM(o.contract_amount) - COALESCE(SUM(tc.amount), 0)) / SUM(o.contract_amount) * 100
        ELSE 0 
    END as profit_margin
FROM customers c
JOIN orders o ON c.id = o.customer_id
LEFT JOIN task_pool tp ON o.id = tp.order_id
LEFT JOIN task_costs tc ON tp.id = tc.task_id
GROUP BY c.id;
```

### 4. äººæ•ˆæŒ‡æ ‡

#### 4.1 äººå‡äº§å€¼
```sql
-- å›¢é˜Ÿäººå‡äº§å€¼
SELECT 
    team,
    SUM(contract_amount) as team_sales,
    COUNT(DISTINCT business_staff_id) as staff_count,
    SUM(contract_amount) / COUNT(DISTINCT business_staff_id) as per_capita_sales
FROM orders
WHERE order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY team;

-- ä¸ªäººäº§å€¼
SELECT 
    u.id,
    u.name,
    SUM(o.contract_amount) as personal_sales,
    COUNT(o.id) as order_count,
    SUM(o.contract_amount) / COUNT(o.id) as avg_order_amount
FROM users u
LEFT JOIN orders o ON u.id = o.business_staff_id 
    AND o.order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY u.id;
```

#### 4.2 äººå‡åˆ©æ¶¦
```sql
-- å›¢é˜Ÿäººå‡åˆ©æ¶¦
SELECT 
    team,
    SUM(o.contract_amount) - COALESCE(SUM(tc.amount), 0) as team_profit,
    COUNT(DISTINCT business_staff_id) as staff_count,
    (SUM(o.contract_amount) - COALESCE(SUM(tc.amount), 0)) / COUNT(DISTINCT business_staff_id) as per_capita_profit
FROM orders o
LEFT JOIN task_pool tp ON o.id = tp.order_id
LEFT JOIN task_costs tc ON tp.id = tc.task_id
WHERE o.order_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY team;
```

### 5. å®¢æˆ·ä»·å€¼æŒ‡æ ‡

#### 5.1 å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆLTVï¼‰
```sql
-- è®¡ç®—æ¯ä¸ªå®¢æˆ·çš„LTV
SELECT 
    c.id,
    c.shop_name,
    MIN(o.order_date) as first_order_date,
    MAX(o.order_date) as last_order_date,
    DATEDIFF(MAX(o.order_date), MIN(o.order_date)) as lifecycle_days,
    COUNT(o.id) as total_orders,
    SUM(o.contract_amount) as total_sales,
    AVG(o.contract_amount) as avg_order_amount,
    SUM(o.contract_amount) / NULLIF(DATEDIFF(MAX(o.order_date), MIN(o.order_date)), 0) * 365 as annualized_value
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY c.id;
```

#### 5.2 å®¢æˆ·æŠ•äº§æ¯”ï¼ˆROIï¼‰
```sql
-- å®¢æˆ·ROI = (æ€»é”€å”®é¢ - æ€»æˆæœ¬) / æ€»æˆæœ¬ * 100%
SELECT 
    c.id,
    c.shop_name,
    SUM(o.contract_amount) as total_sales,
    COALESCE(SUM(tc.amount), 0) as total_cost,
    CASE 
        WHEN COALESCE(SUM(tc.amount), 0) > 0 
        THEN (SUM(o.contract_amount) - COALESCE(SUM(tc.amount), 0)) / COALESCE(SUM(tc.amount), 0) * 100
        ELSE 0 
    END as roi_percentage
FROM customers c
JOIN orders o ON c.id = o.customer_id
LEFT JOIN task_pool tp ON o.id = tp.order_id
LEFT JOIN task_costs tc ON tp.id = tc.task_id
GROUP BY c.id;
```

---

## åŠŸèƒ½å¼€å‘æ¸…å•

### Phase 1: å›¢é˜Ÿç»´åº¦ç»Ÿè®¡ï¼ˆ2å‘¨ï¼‰

#### 1.1 å›¢é˜Ÿæ¦‚è§ˆä»ªè¡¨ç›˜
- [ ] å›¢é˜Ÿé”€å”®é¢è¶‹åŠ¿å›¾ï¼ˆæœˆåº¦/å­£åº¦ï¼‰
- [ ] å›¢é˜Ÿæˆæœ¬åˆ†æå›¾
- [ ] å›¢é˜Ÿåˆ©æ¶¦ç‡å¯¹æ¯”
- [ ] å›¢é˜Ÿäººæ•ˆæ’è¡Œæ¦œ

#### 1.2 å›¢é˜Ÿè¯¦ç»†æŠ¥è¡¨
- [ ] å›¢é˜ŸæœˆæŠ¥ç”Ÿæˆ
- [ ] å›¢é˜Ÿæˆå‘˜ä¸šç»©å¯¹æ¯”
- [ ] å›¢é˜Ÿå®¢æˆ·åˆ†å¸ƒ
- [ ] å›¢é˜Ÿè®¢å•åˆ†æ

### Phase 2: äººå‘˜ç»´åº¦ç»Ÿè®¡ï¼ˆ2å‘¨ï¼‰

#### 2.1 ä¸ªäººç»©æ•ˆä»ªè¡¨ç›˜
- [ ] ä¸ªäººé”€å”®é¢ç»Ÿè®¡
- [ ] ä¸ªäººå®¢æˆ·æ•°ç»Ÿè®¡
- [ ] ä¸ªäººç­¾å•æ•°å’Œæˆäº¤ç‡
- [ ] ä¸ªäººå®¢å•ä»·åˆ†æ

#### 2.2 äººæ•ˆåˆ†æ
- [ ] ä¸ªäººäººå‡äº§å€¼è®¡ç®—
- [ ] ä¸ªäººäººå‡åˆ©æ¶¦è®¡ç®—
- [ ] ä¸ªäººå·¥ä½œæ•ˆç‡åˆ†æï¼ˆä»»åŠ¡å®Œæˆç‡ï¼‰
- [ ] ä¸ªäººæˆé•¿æ›²çº¿ï¼ˆæœˆåº¦è¶‹åŠ¿ï¼‰

### Phase 3: å®¢æˆ·ç»´åº¦ç»Ÿè®¡ï¼ˆ2å‘¨ï¼‰

#### 3.1 å®¢æˆ·ä»·å€¼åˆ†æ
- [ ] å®¢æˆ·LTVè®¡ç®—
- [ ] å®¢æˆ·ROIè®¡ç®—
- [ ] å®¢æˆ·åˆ†çº§ï¼ˆA/B/Cçº§ï¼‰
- [ ] å®¢æˆ·ç”»åƒï¼ˆè¡Œä¸š/è§„æ¨¡/æ¶ˆè´¹ä¹ æƒ¯ï¼‰

#### 3.2 å®¢æˆ·æˆæœ¬åˆ†æ
- [ ] å•å®¢æˆ·æ€»æŠ•å…¥æˆæœ¬
- [ ] å•å®¢æˆ·æ€»åˆ©æ¶¦
- [ ] å®¢æˆ·ç›ˆäºåˆ†æ
- [ ] é«˜ä»·å€¼å®¢æˆ·è¯†åˆ«

### Phase 4: é¡¹ç›®ç»´åº¦ç»Ÿè®¡ï¼ˆ1å‘¨ï¼‰

#### 4.1 é¡¹ç›®ç»©æ•ˆåˆ†æ
- [ ] é¡¹ç›®é”€å”®é¢ç»Ÿè®¡
- [ ] é¡¹ç›®æˆæœ¬ç»Ÿè®¡
- [ ] é¡¹ç›®åˆ©æ¶¦ç‡
- [ ] é¡¹ç›®å‘¨æœŸåˆ†æ

#### 4.2 é¡¹ç›®äººæ•ˆ
- [ ] é¡¹ç›®å‚ä¸äººæ•°
- [ ] é¡¹ç›®äººå‡äº§å€¼
- [ ] é¡¹ç›®äººå‡åˆ©æ¶¦

### Phase 5: ç»¼åˆæŠ¥è¡¨ä¸é¢„æµ‹ï¼ˆ2å‘¨ï¼‰

#### 5.1 ç»¼åˆæŠ¥è¡¨
- [ ] å…¬å¸æœˆåº¦ç»è¥æŠ¥è¡¨
- [ ] å…¬å¸å­£åº¦æŠ¥è¡¨
- [ ] å¹´åº¦æ€»ç»“æŠ¥è¡¨
- [ ] å¯¹æ ‡åˆ†ææŠ¥è¡¨

#### 5.2 æ•°æ®å¯è§†åŒ–
- [ ] é”€å”®è¶‹åŠ¿é¢„æµ‹å›¾
- [ ] æˆæœ¬å æ¯”é¥¼å›¾
- [ ] äººæ•ˆå¯¹æ¯”æŸ±çŠ¶å›¾
- [ ] å®¢æˆ·ä»·å€¼æ•£ç‚¹å›¾

#### 5.3 æ•°æ®å¯¼å‡º
- [ ] ExcelæŠ¥è¡¨å¯¼å‡º
- [ ] PDFæŠ¥è¡¨å¯¼å‡º
- [ ] å›¾è¡¨å¯¼å‡ºï¼ˆPNG/SVGï¼‰

---

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®ç»Ÿè®¡è®¡ç®—å¼•æ“

```python
# backend/analytics_engine.py
class AnalyticsEngine:
    """ç»Ÿè®¡åˆ†æå¼•æ“"""
    
    def __init__(self, db_connection):
        self.db = db_connection
    
    def calculate_team_performance(self, team_id, start_date, end_date):
        """
        è®¡ç®—å›¢é˜Ÿç»©æ•ˆ
        
        è¿”å›:
        {
            'sales': æ€»é”€å”®é¢,
            'cost': æ€»æˆæœ¬,
            'profit': æ€»åˆ©æ¶¦,
            'profit_margin': åˆ©æ¶¦ç‡,
            'order_count': è®¢å•æ•°,
            'customer_count': å®¢æˆ·æ•°,
            'staff_count': äººå‘˜æ•°,
            'per_capita_sales': äººå‡é”€å”®é¢,
            'per_capita_profit': äººå‡åˆ©æ¶¦
        }
        """
        cursor = self.db.cursor()
        
        # é”€å”®æ•°æ®
        sql_sales = """
            SELECT 
                COUNT(DISTINCT o.id) as order_count,
                SUM(o.contract_amount) as total_sales,
                COUNT(DISTINCT o.customer_id) as customer_count,
                COUNT(DISTINCT o.business_staff_id) as staff_count
            FROM orders o
            WHERE o.team = %s
              AND o.order_date BETWEEN %s AND %s
              AND o.status != 'å·²å–æ¶ˆ'
        """
        cursor.execute(sql_sales, (team_id, start_date, end_date))
        sales_data = cursor.fetchone()
        
        # æˆæœ¬æ•°æ®
        sql_cost = """
            SELECT SUM(tc.amount) as total_cost
            FROM task_costs tc
            JOIN task_pool tp ON tc.task_id = tp.id
            JOIN orders o ON tp.order_id = o.id
            WHERE o.team = %s
              AND o.order_date BETWEEN %s AND %s
        """
        cursor.execute(sql_cost, (team_id, start_date, end_date))
        cost_data = cursor.fetchone()
        
        # è®¡ç®—æŒ‡æ ‡
        total_sales = sales_data['total_sales'] or 0
        total_cost = cost_data['total_cost'] or 0
        staff_count = sales_data['staff_count'] or 1
        
        result = {
            'sales': total_sales,
            'cost': total_cost,
            'profit': total_sales - total_cost,
            'profit_margin': ((total_sales - total_cost) / total_sales * 100) if total_sales > 0 else 0,
            'order_count': sales_data['order_count'],
            'customer_count': sales_data['customer_count'],
            'staff_count': staff_count,
            'per_capita_sales': total_sales / staff_count,
            'per_capita_profit': (total_sales - total_cost) / staff_count
        }
        
        cursor.close()
        return result
    
    def calculate_customer_ltv(self, customer_id):
        """è®¡ç®—å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼"""
        cursor = self.db.cursor()
        
        sql = """
            SELECT 
                c.id,
                c.shop_name,
                MIN(o.order_date) as first_order_date,
                MAX(o.order_date) as last_order_date,
                DATEDIFF(MAX(o.order_date), MIN(o.order_date)) as lifecycle_days,
                COUNT(o.id) as total_orders,
                SUM(o.contract_amount) as total_sales,
                AVG(o.contract_amount) as avg_order_amount
            FROM customers c
            JOIN orders o ON c.id = o.customer_id
            WHERE c.id = %s
            GROUP BY c.id
        """
        cursor.execute(sql, (customer_id,))
        data = cursor.fetchone()
        
        if not data:
            return None
        
        # è®¡ç®—å¹´åŒ–ä»·å€¼
        lifecycle_days = data['lifecycle_days'] or 1
        annualized_value = (data['total_sales'] / lifecycle_days) * 365 if lifecycle_days > 0 else 0
        
        result = {
            'customer_id': data['id'],
            'shop_name': data['shop_name'],
            'first_order_date': data['first_order_date'],
            'last_order_date': data['last_order_date'],
            'lifecycle_days': lifecycle_days,
            'total_orders': data['total_orders'],
            'total_sales': data['total_sales'],
            'avg_order_amount': data['avg_order_amount'],
            'annualized_value': annualized_value,
            'ltv': annualized_value * 3  # å‡è®¾å®¢æˆ·ç”Ÿå‘½å‘¨æœŸ3å¹´
        }
        
        cursor.close()
        return result
```

### 2. å®šæ—¶ç»Ÿè®¡ä»»åŠ¡

```python
# backend/cron_jobs.py
from apscheduler.schedulers.background import BackgroundScheduler

def daily_analytics_job():
    """æ¯æ—¥ç»Ÿè®¡ä»»åŠ¡"""
    print("æ‰§è¡Œæ¯æ—¥ç»Ÿè®¡...")
    
    # ç»Ÿè®¡æ˜¨æ—¥æ•°æ®
    yesterday = (datetime.now() - timedelta(days=1)).date()
    
    # 1. å›¢é˜Ÿç»Ÿè®¡
    teams = get_all_teams()
    for team in teams:
        calculate_and_save_team_analytics(team.id, yesterday, yesterday)
    
    # 2. äººå‘˜ç»Ÿè®¡
    users = get_all_users()
    for user in users:
        calculate_and_save_staff_performance(user.id, yesterday, yesterday)
    
    print("æ¯æ—¥ç»Ÿè®¡å®Œæˆ")

def monthly_analytics_job():
    """æ¯æœˆç»Ÿè®¡ä»»åŠ¡"""
    print("æ‰§è¡Œæ¯æœˆç»Ÿè®¡...")
    
    # ç»Ÿè®¡ä¸Šä¸ªæœˆæ•°æ®
    last_month = (datetime.now().replace(day=1) - timedelta(days=1))
    start_date = last_month.replace(day=1)
    end_date = last_month
    
    # ç”ŸæˆæœˆæŠ¥
    generate_monthly_report(start_date, end_date)
    
    print("æ¯æœˆç»Ÿè®¡å®Œæˆ")

# å¯åŠ¨å®šæ—¶ä»»åŠ¡
scheduler = BackgroundScheduler()
scheduler.add_job(daily_analytics_job, 'cron', hour=1, minute=0)  # æ¯å¤©å‡Œæ™¨1ç‚¹
scheduler.add_job(monthly_analytics_job, 'cron', day=1, hour=2, minute=0)  # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹
scheduler.start()
```

### 3. å‰ç«¯å¯è§†åŒ–

```javascript
// modules/analytics.js
class AnalyticsModule {
    /**
     * æ¸²æŸ“å›¢é˜Ÿç»©æ•ˆå¯¹æ¯”å›¾
     */
    async renderTeamPerformanceChart() {
        // è·å–æ•°æ®
        const response = await fetch('/api/analytics/team-performance?period=month');
        const data = await response.json();
        
        // ä½¿ç”¨Chart.jsæ¸²æŸ“æŸ±çŠ¶å›¾
        const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.teams.map(t => t.name),
                datasets: [
                    {
                        label: 'é”€å”®é¢',
                        data: data.teams.map(t => t.sales),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)'
                    },
                    {
                        label: 'åˆ©æ¶¦',
                        data: data.teams.map(t => t.profit),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'å›¢é˜Ÿç»©æ•ˆå¯¹æ¯”'
                    }
                }
            }
        });
    }
    
    /**
     * æ¸²æŸ“å®¢æˆ·ä»·å€¼æ•£ç‚¹å›¾
     */
    async renderCustomerValueScatter() {
        const response = await fetch('/api/analytics/customer-value');
        const data = await response.json();
        
        const ctx = document.getElementById('customerValueChart').getContext('2d');
        new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'å®¢æˆ·ä»·å€¼åˆ†å¸ƒ',
                    data: data.customers.map(c => ({
                        x: c.total_sales,  // Xè½´ï¼šæ€»é”€å”®é¢
                        y: c.total_profit  // Yè½´ï¼šæ€»åˆ©æ¶¦
                    })),
                    backgroundColor: 'rgba(255, 99, 132, 0.5)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'å®¢æˆ·ä»·å€¼åˆ†å¸ƒï¼ˆé”€å”®é¢ vs åˆ©æ¶¦ï¼‰'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'æ€»é”€å”®é¢ï¼ˆå…ƒï¼‰'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'æ€»åˆ©æ¶¦ï¼ˆå…ƒï¼‰'
                        }
                    }
                }
            }
        });
    }
}
```

---

## APIæ¥å£æ¸…å•

### 1. å›¢é˜Ÿç»Ÿè®¡API

```python
# GET /api/analytics/team/{team_id}/performance
# å‚æ•°: start_date, end_date
# è¿”å›: å›¢é˜Ÿç»©æ•ˆæ•°æ®

@app.route('/api/analytics/team/<int:team_id>/performance', methods=['GET'])
def get_team_performance(team_id):
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    
    engine = AnalyticsEngine(get_db_connection())
    result = engine.calculate_team_performance(team_id, start_date, end_date)
    
    return jsonify({'success': True, 'data': result})
```

### 2. äººå‘˜ç»©æ•ˆAPI

```python
# GET /api/analytics/staff/{user_id}/performance
# å‚æ•°: period_type, period_value
# è¿”å›: å‘˜å·¥ç»©æ•ˆæ•°æ®

@app.route('/api/analytics/staff/<int:user_id>/performance', methods=['GET'])
def get_staff_performance(user_id):
    period_type = request.args.get('period_type', 'month')
    period_value = request.args.get('period_value')
    
    # æŸ¥è¯¢ç»©æ•ˆè¡¨
    result = query_staff_performance(user_id, period_type, period_value)
    
    return jsonify({'success': True, 'data': result})
```

### 3. å®¢æˆ·ä»·å€¼API

```python
# GET /api/analytics/customer/{customer_id}/value
# è¿”å›: å®¢æˆ·LTVã€ROIç­‰æŒ‡æ ‡

@app.route('/api/analytics/customer/<int:customer_id>/value', methods=['GET'])
def get_customer_value(customer_id):
    engine = AnalyticsEngine(get_db_connection())
    
    ltv = engine.calculate_customer_ltv(customer_id)
    roi = engine.calculate_customer_roi(customer_id)
    
    return jsonify({
        'success': True,
        'data': {
            'ltv': ltv,
            'roi': roi
        }
    })
```

---

## æŠ¥è¡¨æ¨¡æ¿

### 1. æœˆåº¦ç»è¥æŠ¥è¡¨

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        XXå…¬å¸ 2026å¹´2æœˆ ç»è¥æœˆæŠ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¸€ã€é”€å”®æ¦‚å†µ
  - æ€»é”€å”®é¢: Â¥158,000
  - è®¢å•æ•°: 23å•
  - æ–°å¢å®¢æˆ·: 15å®¶
  - å¹³å‡å®¢å•ä»·: Â¥6,870

äºŒã€æˆæœ¬åˆ†æ
  - æ€»æˆæœ¬: Â¥95,000
  - æ‹æ‘„æˆæœ¬: Â¥45,000 (47.4%)
  - æŠ•æ”¾æˆæœ¬: Â¥38,000 (40.0%)
  - äººå‘˜æˆæœ¬: Â¥8,000 (8.4%)
  - å…¶ä»–æˆæœ¬: Â¥4,000 (4.2%)

ä¸‰ã€åˆ©æ¶¦æŒ‡æ ‡
  - æ¯›åˆ©æ¶¦: Â¥63,000
  - æ¯›åˆ©ç‡: 39.9%
  - å‡€åˆ©æ¶¦: Â¥55,000 (æ‰£é™¤ç®¡ç†è´¹ç”¨)

å››ã€å›¢é˜Ÿç»©æ•ˆ
  - å•†åŠ¡ä¸€ç»„: é”€å”®Â¥75,000, åˆ©æ¶¦Â¥32,000
  - å•†åŠ¡äºŒç»„: é”€å”®Â¥58,000, åˆ©æ¶¦Â¥20,000
  - å•†åŠ¡ä¸‰ç»„: é”€å”®Â¥25,000, åˆ©æ¶¦Â¥11,000

äº”ã€äººæ•ˆåˆ†æ
  - æ€»äººæ•°: 18äºº
  - äººå‡é”€å”®é¢: Â¥8,778
  - äººå‡åˆ©æ¶¦: Â¥3,500

å…­ã€TOPè¡¨ç°
  - é”€å”®å† å†›: å¼ ä¸‰ (Â¥35,000)
  - åˆ©æ¶¦å† å†›: æå›› (Â¥18,000)
  - ç­¾å•å† å†›: ç‹äº” (8å•)
```

---

**å¼€å‘å‘¨æœŸ**: 9å‘¨  
**é¢„è®¡ä¸Šçº¿**: 2026å¹´4æœˆ  
**ä¸‹ä¸€æ­¥**: ä¸æƒé™ç³»ç»Ÿå¹¶è¡Œå¼€å‘ï¼Œä¼˜å…ˆå®Œæˆå›¢é˜Ÿå’Œäººå‘˜ç»Ÿè®¡åŠŸèƒ½
