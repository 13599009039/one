# ERP系统 - 物流模块 & 电子面单 & ISV服务商 说明文档

**文档版本**: v1.0  
**更新日期**: 2026-02-16  
**系统域名**: erp.xnamb.cn (业务端) / super.xnamb.cn (控制端)

---

## 1. 系统概述

### 1.1 系统定位
- **系统名称**: 企业资源计划管理系统（ERP）
- **系统角色**: 我方为SaaS多租户ERP软件服务商
- **服务模式**: B2B2C（我方→租户商家→终端用户）

### 1.2 系统端说明

#### **控制端** (super.xnamb.cn/console.html)
- **使用对象**: 我方内部平台管理员
- **主要用途**:
  - ISV服务商配置管理（AppKey/AppSecret/回调地址）
  - 租户账号管理（创建、禁用、权限分配）
  - 物流服务商全局配置（菜鸟ISV/快递100平台）
  - 系统级监控与日志查询
- **权限级别**: 最高权限（platform_admin）

#### **业务端** (erp.xnamb.cn/financial_system.html)
- **使用对象**: 租户商家（购买系统的客户）
- **主要用途**:
  - 订单管理（创建、编辑、收款、发货）
  - 电子面单获取与打印
  - 物流轨迹查询
  - 财务流水账管理
- **权限级别**: 租户隔离权限（tenant_user）

---

## 2. 物流模块功能范围

### 2.1 已实现物流能力

| 功能模块 | 实现状态 | 说明 |
|---------|---------|------|
| **电子面单获取** | ✅ 已实现 | 支持菜鸟ISV、快递100两个平台 |
| **物流轨迹查询** | ✅ 已实现 | 支持快递100实时查询（菜鸟待开发） |
| **面单打印** | ✅ 已实现 | 支持单个打印、批量打印、订单列表打印、订单详情打印 |
| **面单取消** | ✅ 已实现 | 回收运单号（菜鸟/快递100均支持） |
| **发货确认** | ✅ 已实现 | 菜鸟平台发货确认 |
| **打印日志** | ✅ 已实现 | 记录打印历史、状态、失败原因 |
| **多网点支持** | ✅ 已实现 | 同一快递公司可绑定多个网点/分部 |

### 2.2 电子面单能力

#### **菜鸟ISV平台**
- **API版本**: 生产环境 (https://link.cainiao.com)
- **签名算法**: HMAC-MD5
- **支持功能**:
  - 电子面单获取（单个/批量）
  - 面单取消（回收运单号）
  - 发货确认
  - 打印数据获取
  - 物流轨迹查询（API已封装，待联调）

#### **快递100平台**
- **API版本**: 生产环境 (https://poll.kuaidi100.com)
- **签名算法**: MD5(param + auth_key + customer)
- **支持功能**:
  - 电子面单下单
  - 物流轨迹实时查询
  - 订单列表管理

### 2.3 支持快递公司/ISV服务商

| 服务商 | 类型 | 状态 | 支持快递 |
|--------|------|------|---------|
| **菜鸟ISV** | ISV平台 | ✅ 已对接 | 中通、圆通、韵达、顺丰、申通、百世、京东、EMS |
| **快递100** | 第三方平台 | ✅ 已对接 | 全部主流快递公司 |

---

## 3. ISV服务商对接说明

### 3.1 菜鸟ISV

#### 基本信息
- **ISV名称**: 菜鸟网络科技有限公司
- **应用名称**: 企业资源计划管理
- **对接方式**: OAuth2.0授权 + HMAC-MD5签名

#### 我方配置信息（已脱敏）
```
AppKey: 508425
AppSecret: X44n3jD3948rC***（32位）
签名算法: HMAC-MD5
生产环境: https://link.cainiao.com
回调地址: https://super.xnamb.cn/api/cainiao_isv/auth/callback
配置状态: ✅ 已验证通过（2026-02-16）
```

#### 接口能力
| 接口 | 能力 | 实现状态 |
|------|------|---------|
| `/waybill/get` | 单个面单获取 | ✅ 已实现 |
| `/waybill/batch/get` | 批量面单获取 | ✅ 已实现 |
| `/waybill/cancel` | 面单取消 | ✅ 已实现 |
| `/waybill/confirm` | 发货确认 | ✅ 已实现 |
| `/waybill/print/get` | 打印数据获取 | ✅ 已实现 |
| `/logistics/query` | 物流轨迹查询 | ✅ 已封装 |
| `/oauth/authorize` | 授权链接生成 | ✅ 已实现 |
| `/oauth/token` | 授权码换Token | ✅ 已实现 |

### 3.2 快递100

#### 基本信息
- **平台名称**: 快递100物流查询平台
- **对接方式**: API密钥签名（MD5）

#### 我方配置信息（已脱敏）
```
授权Key: jXWdDXyF6438
Customer: 009A68478C3C***（32位）
Secret: 0a305c5b2275***（32位）
Userid: 8a26b8a9c80b***（32位）
智能判断: jXWdDXyF6438
产品: 电子面单（已开通，实时扣费）
配置状态: ✅ 已验证通过
```

#### 接口能力
| 接口 | 能力 | 实现状态 |
|------|------|---------|
| `/poll/query.do` | 物流轨迹查询 | ✅ 已实现 |
| `/order/create` | 电子面单下单 | ✅ 已实现 |
| `/orders` | 订单列表查询 | ✅ 已实现 |

---

## 4. 账号体系与授权绑定

### 4.1 账号归属

#### **菜鸟ISV模式**
- **物流账号归属**: 租户自行申请
- **账号主体**: 租户公司（需工商注册信息）
- **面单费用**: 租户自行与快递公司结算
- **ISV授权主体**: 我方（ISV服务商）

**说明**:
- 我方作为菜鸟ISV服务商，提供技术对接能力
- 租户需自行与快递公司签约，获取快递客户编码（partner_id）
- 租户通过我方系统完成菜鸟授权后，可使用电子面单功能
- **我方不参与运费结算、不托管面单余额、不收取额外费用**

#### **快递100模式**
- **物流账号归属**: 我方统一申请
- **账号主体**: 我方公司
- **费用模式**: 我方账户扣费（需转嫁给租户或包含在服务费中）

### 4.2 菜鸟ISV当前绑定流程

#### 前置条件
1. 租户已与快递公司签约（如：中通快递北京一部）
2. 获取快递客户编码（partner_id）、账号、密码等信息

#### 绑定步骤
1. **控制端操作（平台管理员）**:
   - 进入 super.xnamb.cn
   - 物流服务商配置中心 → 菜鸟
   - 创建租户记录（租户名称、联系人、电话）

2. **控制端操作（平台管理员）**:
   - 选择租户
   - 添加仓库（如：北京仓、上海仓）
   - 添加物流账号：
     - 快递公司：中通快递（ZTO）
     - 网点名称：北京一部
     - 客户编码：（填写快递公司提供的partner_id）
     - 账号/密码：（填写快递公司提供的凭证）

3. **完成菜鸟授权**:
   - 点击物流账号列表中的"授权"按钮
   - 跳转到菜鸟授权页面（需使用租户企业支付宝账号登录）
   - 授权成功后自动回调系统，保存auth_token

4. **测试获取面单**:
   - 进入"订单下单"面板
   - 填写收件人/寄件人信息
   - 选择物流账号（如：中通快递 - 北京一部）
   - 提交获取面单

### 4.3 绑定入口现状

#### 当前入口位置
- **控制端**: super.xnamb.cn → 物流服务商配置中心 → 菜鸟标签页
- **业务端**: ❌ 无（租户无法自主绑定）

#### 存在问题
1. **租户依赖平台管理员**:
   - 租户无法自主添加物流账号
   - 每次新增网点都需要联系我方操作
   - 效率低、体验差

2. **授权流程复杂**:
   - 需要平台管理员协助完成授权
   - 租户需提供企业支付宝账号给我方操作
   - 存在账号安全风险

3. **权限混乱**:
   - 控制端既有平台配置又有租户数据
   - 职责不清晰

---

## 5. 控制端与业务端职责划分

### 5.1 控制端（我方 - platform_admin）

#### 可操作
✅ **ISV服务商全局配置**:
- 菜鸟ISV AppKey/AppSecret配置
- 快递100 授权密钥配置
- 回调地址配置
- 环境切换（测试/生产）

✅ **租户管理**:
- 创建/禁用租户账号
- 查看租户列表
- 租户权限分配

✅ **全局监控**:
- 查看所有租户的面单记录
- 查看打印日志
- API调用日志查询

#### 不可操作
❌ **租户业务数据**:
- 不应直接编辑租户订单
- 不应管理租户客户信息
- 不应操作租户财务数据

#### 权限
- 数据库表：cainiao_isv_config（ISV配置）、tenant（租户表）
- API权限：require_platform_admin 装饰器
- Session标识：user_type = 'platform_admin'

### 5.2 业务端（租户 - tenant_user）

#### 可操作
✅ **订单管理**:
- 创建订单
- 编辑订单（收款、服务项目）
- 订单发货

✅ **电子面单**:
- 查看已获取的面单
- 打印面单（单个/批量）
- 取消面单
- 查询物流轨迹

✅ **财务管理**:
- 查看流水账
- 登记收款
- 查看统计报表

#### 不可操作（当前限制）
❌ **物流账号管理**:
- 无法自主添加物流账号
- 无法编辑网点信息
- 无法完成菜鸟授权

❌ **仓库管理**:
- 无法创建发货仓库
- 无法设置发货地址

#### 权限
- 数据库表：按tenant_id隔离
- API权限：require_tenant_auth 装饰器
- Session标识：user_type = 'tenant_user', tenant_id

---

## 6. 现有问题与痛点

### 6.1 权限与职责问题

#### 问题1：租户无法自主管理物流账号
**现象**:
- 租户新增网点需联系我方操作
- 租户无法查看自己的物流账号列表
- 租户无法完成菜鸟授权（需我方代操作）

**影响**:
- 租户体验差
- 我方运维成本高
- 授权流程存在安全风险（需租户提供企业支付宝账号）

**建议方案**:
- 在业务端增加"物流配置"模块
- 租户可自主添加物流账号
- 授权链接直接推送给租户操作

---

### 6.2 菜鸟ISV多租户架构问题

#### 问题2：控制端职责过重
**现象**:
- 控制端既管理ISV全局配置，又管理租户物流账号
- 租户数据（tenant、warehouse、logistics_account）混在控制端

**影响**:
- 职责不清晰
- 租户数据暴露给平台管理员
- 扩展性差

**建议方案**:
- 控制端只保留ISV配置管理
- 租户相关功能迁移到业务端
- 数据按tenant_id严格隔离

---

### 6.3 授权流程问题

#### 问题3：菜鸟授权需企业支付宝登录
**现象**:
- 授权链接跳转到菜鸟授权页面
- 需要使用租户企业支付宝账号登录
- 当前由平台管理员代操作

**影响**:
- 租户需提供支付宝账号密码（安全风险）
- 平台管理员工作量大
- 授权失败率高（账号不匹配）

**建议方案**:
- 授权链接直接发送给租户
- 租户自主完成授权
- 授权成功后自动回调系统

---

### 6.4 快递100与菜鸟ISV功能差异

#### 问题4：两个平台功能不一致
**快递100**:
- ✅ 有功能操作面板（物流查询/下单/订单列表）
- ✅ 面板在控制端 console.html 中
- ✅ 独立的前端JS逻辑

**菜鸟ISV**:
- ❌ 无功能操作面板
- ❌ 只有配置界面和租户管理
- ❌ 实际使用需通过API直接调用

**影响**:
- 功能入口不统一
- 用户体验不一致
- 测试困难（快递100可直接测试，菜鸟需写代码）

**建议方案**:
- 参考快递100，为菜鸟ISV开发功能操作面板
- 统一两个平台的交互逻辑

---

### 6.5 打印组件问题

#### 问题5：本地打印组件未部署
**现象**:
- 菜鸟云打印组件需本地安装（ws://localhost:13000）
- 当前未提供安装包和部署文档
- 打印功能无法真实测试

**影响**:
- 面单获取后无法打印
- 功能链路不完整

**建议方案**:
- 提供菜鸟云打印组件安装包
- 编写部署文档
- 测试打印功能

---

### 6.6 数据库设计问题

#### 问题6：tenant表未关联company表
**现象**:
- 现有company表（租户公司信息）
- 新增tenant表（菜鸟ISV租户）
- 两者未关联，可能重复创建租户

**影响**:
- 数据冗余
- 租户信息不一致
- 难以统一管理

**建议方案**:
- 复用现有company表
- 或建立tenant与company的关联关系

---

## 7. 技术实现细节

### 7.1 后端架构

#### 文件结构
```
/root/ajkuaiji/backend/
├── app.py                          # Flask主应用
├── cainiao_isv_service.py          # 菜鸟API封装
├── cainiao_isv_api.py              # 菜鸟接口Blueprint
├── platform_kuaidi100_service.py   # 快递100 API封装
├── platform_kuaidi100_api.py       # 快递100接口Blueprint
└── sql/
    ├── init_cainiao_isv_full.sql   # 菜鸟数据表
    └── init_platform_kuaidi100.sql # 快递100数据表
```

#### API路由
```
菜鸟ISV: /api/cainiao_isv/*
快递100: /api/platform/kuaidi100/*
```

### 7.2 前端架构

#### 文件结构
```
/root/ajkuaiji/
├── console.html          # 控制端（含菜鸟ISV配置界面）
├── financial_system.html # 业务端
└── js/
    └── console.js        # 控制端JS（含菜鸟ISV功能）
```

#### 菜鸟ISV前端功能
- loadCainiaoISVConfig() - 加载ISV配置
- loadCainiaoTenants() - 加载租户列表
- loadCainiaoLogisticsAccounts() - 加载物流账号
- getCainiaoAuthUrl() - 获取授权链接
- switchCainiaoTab() - 切换功能标签页

### 7.3 数据库表结构

#### 菜鸟ISV相关表（7张）
```sql
cainiao_isv_config          -- ISV配置表
tenant                      -- 租户表
tenant_warehouse            -- 仓库表
tenant_logistics_account    -- 物流账号表（支持多网点）
tenant_shipping_address     -- 发货地址表
waybill_record              -- 面单记录表
print_log                   -- 打印日志表
```

#### 快递100相关表（3张）
```sql
platform_kuaidi100_config   -- 快递100配置表
platform_kuaidi100_orders   -- 快递100订单表
platform_kuaidi100_logs     -- 快递100日志表
```

---

## 8. 后续优化建议

### 8.1 短期优化（P0）

1. **业务端增加物流配置模块**
   - 租户可自主添加物流账号
   - 租户可自主完成菜鸟授权
   - 租户可查看自己的面单记录

2. **菜鸟ISV功能操作面板**
   - 参考快递100布局
   - 支持订单下单、面单列表、打印管理

3. **统一权限体系**
   - 明确控制端/业务端职责
   - 数据按tenant_id严格隔离

### 8.2 中期优化（P1）

1. **打印组件部署**
   - 提供菜鸟云打印组件安装包
   - 编写部署文档

2. **租户自助授权**
   - 授权链接推送给租户
   - 租户自主完成授权

3. **多租户数据隔离增强**
   - 所有API增加tenant_id验证
   - 敏感数据加密存储

### 8.3 长期优化（P2）

1. **多ISV服务商支持**
   - 支持同时对接多个ISV
   - 租户可选择使用的ISV

2. **面单费用管理**
   - 记录面单使用量
   - 费用统计与报表

3. **物流轨迹推送**
   - 接收快递公司回调
   - 实时推送物流状态

---

## 9. 测试验证记录

### 9.1 菜鸟ISV验证（2026-02-16）

**验证结果**:
```
✅ ISV配置：已保存到数据库
✅ 签名算法：HMAC-MD5验证通过
✅ 授权链接：生成测试通过
✅ API连接：生产环境可正常访问
```

**待验证**:
- ⚠️ 电子面单获取（需完成物流账号授权）
- ⚠️ 打印功能（需部署打印组件）

### 9.2 快递100验证

**验证结果**:
```
✅ API配置：已验证通过
✅ 物流查询：功能正常
✅ 功能面板：已开发完成
```

---

## 10. 联系与支持

- **系统域名**: https://erp.xnamb.cn / https://super.xnamb.cn
- **文档版本**: v1.0
- **更新日期**: 2026-02-16
- **维护团队**: ERP系统开发团队

---

## 11. 界面详细设计规范

### 11.1 控制端（super.xnamb.cn/console.html）物流界面

#### 11.1.1 ISV服务商全局配置页

**页面路径**: `super.xnamb.cn/console.html` → 左侧导航「物流服务商配置中心」→ 顶部标签页切换

**整体布局**:
- 顶部：标签页切换（菜鸟ISV / 快递100 / 京东物流）
- ISV服务商配置区域（紫色背景边框提示）
  - AppKey / AppSecret（必填，输入框）
  - 回调地址 / 环境选择（下拉框）
  - 按钮：加载配置 / 保存ISV配置
- 租户管理区域
  - 新增租户按钮
  - 租户列表（租户名/联系人/电话/状态/操作）
- 当前租户：未选择 [仓库管理] [物流账号管理]
- 电子面单功能操作面板（三标签页）
  - 订单下单 / 面单列表 / 打印管理

**配置字段详情**:
| 字段名称 | 类型 | 必填 | 控件类型 | 说明 |
|---------|------|------|---------|------|
| AppKey | 文本 | ✅ | input[type=text] | 菜鸟ISV应用密钥 |
| AppSecret | 密文 | ✅ | input[type=password] | ISV应用密钥 |
| 授权回调地址 | URL | ⚠️ | input[type=text] | 默认值 |
| 环境 | 枚举 | ✅ | select | 生产环境/测试环境 |

**存在问题** (P0):
- ❌ 缺少「测试连接」按钮，无法验证配置正确性
- ❌ AppSecret明文存储，需加密
- ⚠️ 回调地址硬编码，应支持自定义

---

#### 11.1.2 租户物流账号管理页

**页面路径**: 同ISV配置页 → 向下滚动至「租户管理区域」

**核心功能**:
- 📋 租户管理：新增租户、租户列表（租户名/联系人/电话/状态/操作）
- 🏭 仓库列表：仓库名称/联系人/地址/默认/操作
- 🚚 物流账号管理（支持多网点）：
  - 快递公司 / 网点分部 / 客户编码 / 仓库 / 状态 / 操作
  - **核心字段**：branch_name（网点/分部名称）- 区分多网点

**物流账号列表展示字段**:
| 字段 | 来源 | 展示格式 | 关键逻辑 |
|------|------|---------|----------|
| 快递公司 | cp_name | 中通快递 (ZTO) | - |
| 网点/分部 | branch_name | 文本 | **核心字段**，区分多网点 |
| 客户编码 | partner_id | 1234*** | 部分隐藏 |
| 授权状态 | auth_token | 已授权✅/未授权⚠️ | 动态显示 |

**新增物流账号弹窗表单**（必传项）:
- ✅ 快递公司编码 (cp_code)
- ✅ 快递名称 (cp_name)
- ⚠️ 网点名称 (branch_name) - 非必填但强烈推荐

**存在问题** (P0):
- ❌ 租户数据混在控制端，应迁移到业务端
- ❌ 授权需平台管理员代操作，应由租户自主完成
- ⚠️ 缺少批量导入物流账号功能

---

#### 11.1.3 全局物流日志监控页

**当前状态**: ❌ **未实现**（P1优化项）

**规划页面路径**: `super.xnamb.cn/console.html` → 左侧导航「物流日志监控」

**规划布局**:
- 📊 物流日志监控
- 筛选条件区：时间范围/租户/服务商/操作/状态 [查询][重置]
- 日志列表区（表格） [刷新] [导出CSV]
  - 时间 | 租户 | 服务商 | 接口 | 请求参数 | 响应结果 | 操作

**规划筛选条件**:
- 时间范围：默认今天，可选昨天/最近7天/最近30天/自定义
- 租户：下拉所有租户，支持搜索
- 服务商：菜鸟ISV/快递100/全部
- 操作类型：获取面单/查询轨迹/打印/取消/全部
- 状态：成功/失败/超时/全部

**优先级**: P1（中期优化）

---

#### 11.1.4 快递100功能操作面板

**页面路径**: `super.xnamb.cn/console.html` → 物流服务商配置中心 → [快递100] 标签页 → 向下滚动

**布局结构**（三标签页）:
1. **物流查询面板**：快递公司下拉 + 单号输入 + 查询按钮 → 查询结果时间线
2. **电子面单下单面板**：收件人信息 + 寄件人信息 + 订单号 + 物流账号 → [获取面单]
3. **订单列表面板**：筛选（全部/未打印/已打印）→ 订单列表（订单号/运单号/快递/收件人/状态/操作）

**核心功能按钮**:
| 按钮 | 位置 | 功能 | API |
|------|------|------|-----|
| 查询 | 物流查询面板 | 查询运单轨迹 | POST /api/platform/kuaidi100/query |
| 获取面单 | 下单面板 | 创建电子面单 | POST /api/platform/kuaidi100/order/create |
| 打印 | 订单列表 | 单个打印 | POST /api/platform/kuaidi100/print/single |
| 取消 | 订单列表 | 取消订单 | POST /api/platform/kuaidi100/order/cancel |

**存在问题**:
- ✅ 功能完整（无明显问题）
- ⚠️ 缺少批量取消功能

---

### 11.2 业务端（erp.xnamb.cn/financial_system.html）物流界面

#### 11.2.1 现有物流功能界面

##### A. 电子面单打印页

**当前状态**: ❌ **未实现**（业务端完全缺失电子面单功能）

**触发方式** (规划):
1. **订单列表触发**：订单管理 → 订单列表 → 勾选订单 → 点击「批量打印面单」→ 弹窗：批量打印配置
2. **订单详情触发**：订单详情页 → 右上角「打印面单」按钮 → 弹窗：单个打印配置

**打印配置弹窗** (规划):
- 订单：[显示订单号]
- 快递公司：[下拉选择]
- 网点/分部：[联动下拉]
- 收件人信息：[自动回填订单收货信息]
- 寄件人信息：[自动回填默认发货地址]
- 打印机：[下拉选择本地打印机]
- 纸张大小：[A4 / 10x10cm / 自定义]
- ☐ 打印后自动发货
- [取消] [获取并打印]

**优先级**: **P0** (核心功能缺失)

---

##### B. 物流轨迹查询页

**当前状态**: ❌ **未实现**

**规划路径**: 订单详情页 → 「物流信息」标签页

**规划布局**:
- 物流信息
- 快递公司：中通快递
- 运单号：YT1234567890 [复制] [刷新]
- 物流轨迹（时间轴样式）：
  - ● 2024-01-01 10:00 已签收【北京市】
  - ○ 2024-01-01 08:00 派送中
  - ○ 2023-12-31 20:00 到达北京分拨中心
  - ○ 2023-12-31 15:00 已发货
- 最后更新：2024-01-01 10:05

**优先级**: P1

---

##### C. 面单/打印日志页

**当前状态**: ❌ **未实现**

**规划路径**: 订单管理 → 电子面单管理

**规划布局**:
- 电子面单管理 [刷新] [导出]
- 筛选：时间[___] 状态[未打印/已打印] 快递[___] [查询]
- 列表：订单号 | 运单号 | 快递 | 收件人 | 打印状态 | 打印时间 | 操作

**优先级**: P1

---

#### 11.2.2 缺失但需新增的物流配置界面

##### A. 物流账号管理页

**当前状态**: ❌ **完全缺失**（**P0核心功能**）

**规划路径**: `erp.xnamb.cn/financial_system.html` → 左侧导航新增「物流配置」

**期望布局**:
- 物流账号管理 [+ 新增物流账号]
- 我的物流账号列表：
  - 快递 | 网点/分部 | 客户编码 | 授权状态 | 状态 | 操作
  - 中通 | 北京一部 | 1234*** | ✅已授权 | ✅启用 | [编辑]
  - 中通 | 上海分部 | 5678*** | ⚠️未授权 | ✅启用 | [授权]
  - 圆通 | 默认网点 | 9012*** | ❌已过期 | ✅启用 | [重新授权]

**授权说明**:
- ● 首次使用菜鸟ISV服务需要授权
- ● 点击「授权」将跳转到菜鸟授权页面
- ● 使用您的企业支付宝账号完成授权

**展示字段**:
| 字段 | 说明 | 重要性 |
|------|------|--------|
| 快递公司 | 显示快递名称+编码 | P0 |
| 网点/分部 | **支持多网点的核心字段** | P0 |
| 客户编码 | 部分隐藏（前4位+***） | P1 |
| 授权状态 | 已授权✅/未授权⚠️/已过期❌ | P0 |

**操作按钮**:
| 按钮 | 触发条件 | 功能 | 跳转逻辑 |
|------|---------|------|----------|
| 新增物流账号 | 任何时候 | 打开新增弹窗 | 模态框 |
| 授权 | 未授权状态 | 生成授权链接 | **新窗口打开菜鸟授权页** |
| 重新授权 | 已过期状态 | 重新生成授权链接 | 同上 |
| 编辑 | 已授权状态 | 编辑网点信息 | 模态框 |
| 解绑 | 任何时候 | 删除物流账号 | 二次确认弹窗 |

**优先级**: **P0**（核心重构项）

---

##### B. 仓库/发货地址管理页

**当前状态**: ❌ **完全缺失**

**规划路径**: 物流配置 → [发货地址管理] 标签页

**期望布局**:
- 发货地址管理 [+ 新增发货地址]
- ☑️ 支持多仓库/多地址
- 地址列表：地址名称 | 联系人 | 联系电话 | 默认 | 操作
  - 北京仓 | 张三 | 138*** | ✅默认 | [编辑] [删除]
  - 上海仓 | 李四 | 139*** | | [设为默认] [编辑]

**表单字段**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 地址名称 | 文本 | ✅ | 如"北京仓""公司总部" |
| 联系人 | 文本 | ✅ | 寄件人姓名 |
| 联系电话 | 手机 | ✅ | 11位手机号 |
| 省市区 | 级联选择 | ✅ | 三级联动 |
| 详细地址 | 文本域 | ✅ | - |
| 设为默认 | 开关 | - | 开启后其他地址自动取消默认 |

**优先级**: P0

---

##### C. 菜鸟ISV授权页

**当前状态**: ❌ **未实现**（授权流程缺失）

**授权链接展示方式** (推荐方案):

**方式1：直接跳转**（推荐）
```javascript
// 点击授权按钮
1. 调用API生成授权链接
2. window.open(授权URL, '_blank')
3. 提示：「请在新窗口完成授权，授权成功后自动关闭」
```

**授权状态提示**:
| 状态 | 提示内容 | 样式 |
|------|---------|------|
| 授权中 | 「正在跳转到菜鸟授权页面...」 | 黄色Toast + loading |
| 授权成功 | 「授权成功！物流账号已可用」 | 绿色Toast |
| 授权失败 | 「授权失败：{错误原因}」+ 重试按钮 | 红色Toast |
| 未完成授权 | 「检测到您未完成授权，请重新授权」 | 橙色警告框 |

**优先级**: **P0**

---

#### 11.2.3 订单模块与物流的联动界面

##### A. 订单创建/编辑页

**物流相关字段展示位置**:
```
订单创建页
├─ 基本信息区
│   ├─ 客户信息
│   ├─ 服务项目
│   └─ 金额
├─ 📦 物流信息区（新增）
│   ├─ 发货仓库：[下拉选择] ← 来源：tenant_warehouse表
│   ├─ 快递公司：[下拉选择] ← 来源：logistics_account表（已授权的）
│   ├─ 网点/分部：[联动下拉] ← 根据快递公司筛选
│   └─ 💡 说明：选择后将在发货时自动获取面单
└─ [保存订单]
```

**联动逻辑**:
1. 选择快递公司（如：中通快递）
2. 自动加载该快递的所有网点（如：北京一部、上海分部）
3. 选择网点（如：北京一部）
4. 保存到订单的 logistics_account_id 字段

**优先级**: P0

---

##### B. 订单发货页

**面单获取触发方式**:

**方式1：订单列表批量发货**
```
订单列表 → 勾选多个订单 → [批量发货] 按钮
  ↓
弹窗：批量发货确认
  ├─ 显示订单数量
  ├─ ☑️ 自动获取电子面单
  ├─ ☑️ 获取后自动打印
  └─ [确认发货]
```

**方式2：订单详情单个发货**
```
订单详情页 → [发货] 按钮
  ↓
弹窗：发货确认
  ├─ 显示订单信息
  ├─ 快递公司：[下拉]（可修改）
  ├─ 网点：[联动下拉]（可修改）
  ├─ 收件人信息：[显示订单收货地址]
  ├─ 寄件人信息：[显示默认发货地址]
  ├─ ☑️ 获取电子面单
  ├─ ☑️ 获取后自动打印
  └─ [确认发货]
```

**发货确认后状态变更提示**:
```
成功：
┌─────────────────────────────────────────┐
│ ✅ 发货成功                               │
│                                           │
│ 订单号：12345                             │
│ 运单号：YT1234567890  [复制]             │
│ 快递公司：中通快递（北京一部）            │
│                                           │
│ 面单已自动打印，请检查打印机              │
│                                           │
│       [查看订单]  [继续发货]              │
└─────────────────────────────────────────┘
```

**优先级**: P0

---

### 11.3 跨端跳转/弹窗逻辑

#### 11.3.1 菜鸟ISV授权跳转流程

**完整流程图**:
```
业务端：物流账号管理
  ↓
点击[授权]按钮
  ↓
API: POST /api/cainiao_isv/auth/url
  ← 传参：{account_id: 5}
  → 返回：{auth_url: 'https://link.cainiao.com/oauth/...'}
  ↓
window.open(auth_url, '_blank')
  ↓
【新窗口】菜鸟授权页面
  ├─ 使用企业支付宝扫码登录
  ├─ 确认授权
  └─ 授权成功
  ↓
自动跳转回调地址：
https://super.xnamb.cn/api/cainiao_isv/auth/callback?code=AUTH_CODE&state=tenant_1_account_5
  ↓
后端处理回调：
  ├─ 解析state参数（tenant_id=1, account_id=5）
  ├─ 用code换取access_token
  ├─ 保存token到数据库
  └─ 返回成功页面
  ↓
【回调页面】显示成功提示 → 3秒后自动关闭 → 通知父窗口刷新
```

**优先级**: P0

---

#### 11.3.2 面单打印触发与反馈

**本地打印组件未部署时报错**:
```
┌─────────────────────────────────────────┐
│ ⚠️ 打印组件未运行                         │
│                                           │
│ 无法连接到本地打印服务：                  │
│ ws://localhost:13000                      │
│                                           │
│ 请先安装并启动菜鸟云打印组件：            │
│ 1. 下载安装包：[点击下载]                │
│ 2. 安装后自动启动                        │
│ 3. 确认右下角托盘图标显示"已连接"        │
│                                           │
│       [下载安装包]  [重试连接]            │
└─────────────────────────────────────────┘
```

**批量打印进度展示**:
```
┌─────────────────────────────────────────┐
│ 批量打印中...                             │
│                                           │
│ 进度：3 / 10                             │
│ [████████░░░░░░░░░] 30%                 │
│                                           │
│ 当前：YT1234567890 ✅                    │
│ 成功：2   失败：1                        │
│                                           │
│ 失败详情：                                │
│ • YT1234567891 - 打印机缺纸              │
│                                           │
│       [查看详情]  [取消]                  │
└─────────────────────────────────────────┘
```

**优先级**: P0

---

#### 11.3.3 多网点/多仓库切换逻辑

**快递公司与网点联动规则**:

```javascript
// 订单下单场景
1. 用户选择快递公司（如：中通快递）
   ↓
2. 前端调用API获取该快递的所有网点：
   GET /api/cainiao_isv/logistics_accounts
     ?tenant_id=1
     &cp_code=ZTO
     &status=1
     &auth_status=authorized
   ↓
3. 返回网点列表：
   [
     {id: 1, branch_name: '北京一部', partner_id: '1234***'},
     {id: 2, branch_name: '上海分部', partner_id: '5678***'}
   ]
   ↓
4. 渲染到下拉框：
   <option value="1">北京一部</option>
   <option value="2">上海分部</option>
   ↓
5. 用户选择网点（如：北京一部）
   ↓
6. 保存 logistics_account_id = 1
```

**优先级**: P0

---

### 11.4 界面交互细节

#### 11.4.1 权限控制

**控制端（platform_admin）**:
| 按钮/功能 | 可见性 | 说明 |
|----------|--------|------|
| ISV配置保存 | ✅ 所有管理员 | 平台配置权限 |
| 创建租户 | ✅ 所有管理员 | - |
| 查看所有租户数据 | ✅ 所有管理员 | - |
| 编辑租户订单 | ❌ 禁止 | 职责分离原则 |

**业务端（tenant_user）**:
| 按钮/功能 | 可见性 | 说明 |
|----------|--------|------|
| 新增物流账号 | ✅ 租户管理员 | role = 'admin' |
| 编辑物流账号 | ✅ 租户管理员 | - |
| 授权物流账号 | ✅ 租户管理员 | - |
| 查看物流账号 | ✅ 所有用户 | role = 'user' / 'admin' |
| 打印面单 | ✅ 所有用户 | - |
| 取消面单 | ✅ 租户管理员 | 防止误操作 |

**优先级**: P1

---

#### 11.4.2 关键操作二次确认

**需要二次确认的操作**:
| 操作 | 确认文案 | 按钮 | 优先级 |
|------|---------|------|--------|
| 取消面单 | 「确认取消面单吗？取消后运单号将被回收，此操作不可恢复。」 | [取消][确认] | P0 |
| 解绑物流账号 | 「确认解绑该物流账号吗？解绑后将无法使用该账号下单，历史面单不受影响。」 | [取消][确认解绑] | P0 |
| 删除仓库 | 「确认删除该仓库吗？删除后关联的发货地址将失效。」 | [取消][确认删除] | P1 |
| 批量打印 | 「确认批量打印 {count} 个面单吗？」 | [取消][确认打印] | P1 |

**优先级**: P0

---

## 12. 界面优化建议汇总

### 12.1 P0核心问题（必须解决）

1. **业务端完全缺失电子面单功能** ⭐⭐⭐⭐⭐
   - 影响：租户无法使用核心物流功能
   - 解决：开发业务端物流账号管理、面单打印、发货地址管理页面

2. **租户无法自主管理物流账号** ⭐⭐⭐⭐⭐
   - 影响：运维成本高、授权流程存在安全风险
   - 解决：将物流账号管理功能从控制端迁移到业务端

3. **授权流程需平台代操作** ⭐⭐⭐⭐
   - 影响：效率低、需提供企业支付宝账号
   - 解决：授权链接直接推送给租户，租户自主完成

### 12.2 P1重要优化（建议实施）

1. **缺少物流日志监控** ⭐⭐⭐
   - 影响：问题排查困难
   - 解决：开发全局物流日志监控页

2. **缺少打印组件部署文档** ⭐⭐⭐
   - 影响：打印功能无法测试
   - 解决：提供菜鸟云打印组件安装包和部署文档

3. **AppSecret明文存储** ⭐⭐
   - 影响：安全风险
   - 解决：加密存储敏感信息

---

**文档结束**
