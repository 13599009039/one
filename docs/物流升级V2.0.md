# ERPç³»ç»Ÿ - ç‰©æµæ¨¡å—å‡çº§V2.0å®Œæ•´æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-16  
**å‡çº§ç›®æ ‡**: ç§Ÿæˆ·è‡ªä¸»åŒ– + åŠŸèƒ½å®Œæ•´åŒ– + ä½“éªŒä¼˜åŒ–  
**ç³»ç»ŸåŸŸå**: erp.xnamb.cn (ä¸šåŠ¡ç«¯) / super.xnamb.cn (æ§åˆ¶ç«¯)

---

## ä¸€ã€å‡çº§èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 å½“å‰ç—›ç‚¹åˆ†æ

#### æ ¸å¿ƒé—®é¢˜
1. **ä¸šåŠ¡ç«¯åŠŸèƒ½ç¼ºå¤±** â­â­â­â­â­
   - ç§Ÿæˆ·æ— æ³•è‡ªä¸»ç®¡ç†ç‰©æµè´¦å·
   - æ— ç‰©æµé…ç½®å…¥å£ï¼ˆéœ€ä¾èµ–å¹³å°ç®¡ç†å‘˜ï¼‰
   - ç¼ºå°‘ç”µå­é¢å•æ‰“å°åŠŸèƒ½
   - ç¼ºå°‘å‘è´§åœ°å€ç®¡ç†

2. **æˆæƒæµç¨‹å¤æ‚** â­â­â­â­â­
   - éœ€å¹³å°ç®¡ç†å‘˜ä»£æ“ä½œ
   - éœ€ç§Ÿæˆ·æä¾›ä¼ä¸šæ”¯ä»˜å®è´¦å·ï¼ˆå®‰å…¨é£é™©ï¼‰
   - æˆæƒæ•ˆç‡ä½ã€å¤±è´¥ç‡é«˜

3. **èŒè´£åˆ’åˆ†ä¸æ¸…** â­â­â­â­
   - æ§åˆ¶ç«¯æ··æ‚ç§Ÿæˆ·ä¸šåŠ¡æ•°æ®
   - æƒé™è¾¹ç•Œæ¨¡ç³Š
   - æ‰©å±•æ€§å·®

### 1.2 å‡çº§ç›®æ ‡

#### æ ¸å¿ƒç›®æ ‡
âœ… **ç§Ÿæˆ·è‡ªä¸»åŒ–**: ç§Ÿæˆ·åœ¨ä¸šåŠ¡ç«¯å®Œæˆç‰©æµè´¦å·ç®¡ç†ã€æˆæƒã€é¢å•æ‰“å°å…¨æµç¨‹  
âœ… **åŠŸèƒ½å®Œæ•´åŒ–**: è¡¥é½ç¼ºå¤±åŠŸèƒ½ï¼ˆç‰©æµé…ç½®ã€å‘è´§åœ°å€ã€é¢å•æ‰“å°ï¼‰  
âœ… **ä½“éªŒä¼˜åŒ–**: ç»Ÿä¸€äº¤äº’é€»è¾‘ã€ä¼˜åŒ–æˆæƒæµç¨‹ã€å¢å¼ºæç¤ºåé¦ˆ  
âœ… **èŒè´£æ¸…æ™°åŒ–**: æ§åˆ¶ç«¯åªç®¡å…¨å±€é…ç½®ï¼Œä¸šåŠ¡ç«¯ç®¡ç†ç§Ÿæˆ·ä¸šåŠ¡

---

## äºŒã€å‡çº§æ–¹æ¡ˆæ€»è§ˆ

### 2.1 åŠŸèƒ½æ¨¡å—å‡çº§æ¸…å•

| æ¨¡å— | ç°çŠ¶ | å‡çº§å | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| **ä¸šåŠ¡ç«¯-ç‰©æµè´¦å·ç®¡ç†** | âŒ æ—  | âœ… æ–°å¢å®Œæ•´ç®¡ç†é¡µ | P0 |
| **ä¸šåŠ¡ç«¯-å‘è´§åœ°å€ç®¡ç†** | âŒ æ—  | âœ… æ–°å¢åœ°å€ç®¡ç†é¡µ | P0 |
| **ä¸šåŠ¡ç«¯-èœé¸Ÿæˆæƒ** | âŒ æ—  | âœ… æ–°å¢è‡ªä¸»æˆæƒæµç¨‹ | P0 |
| **ä¸šåŠ¡ç«¯-ç”µå­é¢å•æ‰“å°** | âŒ æ—  | âœ… æ–°å¢æ‰“å°åŠŸèƒ½ | P0 |
| **ä¸šåŠ¡ç«¯-ç‰©æµè½¨è¿¹æŸ¥è¯¢** | âŒ æ—  | âœ… æ–°å¢è½¨è¿¹æŸ¥è¯¢é¡µ | P1 |
| **æ§åˆ¶ç«¯-ç§Ÿæˆ·æ•°æ®è¿ç§»** | âš ï¸ æ··æ‚ | âœ… çº¯å…¨å±€é…ç½® | P0 |
| **è®¢å•æ¨¡å—-ç‰©æµè”åŠ¨** | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´è”åŠ¨ | P0 |

### 2.2 å‡çº§æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ§åˆ¶ç«¯ (Platform Admin)                     â”‚
â”‚  super.xnamb.cn/console.html                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… ISVå…¨å±€é…ç½® (AppKey/AppSecret/å›è°ƒåœ°å€)                      â”‚
â”‚ âœ… å¿«é€’100å…¨å±€é…ç½®                                              â”‚
â”‚ âœ… å…¨å±€æ—¥å¿—ç›‘æ§ (P1)                                            â”‚
â”‚ âŒ ä¸å†ç®¡ç†ç§Ÿæˆ·ç‰©æµè´¦å·                                          â”‚
â”‚ âŒ ä¸å†ç®¡ç†ç§Ÿæˆ·ä»“åº“                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                   æ•°æ®æŒ‰tenant_idä¸¥æ ¼éš”ç¦»
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡ç«¯ (Tenant User)                        â”‚
â”‚  erp.xnamb.cn/financial_system.html                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€æ–°å¢ã€‘ç‰©æµé…ç½®æ¨¡å—                                             â”‚
â”‚   â”œâ”€ ğŸ“¦ ç‰©æµè´¦å·ç®¡ç† (æ”¯æŒå¤šç½‘ç‚¹)                               â”‚
â”‚   â”‚   â”œâ”€ æ–°å¢/ç¼–è¾‘ç‰©æµè´¦å·                                      â”‚
â”‚   â”‚   â”œâ”€ è‡ªä¸»å®Œæˆèœé¸Ÿæˆæƒ (æ–°çª—å£è·³è½¬)                           â”‚
â”‚   â”‚   â””â”€ æŸ¥çœ‹æˆæƒçŠ¶æ€                                           â”‚
â”‚   â”œâ”€ ğŸ­ å‘è´§åœ°å€ç®¡ç†                                            â”‚
â”‚   â”‚   â”œâ”€ æ–°å¢/ç¼–è¾‘å‘è´§åœ°å€                                      â”‚
â”‚   â”‚   â”œâ”€ è®¾ç½®é»˜è®¤åœ°å€                                           â”‚
â”‚   â”‚   â””â”€ æ”¯æŒå¤šä»“åº“                                             â”‚
â”‚   â””â”€ ğŸ“Š é¢å•è®°å½•æŸ¥è¯¢ (P1)                                       â”‚
â”‚                                                                â”‚
â”‚ ã€å¢å¼ºã€‘è®¢å•æ¨¡å—                                                 â”‚
â”‚   â”œâ”€ è®¢å•åˆ›å»º: é€‰æ‹©å¿«é€’å…¬å¸+ç½‘ç‚¹                                 â”‚
â”‚   â”œâ”€ è®¢å•å‘è´§: è·å–é¢å•+æ‰“å°                                     â”‚
â”‚   â””â”€ è®¢å•è¯¦æƒ…: ç‰©æµè½¨è¿¹æŸ¥è¯¢ (P1)                                â”‚
â”‚                                                                â”‚
â”‚ ã€æ–°å¢ã€‘ç”µå­é¢å•åŠŸèƒ½                                             â”‚
â”‚   â”œâ”€ æ‰“å°é¢å• (å•ä¸ª/æ‰¹é‡)                                       â”‚
â”‚   â”œâ”€ å–æ¶ˆé¢å•                                                  â”‚
â”‚   â””â”€ æ‰“å°æ—¥å¿— (P1)                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€è¯¦ç»†å‡çº§ä»»åŠ¡

### 3.1 æ•°æ®åº“å‡çº§ (P0)

#### ä»»åŠ¡1: æ•°æ®åº“è¡¨ç»“æ„æ£€æŸ¥ä¸ä¼˜åŒ–

**ç›®æ ‡**: ç¡®ä¿ç°æœ‰è¡¨ç»“æ„æ”¯æŒæ–°åŠŸèƒ½

**æ£€æŸ¥é¡¹**:
- âœ… tenant_logistics_account è¡¨ï¼ˆç‰©æµè´¦å·ï¼Œæ”¯æŒå¤šç½‘ç‚¹ï¼‰
- âœ… tenant_warehouse è¡¨ï¼ˆä»“åº“/å‘è´§åœ°å€ï¼‰
- âœ… waybill_record è¡¨ï¼ˆé¢å•è®°å½•ï¼‰
- âœ… print_log è¡¨ï¼ˆæ‰“å°æ—¥å¿—ï¼‰

**æ–°å¢å­—æ®µ**ï¼ˆå¦‚éœ€è¦ï¼‰:
```sql
-- tenant_logistics_account å¢å¼º
ALTER TABLE tenant_logistics_account ADD COLUMN IF NOT EXISTS 
  is_default TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦é»˜è®¤ç½‘ç‚¹';

-- tenant_warehouse å¢å¼º
ALTER TABLE tenant_warehouse ADD COLUMN IF NOT EXISTS 
  is_default TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦é»˜è®¤å‘è´§åœ°å€';

-- orders è¡¨å¢å¼ºï¼ˆç‰©æµä¿¡æ¯ï¼‰
ALTER TABLE orders ADD COLUMN IF NOT EXISTS 
  logistics_account_id INT COMMENT 'ç‰©æµè´¦å·ID',
ADD COLUMN IF NOT EXISTS 
  warehouse_id INT COMMENT 'å‘è´§ä»“åº“ID',
ADD COLUMN IF NOT EXISTS 
  waybill_code VARCHAR(100) COMMENT 'è¿å•å·',
ADD COLUMN IF NOT EXISTS 
  shipping_time DATETIME COMMENT 'å‘è´§æ—¶é—´';
```

---

### 3.2 åç«¯APIå¼€å‘ (P0)

#### ä»»åŠ¡2: ä¸šåŠ¡ç«¯ç‰©æµè´¦å·ç®¡ç†API

**æ–°å¢è·¯ç”±**: `/api/tenant/logistics_accounts`

**æ¥å£æ¸…å•**:
| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|------|------|------|------|
| `/api/tenant/logistics_accounts` | GET | æŸ¥è¯¢ç§Ÿæˆ·ç‰©æµè´¦å·åˆ—è¡¨ | tenant_user |
| `/api/tenant/logistics_accounts` | POST | æ–°å¢ç‰©æµè´¦å· | tenant_admin |
| `/api/tenant/logistics_accounts/<id>` | PUT | ç¼–è¾‘ç‰©æµè´¦å· | tenant_admin |
| `/api/tenant/logistics_accounts/<id>` | DELETE | åˆ é™¤ç‰©æµè´¦å· | tenant_admin |
| `/api/tenant/logistics_accounts/<id>/auth` | POST | ç”Ÿæˆæˆæƒé“¾æ¥ | tenant_admin |
| `/api/tenant/logistics_accounts/<id>/test` | POST | æµ‹è¯•è¿æ¥ | tenant_admin |

**å®ç°è¦ç‚¹**:
```python
# backend/tenant_logistics_api.py
from flask import Blueprint, request, session
from decorators import require_tenant_auth

tenant_logistics_bp = Blueprint('tenant_logistics', __name__)

@tenant_logistics_bp.route('/api/tenant/logistics_accounts', methods=['GET'])
@require_tenant_auth
def get_logistics_accounts():
    """è·å–å½“å‰ç§Ÿæˆ·çš„ç‰©æµè´¦å·åˆ—è¡¨"""
    tenant_id = session.get('tenant_id')
    accounts = db.query("""
        SELECT id, cp_code, cp_name, branch_name, 
               partner_id, auth_status, status, is_default
        FROM tenant_logistics_account
        WHERE tenant_id = %s AND status = 1
        ORDER BY is_default DESC, created_at DESC
    """, (tenant_id,))
    return jsonify({'success': True, 'data': accounts})

@tenant_logistics_bp.route('/api/tenant/logistics_accounts', methods=['POST'])
@require_tenant_auth(role='admin')
def create_logistics_account():
    """æ–°å¢ç‰©æµè´¦å·"""
    tenant_id = session.get('tenant_id')
    data = request.json
    # æ’å…¥æ•°æ®åº“
    # è¿”å›ç»“æœ
    pass

@tenant_logistics_bp.route('/api/tenant/logistics_accounts/<int:account_id>/auth', methods=['POST'])
@require_tenant_auth(role='admin')
def get_auth_url(account_id):
    """ç”Ÿæˆèœé¸Ÿæˆæƒé“¾æ¥"""
    tenant_id = session.get('tenant_id')
    # 1. éªŒè¯è´¦å·å½’å±
    # 2. è°ƒç”¨èœé¸ŸAPIç”Ÿæˆæˆæƒé“¾æ¥
    # 3. stateå‚æ•°åŒ…å«tenant_idå’Œaccount_id
    auth_url = cainiao_service.generate_auth_url(
        tenant_id=tenant_id,
        account_id=account_id
    )
    return jsonify({'success': True, 'auth_url': auth_url})
```

---

#### ä»»åŠ¡3: ä¸šåŠ¡ç«¯å‘è´§åœ°å€ç®¡ç†API

**æ–°å¢è·¯ç”±**: `/api/tenant/warehouses`

**æ¥å£æ¸…å•**:
| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|------|------|------|------|
| `/api/tenant/warehouses` | GET | æŸ¥è¯¢å‘è´§åœ°å€åˆ—è¡¨ | tenant_user |
| `/api/tenant/warehouses` | POST | æ–°å¢å‘è´§åœ°å€ | tenant_admin |
| `/api/tenant/warehouses/<id>` | PUT | ç¼–è¾‘å‘è´§åœ°å€ | tenant_admin |
| `/api/tenant/warehouses/<id>` | DELETE | åˆ é™¤å‘è´§åœ°å€ | tenant_admin |
| `/api/tenant/warehouses/<id>/set_default` | POST | è®¾ä¸ºé»˜è®¤åœ°å€ | tenant_admin |

---

#### ä»»åŠ¡4: ä¸šåŠ¡ç«¯ç”µå­é¢å•API

**æ–°å¢è·¯ç”±**: `/api/tenant/waybills`

**æ¥å£æ¸…å•**:
| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|------|------|------|------|
| `/api/tenant/waybills/get` | POST | è·å–ç”µå­é¢å•ï¼ˆå•ä¸ªï¼‰ | tenant_user |
| `/api/tenant/waybills/batch_get` | POST | æ‰¹é‡è·å–é¢å• | tenant_user |
| `/api/tenant/waybills/<id>/cancel` | POST | å–æ¶ˆé¢å• | tenant_admin |
| `/api/tenant/waybills/<id>/print` | POST | æ‰“å°é¢å• | tenant_user |
| `/api/tenant/waybills` | GET | æŸ¥è¯¢é¢å•è®°å½• | tenant_user |

**å®ç°è¦ç‚¹**:
```python
@tenant_waybill_bp.route('/api/tenant/waybills/get', methods=['POST'])
@require_tenant_auth
def get_waybill():
    """è·å–ç”µå­é¢å•"""
    tenant_id = session.get('tenant_id')
    data = request.json
    
    # 1. éªŒè¯ç‰©æµè´¦å·å½’å±
    logistics_account_id = data.get('logistics_account_id')
    account = verify_account_ownership(tenant_id, logistics_account_id)
    
    # 2. è°ƒç”¨èœé¸ŸAPIè·å–é¢å•
    waybill = cainiao_service.get_waybill(
        account=account,
        sender=data['sender'],
        receiver=data['receiver']
    )
    
    # 3. ä¿å­˜é¢å•è®°å½•
    save_waybill_record(tenant_id, waybill)
    
    return jsonify({'success': True, 'waybill': waybill})
```

---

#### ä»»åŠ¡5: è®¢å•æ¨¡å—ç‰©æµè”åŠ¨API

**å¢å¼ºæ¥å£**: è®¢å•åˆ›å»ºã€è®¢å•å‘è´§

**å®ç°è¦ç‚¹**:
```python
# è®¢å•åˆ›å»ºæ—¶ä¿å­˜ç‰©æµä¿¡æ¯
@order_bp.route('/api/orders', methods=['POST'])
@require_tenant_auth
def create_order():
    data = request.json
    order_data = {
        'tenant_id': session.get('tenant_id'),
        'logistics_account_id': data.get('logistics_account_id'),
        'warehouse_id': data.get('warehouse_id'),
        # ... å…¶ä»–å­—æ®µ
    }
    # æ’å…¥è®¢å•

# è®¢å•å‘è´§æ—¶è‡ªåŠ¨è·å–é¢å•
@order_bp.route('/api/orders/<int:order_id>/ship', methods=['POST'])
@require_tenant_auth
def ship_order(order_id):
    data = request.json
    auto_get_waybill = data.get('auto_get_waybill', True)
    
    if auto_get_waybill:
        # è·å–é¢å•
        waybill = get_waybill_for_order(order_id)
        # æ›´æ–°è®¢å•è¿å•å·
        update_order_waybill(order_id, waybill['waybill_code'])
    
    # æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å‘è´§
    # è¿”å›ç»“æœ
```

---

#### ä»»åŠ¡6: èœé¸Ÿæˆæƒå›è°ƒå¤„ç†å¢å¼º

**æ¥å£**: `/api/cainiao_isv/auth/callback`

**å¢å¼ºç‚¹**:
```python
@cainiao_bp.route('/api/cainiao_isv/auth/callback', methods=['GET'])
def auth_callback():
    """å¤„ç†èœé¸Ÿæˆæƒå›è°ƒ"""
    code = request.args.get('code')
    state = request.args.get('state')
    
    # è§£æstate: tenant_{tenant_id}_account_{account_id}
    tenant_id, account_id = parse_state(state)
    
    # ç”¨codeæ¢å–access_token
    token_info = cainiao_service.get_access_token(code)
    
    # ä¿å­˜tokenåˆ°æ•°æ®åº“
    db.execute("""
        UPDATE tenant_logistics_account
        SET auth_token = %s, auth_status = 'authorized', 
            token_expires_at = %s
        WHERE id = %s AND tenant_id = %s
    """, (token_info['access_token'], token_info['expires_at'], 
          account_id, tenant_id))
    
    # è¿”å›æˆåŠŸé¡µé¢ï¼ˆå¸¦postMessageé€šçŸ¥çˆ¶çª—å£ï¼‰
    return render_template('auth_success.html', 
                          account_id=account_id)
```

---

### 3.3 å‰ç«¯å¼€å‘ (P0)

#### ä»»åŠ¡7: ä¸šåŠ¡ç«¯æ–°å¢ã€Œç‰©æµé…ç½®ã€å¯¼èˆªèœå•

**æ–‡ä»¶**: `financial_system.html`

**å®ç°**:
```html
<!-- å·¦ä¾§å¯¼èˆªæ æ–°å¢ -->
<ul class="sidebar-menu">
    <!-- ç°æœ‰èœå• -->
    <li><a href="#orders">è®¢å•ç®¡ç†</a></li>
    <li><a href="#finance">è´¢åŠ¡ç®¡ç†</a></li>
    
    <!-- æ–°å¢ç‰©æµé…ç½® -->
    <li>
        <a href="#logistics-config" onclick="showLogisticsConfig()">
            <i class="fa fa-truck"></i> ç‰©æµé…ç½®
        </a>
        <ul class="sub-menu">
            <li><a href="#logistics-accounts" onclick="showLogisticsAccounts()">ç‰©æµè´¦å·</a></li>
            <li><a href="#warehouses" onclick="showWarehouses()">å‘è´§åœ°å€</a></li>
            <li><a href="#waybill-records" onclick="showWaybillRecords()">é¢å•è®°å½•</a></li>
        </ul>
    </li>
</ul>
```

---

#### ä»»åŠ¡8: ä¸šåŠ¡ç«¯-ç‰©æµè´¦å·ç®¡ç†é¡µé¢

**æ–‡ä»¶**: `js/logistics_config.js` (æ–°å»º)

**é¡µé¢å¸ƒå±€**:
```html
<div id="logistics-accounts-page" class="page-content" style="display:none">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h2>ç‰©æµè´¦å·ç®¡ç†</h2>
        <button class="btn btn-primary" onclick="openAddLogisticsAccountModal()">
            <i class="fa fa-plus"></i> æ–°å¢ç‰©æµè´¦å·
        </button>
    </div>
    
    <!-- æˆæƒè¯´æ˜ -->
    <div class="alert alert-info">
        <i class="fa fa-info-circle"></i>
        <strong>æˆæƒè¯´æ˜ï¼š</strong>
        é¦–æ¬¡ä½¿ç”¨èœé¸ŸISVæœåŠ¡éœ€è¦æˆæƒã€‚ç‚¹å‡»ã€Œæˆæƒã€å°†è·³è½¬åˆ°èœé¸Ÿæˆæƒé¡µé¢ï¼Œä½¿ç”¨æ‚¨çš„ä¼ä¸šæ”¯ä»˜å®è´¦å·å®Œæˆæˆæƒã€‚
    </div>
    
    <!-- ç‰©æµè´¦å·åˆ—è¡¨ -->
    <table class="table" id="logistics-accounts-table">
        <thead>
            <tr>
                <th>å¿«é€’å…¬å¸</th>
                <th>ç½‘ç‚¹/åˆ†éƒ¨</th>
                <th>å®¢æˆ·ç¼–ç </th>
                <th>æˆæƒçŠ¶æ€</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="logistics-accounts-tbody">
            <!-- åŠ¨æ€åŠ è½½ -->
        </tbody>
    </table>
</div>
```

**JSå®ç°**:
```javascript
// js/logistics_config.js

// åŠ è½½ç‰©æµè´¦å·åˆ—è¡¨
async function loadLogisticsAccounts() {
    try {
        const response = await fetch('/api/tenant/logistics_accounts');
        const result = await response.json();
        
        if (result.success) {
            renderLogisticsAccounts(result.data);
        }
    } catch (error) {
        console.error('åŠ è½½ç‰©æµè´¦å·å¤±è´¥:', error);
        showMessage('åŠ è½½å¤±è´¥', 'error');
    }
}

// æ¸²æŸ“ç‰©æµè´¦å·åˆ—è¡¨
function renderLogisticsAccounts(accounts) {
    const tbody = document.getElementById('logistics-accounts-tbody');
    tbody.innerHTML = '';
    
    accounts.forEach(account => {
        const row = `
            <tr>
                <td>${account.cp_name} (${account.cp_code})</td>
                <td>${account.branch_name || 'é»˜è®¤ç½‘ç‚¹'}</td>
                <td>${maskString(account.partner_id)}</td>
                <td>${getAuthStatusBadge(account.auth_status)}</td>
                <td>${getStatusBadge(account.status)}</td>
                <td>
                    ${getActionButtons(account)}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// è·å–æ“ä½œæŒ‰é’®
function getActionButtons(account) {
    let buttons = '';
    
    if (account.auth_status === 'unauthorized') {
        buttons += `<button class="btn btn-sm btn-warning" onclick="authorize(${account.id})">æˆæƒ</button>`;
    } else if (account.auth_status === 'expired') {
        buttons += `<button class="btn btn-sm btn-warning" onclick="authorize(${account.id})">é‡æ–°æˆæƒ</button>`;
    } else {
        buttons += `<button class="btn btn-sm btn-primary" onclick="editLogisticsAccount(${account.id})">ç¼–è¾‘</button>`;
    }
    
    buttons += `<button class="btn btn-sm btn-danger" onclick="deleteLogisticsAccount(${account.id})">åˆ é™¤</button>`;
    
    return buttons;
}

// æˆæƒç‰©æµè´¦å·
async function authorize(accountId) {
    try {
        showMessage('æ­£åœ¨ç”Ÿæˆæˆæƒé“¾æ¥...', 'info');
        
        // è·å–æˆæƒé“¾æ¥
        const response = await fetch(`/api/tenant/logistics_accounts/${accountId}/auth`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            // æ–°çª—å£æ‰“å¼€æˆæƒé¡µé¢
            const authWindow = window.open(result.auth_url, '_blank', 
                'width=800,height=600,top=100,left=200');
            
            // ç›‘å¬æˆæƒæˆåŠŸæ¶ˆæ¯
            window.addEventListener('message', function(event) {
                if (event.data.type === 'auth_success' && 
                    event.data.account_id === accountId) {
                    showMessage('æˆæƒæˆåŠŸï¼', 'success');
                    loadLogisticsAccounts(); // åˆ·æ–°åˆ—è¡¨
                }
            });
        }
    } catch (error) {
        console.error('æˆæƒå¤±è´¥:', error);
        showMessage('æˆæƒå¤±è´¥', 'error');
    }
}

// æ–°å¢ç‰©æµè´¦å·å¼¹çª—
function openAddLogisticsAccountModal() {
    const modalHTML = `
        <div class="modal" id="add-logistics-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4>æ–°å¢ç‰©æµè´¦å·</h4>
                        <button type="button" class="close" onclick="closeModal('add-logistics-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="add-logistics-form">
                            <div class="form-group">
                                <label>å¿«é€’å…¬å¸ <span class="required">*</span></label>
                                <select class="form-control" name="cp_code" required>
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ZTO">ä¸­é€šå¿«é€’</option>
                                    <option value="YTO">åœ†é€šå¿«é€’</option>
                                    <option value="YD">éŸµè¾¾å¿«é€’</option>
                                    <option value="SF">é¡ºä¸°é€Ÿè¿</option>
                                    <option value="STO">ç”³é€šå¿«é€’</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç½‘ç‚¹/åˆ†éƒ¨åç§°</label>
                                <input type="text" class="form-control" name="branch_name" 
                                       placeholder="å¦‚ï¼šåŒ—äº¬ä¸€éƒ¨ã€ä¸Šæµ·åˆ†å…¬å¸ï¼ˆå¯ä¸ºç©ºåˆ™æ˜¾ç¤ºé»˜è®¤ç½‘ç‚¹ï¼‰">
                            </div>
                            <div class="form-group">
                                <label>å¿«é€’å®¢æˆ·ç¼–ç  <span class="required">*</span></label>
                                <input type="text" class="form-control" name="partner_id" 
                                       placeholder="å¿«é€’å…¬å¸æä¾›çš„partner_id" required>
                            </div>
                            <div class="form-group">
                                <label>è´¦å·</label>
                                <input type="text" class="form-control" name="account">
                            </div>
                            <div class="form-group">
                                <label>å¯†ç /å¯†é’¥</label>
                                <input type="password" class="form-control" name="password">
                            </div>
                            <div class="alert alert-info">
                                <i class="fa fa-info-circle"></i>
                                æ·»åŠ åéœ€è¦å®Œæˆèœé¸Ÿæˆæƒæ‰èƒ½ä½¿ç”¨
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" onclick="closeModal('add-logistics-modal')">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="submitLogisticsAccount()">æ·»åŠ å¹¶æˆæƒ</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    $('#add-logistics-modal').modal('show');
}

// æäº¤æ–°å¢ç‰©æµè´¦å·
async function submitLogisticsAccount() {
    const form = document.getElementById('add-logistics-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/tenant/logistics_accounts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        
        if (result.success) {
            closeModal('add-logistics-modal');
            showMessage('æ·»åŠ æˆåŠŸï¼', 'success');
            loadLogisticsAccounts();
            
            // è‡ªåŠ¨è§¦å‘æˆæƒ
            if (confirm('æ˜¯å¦ç«‹å³å®Œæˆæˆæƒï¼Ÿ')) {
                authorize(result.account_id);
            }
        } else {
            showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        showMessage('æ·»åŠ å¤±è´¥', 'error');
    }
}
```

---

#### ä»»åŠ¡9: ä¸šåŠ¡ç«¯-å‘è´§åœ°å€ç®¡ç†é¡µé¢

**æ–‡ä»¶**: `js/logistics_config.js`

**é¡µé¢å¸ƒå±€**:
```html
<div id="warehouses-page" class="page-content" style="display:none">
    <div class="page-header">
        <h2>å‘è´§åœ°å€ç®¡ç†</h2>
        <button class="btn btn-primary" onclick="openAddWarehouseModal()">
            <i class="fa fa-plus"></i> æ–°å¢å‘è´§åœ°å€
        </button>
    </div>
    
    <div class="alert alert-success">
        <i class="fa fa-check-circle"></i>
        æ”¯æŒå¤šä»“åº“/å¤šåœ°å€ï¼Œå¯è®¾ç½®é»˜è®¤å‘è´§åœ°å€
    </div>
    
    <table class="table" id="warehouses-table">
        <thead>
            <tr>
                <th>åœ°å€åç§°</th>
                <th>è”ç³»äºº</th>
                <th>è”ç³»ç”µè¯</th>
                <th>è¯¦ç»†åœ°å€</th>
                <th>é»˜è®¤</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="warehouses-tbody">
            <!-- åŠ¨æ€åŠ è½½ -->
        </tbody>
    </table>
</div>
```

**JSå®ç°**:
```javascript
// åŠ è½½å‘è´§åœ°å€åˆ—è¡¨
async function loadWarehouses() {
    const response = await fetch('/api/tenant/warehouses');
    const result = await response.json();
    
    if (result.success) {
        renderWarehouses(result.data);
    }
}

// æ¸²æŸ“å‘è´§åœ°å€åˆ—è¡¨
function renderWarehouses(warehouses) {
    const tbody = document.getElementById('warehouses-tbody');
    tbody.innerHTML = '';
    
    warehouses.forEach(warehouse => {
        const row = `
            <tr>
                <td>${warehouse.name}</td>
                <td>${warehouse.contact_name}</td>
                <td>${warehouse.contact_phone}</td>
                <td>${warehouse.province} ${warehouse.city} ${warehouse.district} ${warehouse.address}</td>
                <td>${warehouse.is_default ? '<span class="badge badge-success">âœ…é»˜è®¤</span>' : ''}</td>
                <td>
                    ${!warehouse.is_default ? `<button class="btn btn-sm btn-success" onclick="setDefaultWarehouse(${warehouse.id})">è®¾ä¸ºé»˜è®¤</button>` : ''}
                    <button class="btn btn-sm btn-primary" onclick="editWarehouse(${warehouse.id})">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteWarehouse(${warehouse.id})">åˆ é™¤</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// è®¾ä¸ºé»˜è®¤åœ°å€
async function setDefaultWarehouse(warehouseId) {
    if (!confirm('ç¡®è®¤è®¾ä¸ºé»˜è®¤å‘è´§åœ°å€å—ï¼Ÿ')) return;
    
    const response = await fetch(`/api/tenant/warehouses/${warehouseId}/set_default`, {
        method: 'POST'
    });
    const result = await response.json();
    
    if (result.success) {
        showMessage('è®¾ç½®æˆåŠŸ', 'success');
        loadWarehouses();
    }
}
```

---

#### ä»»åŠ¡10: è®¢å•æ¨¡å—å¢å¼º-ç‰©æµä¿¡æ¯åŒº

**æ–‡ä»¶**: `js/orders.js`

**è®¢å•åˆ›å»ºé¡µå¢å¼º**:
```html
<!-- è®¢å•åˆ›å»ºé¡µæ–°å¢ç‰©æµä¿¡æ¯åŒº -->
<div class="form-section">
    <h4>ğŸ“¦ ç‰©æµä¿¡æ¯</h4>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label>å‘è´§ä»“åº“</label>
                <select class="form-control" id="warehouse-select" name="warehouse_id">
                    <option value="">è¯·é€‰æ‹©</option>
                    <!-- åŠ¨æ€åŠ è½½ -->
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>å¿«é€’å…¬å¸</label>
                <select class="form-control" id="logistics-cp-select" 
                        name="logistics_account_id" onchange="loadBranches(this.value)">
                    <option value="">è¯·é€‰æ‹©</option>
                    <!-- åŠ¨æ€åŠ è½½å·²æˆæƒçš„å¿«é€’å…¬å¸ -->
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>ç½‘ç‚¹/åˆ†éƒ¨</label>
                <select class="form-control" id="logistics-branch-select" 
                        name="logistics_account_id">
                    <option value="">è¯·å…ˆé€‰æ‹©å¿«é€’å…¬å¸</option>
                    <!-- è”åŠ¨åŠ è½½ -->
                </select>
            </div>
        </div>
    </div>
    <div class="alert alert-info">
        <i class="fa fa-info-circle"></i>
        é€‰æ‹©åå°†åœ¨å‘è´§æ—¶è‡ªåŠ¨è·å–é¢å•
    </div>
</div>
```

**JSå®ç°**:
```javascript
// åŠ è½½å·²æˆæƒçš„å¿«é€’å…¬å¸
async function loadAuthorizedExpressCompanies() {
    const response = await fetch('/api/tenant/logistics_accounts?auth_status=authorized');
    const result = await response.json();
    
    if (result.success) {
        const select = document.getElementById('logistics-cp-select');
        const grouped = groupBy(result.data, 'cp_code');
        
        for (const [cpCode, accounts] of Object.entries(grouped)) {
            const option = document.createElement('option');
            option.value = cpCode;
            option.text = accounts[0].cp_name;
            select.add(option);
        }
    }
}

// è”åŠ¨åŠ è½½ç½‘ç‚¹
async function loadBranches(cpCode) {
    const branchSelect = document.getElementById('logistics-branch-select');
    branchSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç½‘ç‚¹</option>';
    
    if (!cpCode) return;
    
    const response = await fetch(`/api/tenant/logistics_accounts?cp_code=${cpCode}&auth_status=authorized`);
    const result = await response.json();
    
    if (result.success) {
        result.data.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.text = account.branch_name || 'é»˜è®¤ç½‘ç‚¹';
            branchSelect.add(option);
        });
        
        // å¦‚æœåªæœ‰ä¸€ä¸ªç½‘ç‚¹ï¼Œè‡ªåŠ¨é€‰ä¸­
        if (result.data.length === 1) {
            branchSelect.value = result.data[0].id;
        }
    }
}
```

---

#### ä»»åŠ¡11: è®¢å•å‘è´§å¼¹çª—å¢å¼º

**æ–‡ä»¶**: `js/orders.js`

**å‘è´§å¼¹çª—**:
```javascript
function openShipOrderModal(orderId) {
    const modalHTML = `
        <div class="modal" id="ship-order-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4>è®¢å•å‘è´§</h4>
                        <button type="button" class="close" onclick="closeModal('ship-order-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>è®¢å•å·</label>
                            <input type="text" class="form-control" id="ship-order-no" readonly>
                        </div>
                        <div class="form-group">
                            <label>å¿«é€’å…¬å¸</label>
                            <select class="form-control" id="ship-logistics-cp" onchange="loadShipBranches()">
                                <!-- åŠ¨æ€åŠ è½½ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç½‘ç‚¹/åˆ†éƒ¨</label>
                            <select class="form-control" id="ship-logistics-branch">
                                <!-- è”åŠ¨åŠ è½½ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <h5>æ”¶ä»¶äººä¿¡æ¯</h5>
                            <div id="receiver-info-display">
                                <!-- æ˜¾ç¤ºè®¢å•æ”¶è´§åœ°å€ -->
                            </div>
                        </div>
                        <div class="form-group">
                            <h5>å¯„ä»¶äººä¿¡æ¯</h5>
                            <div id="sender-info-display">
                                <!-- æ˜¾ç¤ºé»˜è®¤å‘è´§åœ°å€ -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-get-waybill" checked>
                                è‡ªåŠ¨è·å–ç”µå­é¢å•
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-print-waybill" checked>
                                è·å–åè‡ªåŠ¨æ‰“å°
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" onclick="closeModal('ship-order-modal')">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="submitShipOrder(${orderId})">ç¡®è®¤å‘è´§</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    $('#ship-order-modal').modal('show');
    
    // åŠ è½½è®¢å•ä¿¡æ¯
    loadOrderShipInfo(orderId);
}

// æäº¤å‘è´§
async function submitShipOrder(orderId) {
    const autoGetWaybill = document.getElementById('auto-get-waybill').checked;
    const autoPrintWaybill = document.getElementById('auto-print-waybill').checked;
    const logisticsAccountId = document.getElementById('ship-logistics-branch').value;
    
    if (!logisticsAccountId) {
        showMessage('è¯·é€‰æ‹©å¿«é€’å…¬å¸å’Œç½‘ç‚¹', 'warning');
        return;
    }
    
    showLoading('æ­£åœ¨å‘è´§...');
    
    try {
        const response = await fetch(`/api/orders/${orderId}/ship`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                logistics_account_id: logisticsAccountId,
                auto_get_waybill: autoGetWaybill,
                auto_print_waybill: autoPrintWaybill
            })
        });
        const result = await response.json();
        
        hideLoading();
        
        if (result.success) {
            closeModal('ship-order-modal');
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showShipSuccessModal({
                order_no: result.order_no,
                waybill_code: result.waybill_code,
                cp_name: result.cp_name,
                branch_name: result.branch_name
            });
            
            // åˆ·æ–°è®¢å•åˆ—è¡¨
            loadOrders();
        } else {
            showMessage(result.message || 'å‘è´§å¤±è´¥', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('å‘è´§å¤±è´¥:', error);
        showMessage('å‘è´§å¤±è´¥', 'error');
    }
}

// å‘è´§æˆåŠŸæç¤ºå¼¹çª—
function showShipSuccessModal(data) {
    const modalHTML = `
        <div class="modal" id="ship-success-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success">
                        <h4><i class="fa fa-check-circle"></i> å‘è´§æˆåŠŸ</h4>
                    </div>
                    <div class="modal-body text-center">
                        <p><strong>è®¢å•å·ï¼š</strong>${data.order_no}</p>
                        <p><strong>è¿å•å·ï¼š</strong>${data.waybill_code} 
                           <button class="btn btn-sm btn-link" onclick="copyText('${data.waybill_code}')">å¤åˆ¶</button>
                        </p>
                        <p><strong>å¿«é€’å…¬å¸ï¼š</strong>${data.cp_name}ï¼ˆ${data.branch_name}ï¼‰</p>
                        ${data.printed ? '<p class="text-success">âœ… é¢å•å·²è‡ªåŠ¨æ‰“å°ï¼Œè¯·æ£€æŸ¥æ‰“å°æœº</p>' : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" onclick="closeModal('ship-success-modal')">æŸ¥çœ‹è®¢å•</button>
                        <button class="btn btn-primary" onclick="closeModal('ship-success-modal'); openShipOrderModal()">ç»§ç»­å‘è´§</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    $('#ship-success-modal').modal('show');
}
```

---

#### ä»»åŠ¡12: èœé¸ŸæˆæƒæˆåŠŸå›è°ƒé¡µé¢

**æ–°å»ºæ–‡ä»¶**: `auth_success.html`

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æˆæƒæˆåŠŸ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .success-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .success-icon {
            font-size: 64px;
            color: #52c41a;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            margin-bottom: 20px;
        }
        .countdown {
            font-size: 14px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="success-box">
        <div class="success-icon">âœ…</div>
        <h2>æˆæƒæˆåŠŸï¼</h2>
        <p>æ‚¨çš„ç‰©æµè´¦å·å·²å®Œæˆæˆæƒï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨</p>
        <p class="countdown">æ­¤çª—å£å°†åœ¨ <span id="countdown">3</span> ç§’åè‡ªåŠ¨å…³é—­...</p>
    </div>
    
    <script>
        // å€’è®¡æ—¶
        let countdown = 3;
        const countdownEl = document.getElementById('countdown');
        
        const timer = setInterval(() => {
            countdown--;
            countdownEl.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(timer);
                closeWindow();
            }
        }, 1000);
        
        // å…³é—­çª—å£å¹¶é€šçŸ¥çˆ¶çª—å£
        function closeWindow() {
            // é€šçŸ¥çˆ¶çª—å£åˆ·æ–°
            if (window.opener) {
                window.opener.postMessage({
                    type: 'auth_success',
                    account_id: {{ account_id }}  // ç”±åç«¯æ¸²æŸ“
                }, '*');
            }
            
            // å…³é—­å½“å‰çª—å£
            window.close();
        }
    </script>
</body>
</html>
```

---

### 3.4 æ§åˆ¶ç«¯ä¼˜åŒ– (P1)

#### ä»»åŠ¡13: æ§åˆ¶ç«¯æ¸…ç†ç§Ÿæˆ·æ•°æ®ç®¡ç†åŠŸèƒ½

**ç›®æ ‡**: æ§åˆ¶ç«¯åªä¿ç•™ISVå…¨å±€é…ç½®ï¼Œç§»é™¤ç§Ÿæˆ·æ•°æ®ç®¡ç†

**å®ç°è¦ç‚¹**:
```javascript
// console.js ä¸­æ³¨é‡Šæˆ–åˆ é™¤ç§Ÿæˆ·ç®¡ç†ç›¸å…³å‡½æ•°
// - loadCainiaoTenants()
// - loadCainiaoLogisticsAccounts()
// - loadCainiaoWarehouses()

// ä¿ç•™ISVé…ç½®ç®¡ç†
// - loadCainiaoISVConfig()
// - saveCainiaoISVConfig()
```

---

### 3.5 æµ‹è¯•ä¸éƒ¨ç½² (P0)

#### ä»»åŠ¡14: åŠŸèƒ½æµ‹è¯•æ¸…å•

**æµ‹è¯•æ¸…å•**:
- [ ] ä¸šåŠ¡ç«¯ç‰©æµè´¦å·ç®¡ç†
  - [ ] æ–°å¢ç‰©æµè´¦å·
  - [ ] ç¼–è¾‘ç‰©æµè´¦å·
  - [ ] åˆ é™¤ç‰©æµè´¦å·
  - [ ] ç”Ÿæˆæˆæƒé“¾æ¥
  - [ ] æˆæƒæµç¨‹å®Œæ•´æµ‹è¯•
  
- [ ] ä¸šåŠ¡ç«¯å‘è´§åœ°å€ç®¡ç†
  - [ ] æ–°å¢å‘è´§åœ°å€
  - [ ] ç¼–è¾‘å‘è´§åœ°å€
  - [ ] åˆ é™¤å‘è´§åœ°å€
  - [ ] è®¾ç½®é»˜è®¤åœ°å€
  
- [ ] è®¢å•ç‰©æµè”åŠ¨
  - [ ] è®¢å•åˆ›å»ºé€‰æ‹©ç‰©æµ
  - [ ] è®¢å•å‘è´§è·å–é¢å•
  - [ ] è®¢å•å‘è´§è‡ªåŠ¨æ‰“å°
  
- [ ] æƒé™æµ‹è¯•
  - [ ] ç§Ÿæˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
  - [ ] ç§Ÿæˆ·ç®¡ç†å‘˜æ‰èƒ½æˆæƒ
  - [ ] æ§åˆ¶ç«¯æ— æ³•ç¼–è¾‘ç§Ÿæˆ·è®¢å•

---

## å››ã€å‡çº§ååŠŸèƒ½è¯´æ˜

### 4.1 ä¸šåŠ¡ç«¯æ–°å¢åŠŸèƒ½

#### ç‰©æµé…ç½®æ¨¡å—

**å…¥å£**: ä¸šåŠ¡ç«¯å·¦ä¾§å¯¼èˆª â†’ ç‰©æµé…ç½®

**åŠŸèƒ½æ¸…å•**:
1. **ç‰©æµè´¦å·ç®¡ç†**
   - æŸ¥çœ‹æˆ‘çš„ç‰©æµè´¦å·åˆ—è¡¨
   - æ–°å¢ç‰©æµè´¦å·ï¼ˆæ”¯æŒå¤šç½‘ç‚¹ï¼‰
   - ç¼–è¾‘ç‰©æµè´¦å·ä¿¡æ¯
   - è‡ªä¸»å®Œæˆèœé¸Ÿæˆæƒ
   - æŸ¥çœ‹æˆæƒçŠ¶æ€ï¼ˆå·²æˆæƒâœ…/æœªæˆæƒâš ï¸/å·²è¿‡æœŸâŒï¼‰
   - åˆ é™¤ç‰©æµè´¦å·

2. **å‘è´§åœ°å€ç®¡ç†**
   - æŸ¥çœ‹å‘è´§åœ°å€åˆ—è¡¨
   - æ–°å¢å‘è´§åœ°å€ï¼ˆæ”¯æŒå¤šä»“åº“ï¼‰
   - ç¼–è¾‘å‘è´§åœ°å€
   - è®¾ç½®é»˜è®¤å‘è´§åœ°å€
   - åˆ é™¤å‘è´§åœ°å€

3. **é¢å•è®°å½•æŸ¥è¯¢** (P1)
   - æŸ¥çœ‹å†å²é¢å•è®°å½•
   - ç­›é€‰ï¼ˆæ—¶é—´/å¿«é€’å…¬å¸/çŠ¶æ€ï¼‰
   - å¯¼å‡ºé¢å•è®°å½•

---

#### è®¢å•æ¨¡å—å¢å¼º

**è®¢å•åˆ›å»ºé¡µ**:
- æ–°å¢ç‰©æµä¿¡æ¯åŒº
- é€‰æ‹©å‘è´§ä»“åº“
- é€‰æ‹©å¿«é€’å…¬å¸å’Œç½‘ç‚¹ï¼ˆè”åŠ¨ä¸‹æ‹‰ï¼‰
- é€‰æ‹©ååœ¨å‘è´§æ—¶è‡ªåŠ¨è·å–é¢å•

**è®¢å•å‘è´§æµç¨‹**:
1. ç‚¹å‡»ã€Œå‘è´§ã€æŒ‰é’®
2. ç¡®è®¤/ä¿®æ”¹å¿«é€’å…¬å¸å’Œç½‘ç‚¹
3. å‹¾é€‰ã€Œè‡ªåŠ¨è·å–ç”µå­é¢å•ã€
4. å‹¾é€‰ã€Œè·å–åè‡ªåŠ¨æ‰“å°ã€
5. ç‚¹å‡»ã€Œç¡®è®¤å‘è´§ã€
6. ç³»ç»Ÿè‡ªåŠ¨è·å–é¢å•å¹¶æ›´æ–°è®¢å•è¿å•å·
7. æ˜¾ç¤ºå‘è´§æˆåŠŸæç¤ºï¼ˆå«è¿å•å·ï¼‰

---

### 4.2 æ§åˆ¶ç«¯èŒè´£è°ƒæ•´

**ä¿ç•™åŠŸèƒ½**:
- âœ… ISVå…¨å±€é…ç½®ç®¡ç†ï¼ˆAppKey/AppSecretï¼‰
- âœ… å¿«é€’100å…¨å±€é…ç½®
- âœ… å…¨å±€æ—¥å¿—ç›‘æ§ (P1)

**ç§»é™¤åŠŸèƒ½**:
- âŒ ç§Ÿæˆ·ç®¡ç†ï¼ˆç”±ä¸šåŠ¡ç«¯ç§Ÿæˆ·è‡ªä¸»ç®¡ç†ï¼‰
- âŒ ç§Ÿæˆ·ç‰©æµè´¦å·ç®¡ç†
- âŒ ç§Ÿæˆ·ä»“åº“ç®¡ç†

---

### 4.3 æ“ä½œæµç¨‹è¯´æ˜

#### ç§Ÿæˆ·é¦–æ¬¡ä½¿ç”¨ç‰©æµåŠŸèƒ½æµç¨‹

**æ­¥éª¤1: æ·»åŠ ç‰©æµè´¦å·**
1. ç™»å½•ä¸šåŠ¡ç«¯
2. è¿›å…¥ã€Œç‰©æµé…ç½®ã€â†’ã€Œç‰©æµè´¦å·ç®¡ç†ã€
3. ç‚¹å‡»ã€Œæ–°å¢ç‰©æµè´¦å·ã€
4. å¡«å†™å¿«é€’å…¬å¸ã€ç½‘ç‚¹åç§°ã€å®¢æˆ·ç¼–ç ç­‰ä¿¡æ¯
5. ç‚¹å‡»ã€Œæ·»åŠ å¹¶æˆæƒã€

**æ­¥éª¤2: å®Œæˆèœé¸Ÿæˆæƒ**
1. ç³»ç»Ÿè‡ªåŠ¨æ‰“å¼€èœé¸Ÿæˆæƒé¡µé¢ï¼ˆæ–°çª—å£ï¼‰
2. ä½¿ç”¨ä¼ä¸šæ”¯ä»˜å®æ‰«ç ç™»å½•
3. ç¡®è®¤æˆæƒ
4. æˆæƒæˆåŠŸåçª—å£è‡ªåŠ¨å…³é—­
5. è¿”å›ä¸šåŠ¡ç«¯ï¼ŒæŸ¥çœ‹æˆæƒçŠ¶æ€ä¸ºã€Œå·²æˆæƒâœ…ã€

**æ­¥éª¤3: æ·»åŠ å‘è´§åœ°å€**
1. è¿›å…¥ã€Œç‰©æµé…ç½®ã€â†’ã€Œå‘è´§åœ°å€ç®¡ç†ã€
2. ç‚¹å‡»ã€Œæ–°å¢å‘è´§åœ°å€ã€
3. å¡«å†™åœ°å€åç§°ã€è”ç³»äººã€ç”µè¯ã€åœ°å€ç­‰ä¿¡æ¯
4. å‹¾é€‰ã€Œè®¾ä¸ºé»˜è®¤åœ°å€ã€
5. ç‚¹å‡»ã€Œä¿å­˜ã€

**æ­¥éª¤4: åˆ›å»ºè®¢å•å¹¶å‘è´§**
1. è¿›å…¥ã€Œè®¢å•ç®¡ç†ã€â†’ã€Œåˆ›å»ºè®¢å•ã€
2. å¡«å†™å®¢æˆ·ä¿¡æ¯ã€æœåŠ¡é¡¹ç›®
3. åœ¨ç‰©æµä¿¡æ¯åŒºé€‰æ‹©å¿«é€’å…¬å¸å’Œç½‘ç‚¹
4. ä¿å­˜è®¢å•
5. è®¢å•è¯¦æƒ…é¡µç‚¹å‡»ã€Œå‘è´§ã€
6. ç¡®è®¤ç‰©æµä¿¡æ¯
7. å‹¾é€‰ã€Œè‡ªåŠ¨è·å–ç”µå­é¢å•ã€å’Œã€Œè·å–åè‡ªåŠ¨æ‰“å°ã€
8. ç‚¹å‡»ã€Œç¡®è®¤å‘è´§ã€
9. ç³»ç»Ÿè‡ªåŠ¨è·å–é¢å•å¹¶æ‰“å°
10. æ˜¾ç¤ºè¿å•å·

---

## äº”ã€æŠ€æœ¯æ¶æ„è¯´æ˜

### 5.1 æ•°æ®éš”ç¦»

**ä¸¥æ ¼æŒ‰tenant_idéš”ç¦»**:
```sql
-- æ‰€æœ‰ç§Ÿæˆ·æ•°æ®è¡¨éƒ½åŒ…å«tenant_idå­—æ®µ
-- æ‰€æœ‰APIæŸ¥è¯¢éƒ½å¿…é¡»å¸¦WHERE tenant_id = ?

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢ç‰©æµè´¦å·
SELECT * FROM tenant_logistics_account
WHERE tenant_id = ? AND status = 1;

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢é¢å•è®°å½•
SELECT * FROM waybill_record
WHERE tenant_id = ? 
ORDER BY created_at DESC;
```

---

### 5.2 æƒé™æ§åˆ¶

**è£…é¥°å™¨**:
```python
# ç§Ÿæˆ·ç”¨æˆ·æƒé™
@require_tenant_auth
def api_function():
    tenant_id = session.get('tenant_id')
    # åªèƒ½è®¿é—®æœ¬ç§Ÿæˆ·æ•°æ®

# ç§Ÿæˆ·ç®¡ç†å‘˜æƒé™
@require_tenant_auth(role='admin')
def admin_api_function():
    tenant_id = session.get('tenant_id')
    # åªæœ‰ç§Ÿæˆ·ç®¡ç†å‘˜æ‰èƒ½æ“ä½œ
```

---

### 5.3 æˆæƒæµç¨‹

**å®Œæ•´æµç¨‹**:
```
ä¸šåŠ¡ç«¯ â†’ ç‚¹å‡»æˆæƒ
    â†“
ç”Ÿæˆæˆæƒé“¾æ¥ï¼ˆstateåŒ…å«tenant_idå’Œaccount_idï¼‰
    â†“
æ–°çª—å£æ‰“å¼€èœé¸Ÿæˆæƒé¡µ
    â†“
ç”¨æˆ·æ‰«ç ç™»å½•å¹¶æˆæƒ
    â†“
è·³è½¬å›è°ƒåœ°å€
    â†“
åç«¯è§£æstateï¼Œç”¨codeæ¢token
    â†“
ä¿å­˜tokenåˆ°æ•°æ®åº“
    â†“
è¿”å›æˆæƒæˆåŠŸé¡µé¢
    â†“
3ç§’åè‡ªåŠ¨å…³é—­å¹¶é€šçŸ¥çˆ¶çª—å£
    â†“
ä¸šåŠ¡ç«¯åˆ·æ–°åˆ—è¡¨ï¼Œæ˜¾ç¤ºå·²æˆæƒâœ…
```

---

## å…­ã€éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 6.1 æ•°æ®åº“æ£€æŸ¥
- [ ] æ•°æ®åº“è¡¨ç»“æ„å®Œæ•´
- [ ] å­—æ®µç´¢å¼•åˆ›å»º
- [ ] æµ‹è¯•æ•°æ®æ¸…ç†

### 6.2 åç«¯æ£€æŸ¥
- [ ] æ–°å¢APIè·¯ç”±æ³¨å†Œ
- [ ] æƒé™è£…é¥°å™¨ç”Ÿæ•ˆ
- [ ] æˆæƒå›è°ƒå¤„ç†æ­£ç¡®

### 6.3 å‰ç«¯æ£€æŸ¥
- [ ] æ–°å¢å¯¼èˆªèœå•æ˜¾ç¤º
- [ ] JSæ–‡ä»¶æ­£ç¡®å¼•å…¥
- [ ] CSSæ ·å¼æ­£å¸¸

### 6.4 é…ç½®æ£€æŸ¥
- [ ] èœé¸ŸISVé…ç½®æ­£ç¡®
- [ ] å›è°ƒåœ°å€é…ç½®æ­£ç¡®
- [ ] å¿«é€’100é…ç½®æ­£ç¡®

---

## ä¸ƒã€å›å½’æµ‹è¯•æ¸…å•

### 7.1 æ§åˆ¶ç«¯æµ‹è¯•
- [ ] ISVé…ç½®ä¿å­˜/åŠ è½½
- [ ] å¿«é€’100åŠŸèƒ½æ­£å¸¸
- [ ] å…¨å±€æ—¥å¿—æŸ¥è¯¢

### 7.2 ä¸šåŠ¡ç«¯æµ‹è¯•
- [ ] è®¢å•åˆ›å»º/ç¼–è¾‘
- [ ] è®¢å•å‘è´§
- [ ] è´¢åŠ¡ç®¡ç†
- [ ] ç‰©æµé…ç½®ï¼ˆæ–°å¢ï¼‰

### 7.3 æˆæƒæµ‹è¯•
- [ ] æˆæƒé“¾æ¥ç”Ÿæˆ
- [ ] æˆæƒæˆåŠŸå›è°ƒ
- [ ] Tokenä¿å­˜æˆåŠŸ
- [ ] æˆæƒçŠ¶æ€æ›´æ–°

---

## å…«ã€å‡çº§æ—¶é—´è¡¨

### Phase 1: åç«¯å¼€å‘ (2å¤©)
- Day 1: æ•°æ®åº“æ£€æŸ¥ + APIå¼€å‘ï¼ˆç‰©æµè´¦å·/å‘è´§åœ°å€ï¼‰
- Day 2: APIå¼€å‘ï¼ˆé¢å•è·å–/è®¢å•è”åŠ¨ï¼‰ + æˆæƒå›è°ƒ

### Phase 2: å‰ç«¯å¼€å‘ (2å¤©)
- Day 3: ä¸šåŠ¡ç«¯ç‰©æµé…ç½®é¡µé¢å¼€å‘
- Day 4: è®¢å•æ¨¡å—å¢å¼º + æˆæƒæµç¨‹å¯¹æ¥

### Phase 3: æµ‹è¯•ä¸ä¼˜åŒ– (1å¤©)
- Day 5: å®Œæ•´åŠŸèƒ½æµ‹è¯• + Bugä¿®å¤ + éƒ¨ç½²

---

## ä¹ã€æˆåŠŸæ ‡å‡†

### 9.1 åŠŸèƒ½æ ‡å‡†
âœ… ç§Ÿæˆ·å¯åœ¨ä¸šåŠ¡ç«¯è‡ªä¸»æ·»åŠ ç‰©æµè´¦å·  
âœ… ç§Ÿæˆ·å¯è‡ªä¸»å®Œæˆèœé¸Ÿæˆæƒï¼ˆæ— éœ€å¹³å°ç®¡ç†å‘˜ï¼‰  
âœ… ç§Ÿæˆ·å¯æ·»åŠ å¤šä¸ªå‘è´§åœ°å€  
âœ… è®¢å•å‘è´§è‡ªåŠ¨è·å–é¢å•  
âœ… é¢å•è‡ªåŠ¨æ‰“å°  
âœ… è¿å•å·è‡ªåŠ¨å…³è”è®¢å•  

### 9.2 ä½“éªŒæ ‡å‡†
âœ… æˆæƒæµç¨‹ç®€å•ï¼ˆ3æ­¥å®Œæˆï¼‰  
âœ… æ“ä½œåé¦ˆåŠæ—¶ï¼ˆæˆåŠŸ/å¤±è´¥æç¤ºï¼‰  
âœ… ç•Œé¢å‹å¥½ï¼ˆå¸ƒå±€æ¸…æ™°ã€è¯´æ˜å®Œæ•´ï¼‰  
âœ… é”™è¯¯æç¤ºæ˜ç¡®ï¼ˆå‘ŠçŸ¥åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼‰  

### 9.3 å®‰å…¨æ ‡å‡†
âœ… æ•°æ®ä¸¥æ ¼æŒ‰tenant_idéš”ç¦»  
âœ… æƒé™æ§åˆ¶ç”Ÿæ•ˆï¼ˆç®¡ç†å‘˜/æ™®é€šç”¨æˆ·ï¼‰  
âœ… æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨  
âœ… æˆæƒTokenå®‰å…¨ä¿å­˜  

---

**æ–‡æ¡£ç»“æŸ**

---

## åã€é—®é¢˜ä¿®å¤æ—¥å¿—

### 10.1 V2.1 Bugfix - 2026-02-16

#### é—®é¢˜æè¿°
**é—®é¢˜**: ä¸šåŠ¡ç«¯ç‰©æµæ¨¡å—APIè¿”å›500é”™è¯¯  
**å‘ç°æ—¶é—´**: 2026-02-16 12:01  
**å‘ç°æ–¹å¼**: å‰ç«¯æ—¥å¿—ç³»ç»Ÿè‡ªåŠ¨æ•è·  
**å½±å“èŒƒå›´**: 
- `/api/tenant/logistics_accounts` (GET) - è¿”å›500
- `/api/tenant/warehouses` (GET) - è¿”å›500

#### æ ¹å› åˆ†æ

**è¯Šæ–­è¿‡ç¨‹**:
1. å‰ç«¯æ—¥å¿—æ˜¾ç¤º: ç”¨æˆ·ç‚¹å‡»ç‰©æµæ¨¡å—åè§¦å‘500é”™è¯¯
2. Flaskè®¿é—®æ—¥å¿—ç¡®è®¤: `"GET /api/tenant/logistics_accounts HTTP/1.0" 500 -`
3. å°è¯•æ‰‹åŠ¨æµ‹è¯•APIå‘ç°æ•°æ®åº“è¿æ¥å¤±è´¥
4. æ£€æŸ¥æ•°æ®åº“é…ç½®å‘ç°å¯†ç é”™è¯¯

**æ ¹æœ¬åŸå› **:
- `tenant_logistics_api.py` ä¸­ `DB_CONFIG` ä½¿ç”¨äº†é”™è¯¯çš„æ•°æ®åº“è´¦å·
- `tenant_warehouse_api.py` ä¸­ `DB_CONFIG` ä½¿ç”¨äº†é”™è¯¯çš„æ•°æ®åº“è´¦å·
- é”™è¯¯é…ç½®: `user='root', password='123456'`
- æ­£ç¡®é…ç½®: `user='ajkuaiji', password='@HNzb5z75b16'`

#### ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**:
1. `/root/ajkuaiji/backend/tenant_logistics_api.py`
   ```python
   # ä¿®æ”¹å‰
   DB_CONFIG = {
       'host': 'localhost',
       'user': 'root',
       'password': '123456',
       'database': 'ajkuaiji',
       'charset': 'utf8mb4'
   }
   
   # ä¿®æ”¹å
   DB_CONFIG = {
       'host': 'localhost',
       'user': 'ajkuaiji',
       'password': '@HNzb5z75b16',
       'database': 'ajkuaiji',
       'charset': 'utf8mb4'
   }
   ```

2. `/root/ajkuaiji/backend/tenant_warehouse_api.py`
   ```python
   # åŒä¸Šä¿®æ”¹
   ```

**éªŒè¯ç»“æœ**:
```bash
# é‡å¯FlaskæœåŠ¡
sudo pkill -9 -f "python3_exec.*app.py"
cd /root/ajkuaiji/backend && nohup ./python3_exec app.py > /var/log/ajkuaiji-api-new.log 2>&1 &

# æµ‹è¯•API
curl -X GET "http://127.0.0.1:5000/api/tenant/logistics_accounts"
# è¿”å›: {"message":"æœªç™»å½•","success":false}  # HTTP 401 âœ…
# è¯´æ˜æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œæƒé™æ§åˆ¶ç”Ÿæ•ˆ
```

#### å½±å“åˆ†æ

**å½±å“åˆ†çº§**: ğŸ”´ **P0 - è‡´å‘½çº§**  
**å½±å“èŒƒå›´**:
- âœ… ä¸šåŠ¡ç«¯ç‰©æµè´¦å·ç®¡ç†é¡µé¢æ— æ³•åŠ è½½
- âœ… ä¸šåŠ¡ç«¯å‘è´§åœ°å€ç®¡ç†é¡µé¢æ— æ³•åŠ è½½
- âœ… è®¢å•å‘è´§æµç¨‹ä¸­ç‰©æµä¿¡æ¯åŒºæ— æ³•åŠ è½½
- âŒ ä¸å½±å“å…¶ä»–æ¨¡å—ï¼ˆè®¢å•ã€è´¢åŠ¡ã€å®¢æˆ·ç­‰ï¼‰

**ä¿®å¤åçŠ¶æ€**: âœ… **å·²è§£å†³**

#### ç»éªŒæ€»ç»“

**é˜²æ­¢å†å‘æªæ–½**:
1. âœ… æ‰€æœ‰æ–°å»ºçš„APIæ–‡ä»¶åº”ä» `app.py` ä¸­å¤åˆ¶ `DB_CONFIG` é…ç½®
2. âœ… ä»£ç å®¡æŸ¥æ—¶æ£€æŸ¥æ•°æ®åº“é…ç½®ä¸€è‡´æ€§
3. âœ… å‰ç«¯æ—¥å¿—ç³»ç»Ÿæœ‰æ•ˆæ•è·äº†è¯¥é—®é¢˜ï¼ˆè¯æ˜æ—¥å¿—ç³»ç»Ÿæœ‰æ•ˆï¼‰
4. âœ… å»ºè®®å°† `DB_CONFIG` æå–ä¸ºå…¨å±€é…ç½®æ¨¡å—ï¼Œé¿å…é‡å¤å®šä¹‰

**Gitæäº¤è®°å½•**:
```bash
Commit: 891bcb5
Message: fix: ä¿®å¤ç‰©æµæ¨¡å—API 500é”™è¯¯ - æ›´æ­£æ•°æ®åº“è¿æ¥é…ç½®
Date: 2026-02-16
Files: 
  - backend/tenant_logistics_api.py
  - backend/tenant_warehouse_api.py
```

---
