# 移动端问题排查与预防方案

## 一、本次问题总结

### 1.1 问题现象
- 移动端界面一直显示老版本
- API请求返回502 Bad Gateway错误
- 代码更新后不生效

### 1.2 根本原因
1. **Nginx配置文件不一致**
   - `/etc/nginx/sites-available/m.erp.xnamb.cn` 配置正确（端口8050）
   - `/etc/nginx/sites-enabled/m.erp.xnamb.cn` 配置错误（端口8051）
   - 原因：sites-enabled不是软链接，而是独立文件

2. **Flask服务端口**
   - Flask服务实际运行在8050端口
   - Nginx配置错误导致代理到8051端口（无服务）

3. **浏览器缓存**
   - 静态资源缓存策略导致更新不生效

### 1.3 解决方案
1. 修正Nginx配置文件端口（8051 → 8050）
2. 重新加载Nginx服务
3. 重新构建移动端项目
4. 清除浏览器缓存

---

## 二、全面检查计划

### Phase 1: 服务层检查（每次部署前必检）

#### 1.1 Flask服务状态
```bash
# 检查Flask进程
ps aux | grep flask

# 检查端口监听
netstat -tlnp | grep 8050

# 检查Flask服务响应
curl -I http://127.0.0.1:8050/api/health

# 查看Flask日志
tail -50 /root/ajkuaiji/backend/flask.log
```

**预期结果：**
- Flask进程正常运行
- 端口8050正常监听
- API返回200状态码

#### 1.2 Nginx配置检查
```bash
# 检查配置文件语法
nginx -t

# 检查配置文件一致性
diff /etc/nginx/sites-available/m.erp.xnamb.cn /etc/nginx/sites-enabled/m.erp.xnamb.cn

# 检查API代理配置
grep -n "proxy_pass" /etc/nginx/sites-enabled/m.erp.xnamb.cn

# 检查端口配置
grep -n "8050\|8051" /etc/nginx/sites-enabled/m.erp.xnamb.cn
```

**预期结果：**
- 配置文件语法正确
- sites-available与sites-enabled配置一致
- API代理指向正确端口（8050）

#### 1.3 API连通性测试
```bash
# 测试通过Nginx访问API
curl -X POST http://m.erp.xnamb.cn/api/mobile/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

# 查看Nginx错误日志
tail -50 /var/log/nginx/m.erp.xnamb.cn.error.log

# 查看Nginx访问日志
tail -50 /var/log/nginx/m.erp.xnamb.cn.access.log
```

**预期结果：**
- 返回JSON格式的业务响应（非502错误）
- Nginx日志无连接错误

---

### Phase 2: 构建与部署检查

#### 2.1 移动端项目构建
```bash
# 进入项目目录
cd /root/mobile-erp

# 检查环境变量配置
cat .env.production

# 清理旧构建产物
rm -rf dist

# 重新构建
npm run build

# 验证构建产物
ls -la dist/
ls -la dist/assets/
```

**预期结果：**
- 构建成功无错误
- dist目录包含最新文件
- assets目录包含CSS和JS文件

#### 2.2 静态资源部署
```bash
# 检查Nginx根目录配置
grep "root" /etc/nginx/sites-enabled/m.erp.xnamb.cn

# 验证静态文件路径
ls -la /root/mobile-erp/dist/index.html

# 检查文件权限
stat /root/mobile-erp/dist/index.html
```

**预期结果：**
- Nginx根目录指向正确路径
- 文件存在且可读

#### 2.3 缓存控制验证
```bash
# 检查index.html缓存策略
curl -I http://m.erp.xnamb.cn/

# 检查JS/CSS缓存策略
curl -I http://m.erp.xnamb.cn/assets/index-*.js

# 检查API缓存策略
curl -I http://m.erp.xnamb.cn/api/mobile/health
```

**预期结果：**
- HTML文件：`Cache-Control: no-cache`
- JS/CSS文件：`Cache-Control: public, max-age=...`
- API响应：`Cache-Control: no-store`

---

### Phase 3: 功能对标检查

#### 3.1 移动端功能清单
根据《开发规范统一手册.md》和PC端功能，移动端应实现：

**核心功能模块：**
- ✅ 用户认证（登录/登出）
- ✅ 客户管理（列表/搜索/详情）
- ✅ 订单管理（列表/搜索/详情）
- ✅ 统计分析（数据可视化）
- ✅ 个人中心（用户信息）

**移动端特性：**
- ✅ 底部Tab导航
- ✅ 下拉刷新
- ✅ 上拉加载更多
- ✅ 触摸优化
- ✅ 响应式布局

#### 3.2 功能验证流程
```bash
# 1. 登录功能测试
curl -X POST http://m.erp.xnamb.cn/api/mobile/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"YOUR_PASSWORD"}'

# 2. 客户列表测试
curl -X GET "http://m.erp.xnamb.cn/api/mobile/customers?page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 订单列表测试
curl -X GET "http://m.erp.xnamb.cn/api/mobile/orders?page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. 统计数据测试
curl -X GET "http://m.erp.xnamb.cn/api/mobile/statistics/overview" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 三、问题预防方案

### 3.1 配置文件管理规范

#### A. Nginx配置统一管理
```bash
# 1. 只维护sites-available中的配置
# 2. 使用软链接到sites-enabled
# 3. 禁止直接编辑sites-enabled中的文件

# 正确的配置方式：
# 创建软链接
ln -sf /etc/nginx/sites-available/m.erp.xnamb.cn /etc/nginx/sites-enabled/m.erp.xnamb.cn

# 修改配置后验证
nginx -t

# 重新加载Nginx
systemctl reload nginx
```

#### B. 端口配置集中管理
创建配置文件：`/root/ajkuaiji/config/ports.conf`
```bash
# 系统端口配置
FLASK_API_PORT=8050
MOBILE_DOMAIN=m.erp.xnamb.cn
PC_DOMAIN=erp.xnamb.cn

# 在部署脚本中使用
source /root/ajkuaiji/config/ports.conf
```

### 3.2 部署流程标准化

创建部署脚本：`/root/ajkuaiji/scripts/deploy-mobile.sh`
```bash
#!/bin/bash
set -e

echo "=== 移动端部署脚本 ==="

# 1. 检查Flask服务
echo "1. 检查Flask服务..."
if ! pgrep -f "flask.*8050" > /dev/null; then
    echo "错误：Flask服务未运行在8050端口"
    exit 1
fi

# 2. 检查Nginx配置
echo "2. 验证Nginx配置..."
nginx -t || exit 1

# 3. 构建移动端项目
echo "3. 构建移动端项目..."
cd /root/mobile-erp
rm -rf dist
npm run build

# 4. 重新加载Nginx
echo "4. 重新加载Nginx..."
systemctl reload nginx

# 5. 验证部署
echo "5. 验证部署..."
sleep 2
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://m.erp.xnamb.cn/)
if [ "$HTTP_CODE" = "200" ]; then
    echo "✅ 部署成功！"
else
    echo "❌ 部署失败，HTTP状态码：$HTTP_CODE"
    exit 1
fi

echo "=== 部署完成 ==="
```

### 3.3 监控与告警

#### A. 服务健康检查
创建监控脚本：`/root/ajkuaiji/scripts/health-check.sh`
```bash
#!/bin/bash

# Flask服务检查
if ! curl -sf http://127.0.0.1:8050/api/health > /dev/null; then
    echo "[ERROR] Flask服务异常"
    # 发送告警通知
fi

# Nginx服务检查
if ! systemctl is-active --quiet nginx; then
    echo "[ERROR] Nginx服务未运行"
    # 发送告警通知
fi

# API连通性检查
if ! curl -sf http://m.erp.xnamb.cn/api/health > /dev/null; then
    echo "[ERROR] 移动端API不可访问"
    # 发送告警通知
fi
```

#### B. 定时任务
```bash
# 添加到crontab
crontab -e

# 每5分钟执行一次健康检查
*/5 * * * * /root/ajkuaiji/scripts/health-check.sh >> /var/log/health-check.log 2>&1
```

### 3.4 日志管理规范

#### A. 日志收集
```bash
# Flask日志
/root/ajkuaiji/backend/flask.log

# Nginx访问日志
/var/log/nginx/m.erp.xnamb.cn.access.log

# Nginx错误日志
/var/log/nginx/m.erp.xnamb.cn.error.log

# 移动端错误日志（API上报）
/root/ajkuaiji/backend/mobile_errors.log
```

#### B. 日志轮转
创建日志轮转配置：`/etc/logrotate.d/mobile-erp`
```
/root/ajkuaiji/backend/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
```

### 3.5 开发流程规范

#### A. 代码提交前检查清单
- [ ] 本地测试通过
- [ ] API接口测试通过
- [ ] 移动端构建成功
- [ ] 浏览器测试（Chrome/Safari）
- [ ] 代码已提交到Git

#### B. 部署前检查清单
- [ ] Flask服务运行正常（端口8050）
- [ ] Nginx配置文件一致性检查
- [ ] 备份当前dist目录
- [ ] 执行部署脚本
- [ ] 验证功能正常

#### C. 部署后验证清单
- [ ] 主页访问正常
- [ ] 登录功能正常
- [ ] API接口响应正常
- [ ] 无502/504错误
- [ ] 浏览器控制台无错误

---

## 四、快速问题定位指南

### 4.1 502错误排查
```bash
# Step 1: 检查Flask服务
netstat -tlnp | grep 8050

# Step 2: 检查Nginx配置
grep "proxy_pass" /etc/nginx/sites-enabled/m.erp.xnamb.cn

# Step 3: 查看Nginx错误日志
tail -50 /var/log/nginx/m.erp.xnamb.cn.error.log

# Step 4: 测试直接访问Flask
curl -I http://127.0.0.1:8050/api/health
```

### 4.2 界面不更新排查
```bash
# Step 1: 检查构建时间
ls -la /root/mobile-erp/dist/index.html

# Step 2: 验证HTML缓存策略
curl -I http://m.erp.xnamb.cn/

# Step 3: 强制重新构建
cd /root/mobile-erp && rm -rf dist && npm run build

# Step 4: 清除浏览器缓存
# 浏览器按 Ctrl+Shift+R 或 Ctrl+F5
```

### 4.3 API返回异常排查
```bash
# Step 1: 查看Flask日志
tail -50 /root/ajkuaiji/backend/flask.log

# Step 2: 测试具体API端点
curl -X POST http://127.0.0.1:8050/api/mobile/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}' -v

# Step 3: 检查数据库连接
mysql -u ajkuaiji -p ajkuaiji -e "SELECT 1"

# Step 4: 查看Python依赖
pip list | grep -i flask
```

---

## 五、运维建议

### 5.1 定期维护任务
- **每日：** 检查服务状态和日志
- **每周：** 备份配置文件和数据库
- **每月：** 清理日志文件，检查磁盘空间

### 5.2 紧急恢复流程
```bash
# 1. 停止所有服务
systemctl stop nginx
pkill -f flask

# 2. 恢复配置文件
cp /root/ajkuaiji/backup/nginx/m.erp.xnamb.cn /etc/nginx/sites-enabled/

# 3. 恢复构建产物
cp -r /root/ajkuaiji/backup/mobile-erp/dist /root/mobile-erp/

# 4. 重启服务
cd /root/ajkuaiji/backend && nohup python app.py &
systemctl start nginx

# 5. 验证恢复
curl -I http://m.erp.xnamb.cn/
```

### 5.3 性能优化建议
1. **启用HTTP/2**
2. **配置CDN加速静态资源**
3. **优化Flask应用性能（Gunicorn多进程）**
4. **数据库查询优化**
5. **Redis缓存热点数据**

---

## 六、文档与培训

### 6.1 相关文档
- [开发规范统一手册](/root/ajkuaiji/docs/开发规范统一手册.md)
- [移动端Vue3项目开发规范](/root/ajkuaiji/docs/移动端Vue3项目开发规范.md)
- [移动端联调测试计划](/root/ajkuaiji/docs/移动端联调测试计划.md)

### 6.2 培训要点
1. Nginx配置管理规范
2. Flask应用部署流程
3. 移动端项目构建与发布
4. 问题排查与日志分析
5. 应急响应流程

---

## 七、总结

通过本次问题排查，我们建立了完整的移动端问题预防和处理机制：

1. **标准化部署流程** - 使用脚本自动化部署，减少人为错误
2. **配置文件管理** - 统一管理配置，确保一致性
3. **监控与告警** - 及时发现问题，快速响应
4. **日志管理** - 便于问题追溯和分析
5. **文档规范** - 沉淀经验，提高效率

**关键原则：**
- 任何配置修改都要有记录
- 部署前必须测试
- 问题发生后及时更新文档
- 定期检查和维护

---

最后更新：2026-02-21
维护人员：AI助手
